diff -Naur ./.svn/entries ../../../tmp/Transmission/libtransmission/.svn/entries
--- ./.svn/entries	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/entries	2012-07-09 13:11:37.000000000 +0200
@@ -1,14 +1,14 @@
 10
 
 dir
-13094
+13380
 svn://svn.transmissionbt.com/Transmission/trunk/libtransmission
 svn://svn.transmissionbt.com/Transmission
 
 
 
-2011-11-12T00:16:04.220620Z
-13084
+2012-07-01T04:00:27.737233Z
+13363
 jordan
 has-props
 
@@ -32,10 +32,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-2fdac3cfa8edf7fbd672d37212292d72
-2011-03-22T15:19:54.669054Z
-12204
+2012-07-09T11:11:37.000000Z
+4e3d08bfef4dee78c1544610e6951d5b
+2012-07-01T04:00:27.737233Z
+13363
 jordan
 has-props
 
@@ -58,7 +58,7 @@
 
 
 
-6394
+6437
 
 peer-io.c
 file
@@ -66,10 +66,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-9f9fc84908661f1acf98df155e44c77b
-2011-10-08T23:53:27.421088Z
-12954
+2012-07-09T11:11:37.000000Z
+332839b59e88db07809e2c2883bcfbcc
+2012-05-30T17:47:29.269572Z
+13329
 jordan
 has-props
 
@@ -92,7 +92,7 @@
 
 
 
-35155
+35180
 
 utils.c
 file
@@ -100,10 +100,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-8a6d92b3c0d892f0a620deb949abb685
-2011-11-10T03:31:43.242511Z
-13080
+2012-07-09T11:11:37.000000Z
+f2ab0dd85404d5adeba9c629e3ee633a
+2012-07-01T03:05:36.817034Z
+13362
 jordan
 has-props
 
@@ -126,7 +126,7 @@
 
 
 
-41221
+41745
 
 history.c
 file
@@ -134,7 +134,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 7f4941bc7047bc55bcc948f944e73475
 2011-04-06T23:27:11.111958Z
 12328
@@ -168,7 +168,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 75a45350404d9cfa9cde56f8b56609b7
 2011-03-22T15:19:54.669054Z
 12204
@@ -202,10 +202,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-8f826812147ac97902faca9a024cbdd7
-2011-09-26T22:50:42.460877Z
-12921
+2012-07-09T11:11:37.000000Z
+ff4b3ad3cfc12a7cf74db213ba85e688
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -228,7 +228,7 @@
 
 
 
-73217
+73268
 
 torrent.h
 file
@@ -236,10 +236,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-474cead45454ed80d560e21348402e82
-2011-08-03T23:40:51.974573Z
-12617
+2012-07-09T11:11:37.000000Z
+01c66bed198d2e7a7192008e1161c63c
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -262,7 +262,7 @@
 
 
 
-14720
+14738
 
 stats.h
 file
@@ -270,7 +270,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 30863d63fe7b55acacf159879ef2676b
 2011-01-19T13:48:47.518794Z
 11709
@@ -304,10 +304,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-76f03dff7489b0d13ef3f5873e8e0ef3
-2011-10-25T21:54:51.793164Z
-13034
+2012-07-09T11:11:37.000000Z
+d91855c485f3156f154d48e0b0ba7256
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -330,7 +330,7 @@
 
 
 
-11697
+11707
 
 peer-io.h
 file
@@ -338,7 +338,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 682b5b2cb3f1d21c7ac7ff80a2a27da4
 2011-04-17T05:22:50.756550Z
 12365
@@ -372,10 +372,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-6727cfc851d95aebbccfed921ed771b5
-2011-11-12T00:16:04.220620Z
-13084
+2012-07-09T11:11:37.000000Z
+e54fef22781a9caeffa9fc629c69707c
+2012-07-01T03:05:36.817034Z
+13362
 jordan
 has-props
 
@@ -398,7 +398,7 @@
 
 
 
-18886
+18949
 
 history.h
 file
@@ -406,7 +406,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 be5ac2d1345fa5802bd618c329eb38b2
 2011-04-06T23:27:11.111958Z
 12328
@@ -440,7 +440,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 6878f111d45584f9d1862931b4dad854
 2011-05-01T19:10:34.309173Z
 12411
@@ -474,7 +474,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 7ed06acad95ed2880d1be05ebe770647
 2011-06-19T18:34:10.617795Z
 12509
@@ -502,16 +502,16 @@
 
 9059
 
-history-test.c
+natpmp_local.h
 file
 
 
 
 
-2011-11-15T08:27:22.000000Z
-70ac65f50b38815fa4df19bbdb21eb96
-2011-04-06T23:27:11.111958Z
-12328
+2012-07-09T11:11:37.000000Z
+3749c09ad96d8b44300c860c2a49a270
+2012-02-04T01:28:15.182551Z
+13199
 jordan
 
 
@@ -534,7 +534,7 @@
 
 
 
-1361
+814
 
 peer-mgr.c
 file
@@ -542,10 +542,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-8a83b28188bcafffc115abc3a2e79912
-2011-10-08T23:53:27.421088Z
-12954
+2012-07-09T11:11:37.000000Z
+ac327f9b7979d3aa3943a7ed7da3bcdf
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -568,7 +568,41 @@
 
 
 
-118693
+121448
+
+history-test.c
+file
+
+
+
+
+2012-07-09T11:11:37.000000Z
+70ac65f50b38815fa4df19bbdb21eb96
+2011-04-06T23:27:11.111958Z
+12328
+jordan
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+
+1361
 
 peer-mgr.h
 file
@@ -576,10 +610,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-08c18ed6c8aff4c71dabd0d8b3315889
-2011-07-10T15:24:51.208445Z
-12539
+2012-07-09T11:11:37.000000Z
+1c2c0f791a9f013c46098f53d6a25996
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -602,7 +636,7 @@
 
 
 
-7780
+7807
 
 tr-getopt.c
 file
@@ -610,7 +644,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 1636af54d8563e586c7870a7080b35be
 2011-01-19T13:48:47.518794Z
 11709
@@ -644,7 +678,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 89a66100126b58fea7e3c738cbb8ea62
 2011-03-25T05:34:26.857517Z
 12229
@@ -678,10 +712,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-c1309ae7bfb606d3b89598ba23138019
-2011-10-14T00:27:14.616222Z
-12982
+2012-07-09T11:11:37.000000Z
+67711048cf888552eea9ea8155244602
+2012-05-22T20:21:00.592134Z
+13313
 jordan
 has-props
 
@@ -704,7 +738,7 @@
 
 
 
-53188
+53389
 
 tr-getopt.h
 file
@@ -712,7 +746,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 5b8acc992e72b6888c4c0e472cc51ff1
 2011-01-19T13:48:47.518794Z
 11709
@@ -746,7 +780,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 4747749c9e04045767b644949ed17dac
 2011-03-25T05:34:26.857517Z
 12229
@@ -780,7 +814,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 c412529d289cf882cb493d0c2c63b780
 2011-03-26T10:22:25.583417Z
 12237
@@ -814,10 +848,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-cdd582b7402b491012898b09221d6b71
-2011-05-27T23:28:40.968458Z
-12463
+2012-07-09T11:11:37.000000Z
+cdd83bf5cc951437ac10073924027c43
+2012-02-04T00:34:39.005432Z
+13198
 jordan
 has-props
 
@@ -840,7 +874,7 @@
 
 
 
-44948
+45339
 
 ConvertUTF.c
 file
@@ -848,7 +882,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 3efaecc3c7b9918e36973e5a1e57e928
 2010-12-27T19:18:17.768319Z
 11599
@@ -882,10 +916,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-5225bf48a6742af076fb3eb3651298fa
-2011-09-06T16:45:48.978069Z
-12848
+2012-07-09T11:11:37.000000Z
+3126ba1799c25da33c2b64ab120ca85d
+2012-05-20T14:47:18.714767Z
+13311
 jordan
 has-props
 
@@ -908,7 +942,7 @@
 
 
 
-18668
+18836
 
 bencode.h
 file
@@ -916,7 +950,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 2d6da34b2f95181fbcde56de2cae6084
 2011-04-27T21:22:08.054333Z
 12391
@@ -950,7 +984,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 4d2c4279b06fe4fb392edc8582cc321b
 2010-12-27T19:18:17.768319Z
 11599
@@ -984,7 +1018,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 1518161524df91f6f64a3493f342187f
 2011-07-31T14:04:43.694012Z
 12606
@@ -1018,7 +1052,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 c393c231daffe2b206927f0174971659
 2011-03-22T15:19:54.669054Z
 12204
@@ -1052,10 +1086,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-5ed010615c81bda8b1ce391857ee40ac
-2011-10-17T12:44:17.964639Z
-12990
+2012-07-09T11:11:37.000000Z
+456a47e078e3b0aad6495ad8ce38545c
+2012-07-01T01:42:58.877241Z
+13359
 jordan
 has-props
 
@@ -1086,7 +1120,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 dd3b48395b9d9fec90cb277e9a984488
 2011-03-22T15:19:54.669054Z
 12204
@@ -1120,7 +1154,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 8a355a7b74ddd362e87e91e0a91d20cd
 2011-03-22T15:19:54.669054Z
 12204
@@ -1154,7 +1188,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 3e0fc19435456fc904ce5e3ebdfce4f2
 2011-01-19T13:48:47.518794Z
 11709
@@ -1188,7 +1222,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 bf90e0ef224ffd645589a57681c80b94
 2011-09-25T21:51:50.765744Z
 12915
@@ -1222,7 +1256,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 dec3e573343979bdb773521f0705312e
 2011-04-05T00:59:49.150672Z
 12314
@@ -1256,7 +1290,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 39d087b6ea1866eff7a55edb428ccfa3
 2011-01-19T13:48:47.518794Z
 11709
@@ -1290,10 +1324,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-8b139362603b2d229acf7dac6fa8a8d6
-2011-10-14T00:27:14.616222Z
-12982
+2012-07-09T11:11:37.000000Z
+ddedcae32c34328830fa6a4c5d195fab
+2012-05-20T14:14:59.877229Z
+13310
 jordan
 has-props
 
@@ -1316,7 +1350,7 @@
 
 
 
-29525
+29538
 
 peer-msgs-test.c
 file
@@ -1324,7 +1358,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 88270b6587f5b0c3646c51babb34d7f1
 2011-03-25T06:20:12.675677Z
 12230
@@ -1358,7 +1392,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 70ac9fde761373d41d0ae5a13b3b50db
 2011-01-19T13:48:47.518794Z
 11709
@@ -1392,7 +1426,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 bde86441c755a3fd31f9051c2752be4d
 2011-01-19T13:48:47.518794Z
 11709
@@ -1426,10 +1460,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-4a6827c06c78dca68f90afba67c28744
-2011-03-25T01:41:57.030441Z
-12228
+2012-07-09T11:11:37.000000Z
+c51f76865b06cc8c737b8e5b36bc6187
+2012-02-04T01:28:15.182551Z
+13199
 jordan
 has-props
 
@@ -1452,7 +1486,7 @@
 
 
 
-5360
+5366
 
 peer-common.h
 file
@@ -1460,7 +1494,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 ee4236d8973e3f7f49134d9ba018d846
 2011-03-22T15:19:54.669054Z
 12204
@@ -1494,7 +1528,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 a7108ad1d8f4477b1ac00afc5c7c1a37
 2011-04-17T05:22:50.756550Z
 12365
@@ -1528,10 +1562,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-0ebbc4c0858ddfe746b576cce4e4d7b6
-2011-07-25T17:48:14.282774Z
-12582
+2012-07-09T11:11:37.000000Z
+fb8449a3bf92f4a7a1d46b6ffda0e3ce
+2011-12-14T05:42:15.548968Z
+13110
 jordan
 has-props
 
@@ -1554,7 +1588,7 @@
 
 
 
-18587
+18678
 
 port-forwarding.h
 file
@@ -1562,7 +1596,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 c602149c64ef18b7ac560551e32a7966
 2011-03-24T22:45:04.211905Z
 12224
@@ -1596,7 +1630,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 a007ab4fa183357b97fbf4f3388a7f4e
 2011-03-22T15:19:54.669054Z
 12204
@@ -1630,7 +1664,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 2a01eff1ee8c251aaaacba6ff0c03672
 2011-07-25T17:48:14.282774Z
 12582
@@ -1664,10 +1698,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-d4675b4420ca4db9c57de4735c56376b
-2011-03-24T22:57:39.843676Z
-12225
+2012-07-09T11:11:37.000000Z
+0f1bcc2fdb9e1068f9d694988b95c2f4
+2012-04-07T00:12:57.505729Z
+13263
 jordan
 has-props
 
@@ -1690,7 +1724,7 @@
 
 
 
-7094
+7096
 
 rpc-test.c
 file
@@ -1698,7 +1732,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 102f7b57344cecbadf633d21878265de
 2009-01-23T18:44:15.611877Z
 7783
@@ -1732,7 +1766,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 7a169c824b28b6ab454dd795d37d9a57
 2009-05-29T19:17:12.297015Z
 8561
@@ -1766,7 +1800,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 0b5609247f2979606a3dc16272e749ea
 2011-07-25T21:30:46.469796Z
 12587
@@ -1800,7 +1834,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 75b09cb49dabf1d8d6cbe1f2bbba81f2
 2011-03-25T05:34:26.857517Z
 12229
@@ -1834,7 +1868,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 77ac0f65e46d161ebcd79288ac243e0e
 2011-03-25T05:34:26.857517Z
 12229
@@ -1862,47 +1896,13 @@
 
 3496
 
-natpmp.h
-file
-
-
-
-
-2011-11-15T08:27:22.000000Z
-0ccb0e3f11fce2b34032dbad44dbbd69
-2011-03-22T15:19:54.669054Z
-12204
-jordan
-has-props
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-814
-
 torrent-magnet.c
 file
 
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 56287e4408dfd5463981e2450b04b9cb
 2011-07-25T22:30:56.494108Z
 12589
@@ -1936,7 +1936,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 b76a3ceb83f11cf46f1a2d3482142f90
 2011-03-22T15:19:54.669054Z
 12204
@@ -1970,7 +1970,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 4c5e395325a444de262514a42ade8741
 2011-03-22T15:19:54.669054Z
 12204
@@ -2004,7 +2004,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 99a59ad14ba3c5ea69a3e9dd018bbbce
 2011-03-22T15:19:54.669054Z
 12204
@@ -2038,10 +2038,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-7f82a4b3c6354ea8d33d9101e8c24eb7
-2011-07-22T17:47:08.888688Z
-12575
+2012-07-09T11:11:37.000000Z
+74ab4d12383756630d5177fc25963d32
+2012-05-30T17:47:29.269572Z
+13329
 jordan
 
 
@@ -2064,7 +2064,7 @@
 
 
 
-9513
+9538
 
 webseed.c
 file
@@ -2072,10 +2072,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-25707357a6ab474b3a03bf00c4258489
-2011-09-12T21:46:15.149914Z
-12860
+2012-07-09T11:11:37.000000Z
+151e3ce188c872d024d2749af7312c40
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -2098,7 +2098,7 @@
 
 
 
-18071
+18237
 
 tr-udp.h
 file
@@ -2106,7 +2106,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 5836a1232950fd62d366af8ccd20bab9
 2011-03-22T15:19:54.669054Z
 12204
@@ -2140,10 +2140,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-075ac7028dcda7d2837cd8c6c893fb6b
-2011-03-22T15:19:54.669054Z
-12204
+2012-07-09T11:11:37.000000Z
+ee9d3316f3374f32125105ab9363dc5b
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -2174,10 +2174,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-3fe56cf6f9d90fc4a9a6324e08d11f45
-2011-03-26T12:06:04.974284Z
-12238
+2012-07-09T11:11:37.000000Z
+fee77d24d9d8a6a4d3fe0ef0fa728801
+2012-05-20T14:14:59.877229Z
+13310
 jordan
 has-props
 
@@ -2200,7 +2200,7 @@
 
 
 
-6869
+6882
 
 platform.c
 file
@@ -2208,7 +2208,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 8e500dc572346cfc63adc75090e9f669
 2011-08-15T00:10:06.835145Z
 12684
@@ -2242,7 +2242,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 a0524a2427605822d8337f9ecaceca8a
 2011-03-25T01:41:57.030441Z
 12228
@@ -2276,7 +2276,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 760d812b8b3af607280989beaf0491fb
 2011-10-25T15:57:10.648856Z
 13029
@@ -2310,10 +2310,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-245445c30646ae0d87c3b5cbfc6158ec
-2011-10-08T23:53:27.421088Z
-12954
+2012-07-09T11:11:37.000000Z
+8acd8b238c4a46d3f6f0c33ca0817501
+2012-05-30T17:47:29.269572Z
+13329
 jordan
 
 
@@ -2336,7 +2336,7 @@
 
 
 
-5712
+5737
 
 trevent.h
 file
@@ -2344,7 +2344,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 98525ac877c9b5cbf9fdd1cca31cac2a
 2011-03-25T06:20:12.675677Z
 12230
@@ -2378,7 +2378,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 ccfff4ec3e39c6becab53f7a5d4cfbee
 2011-07-25T17:48:14.282774Z
 12582
@@ -2412,11 +2412,11 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-3b1819a5b80982b98ccb50c99c61b806
-2011-08-27T23:54:10.452302Z
-12772
-livings124
+2012-07-09T11:11:37.000000Z
+32252ba620d5a22fa271fd9dfb36b205
+2012-07-01T02:17:35.661037Z
+13361
+jordan
 has-props
 
 
@@ -2438,7 +2438,7 @@
 
 
 
-72829
+72880
 
 resume.c
 file
@@ -2446,7 +2446,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 9e6fa3d7a829638417a6820645df972d
 2011-09-26T22:50:42.460877Z
 12921
@@ -2480,10 +2480,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-989731093066e09b08f7116b36295f45
-2011-10-08T23:53:27.421088Z
-12954
+2012-07-09T11:11:37.000000Z
+eac9c65fe48a0b2a87c2390f9b51bbfc
+2012-05-30T17:47:29.269572Z
+13329
 jordan
 
 
@@ -2506,7 +2506,7 @@
 
 
 
-1663
+1567
 
 clients.c
 file
@@ -2514,10 +2514,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-97ad5c7f8ba3259c4d6288837da71775
-2011-06-16T12:08:52.264217Z
-12502
+2012-07-09T11:11:37.000000Z
+9f680a7b9fd81c9bb8e094ca0af415de
+2011-11-22T03:30:37.563381Z
+13099
 livings124
 has-props
 
@@ -2540,7 +2540,7 @@
 
 
 
-18641
+19509
 
 test-peer-id.c
 file
@@ -2548,7 +2548,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 f23b550f1d431f2dad425f57386f6b39
 2011-03-10T12:35:23.250148Z
 12121
@@ -2582,7 +2582,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 9a88b5a8d65226387e871b68717a51ce
 2011-03-25T17:42:47.640307Z
 12234
@@ -2616,7 +2616,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 dd8472df283c416b669865f06aeb4c2a
 2011-07-13T03:23:37.535856Z
 12545
@@ -2650,7 +2650,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 4f61495aad8b98619d775abeb7e08ccf
 2011-08-08T16:58:29.160460Z
 12653
@@ -2684,10 +2684,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-badd6fc0903c1d0f7acee98cd4b3ba39
-2011-10-14T00:27:14.616222Z
-12982
+2012-07-09T11:11:37.000000Z
+00278df59e0965ab955f35e218d1cf60
+2012-05-20T14:14:59.877229Z
+13310
 jordan
 has-props
 
@@ -2710,7 +2710,7 @@
 
 
 
-15887
+15743
 
 resume.h
 file
@@ -2718,7 +2718,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 72459a3b1af8e1899eec0c24c9fb17d1
 2011-01-19T13:48:47.518794Z
 11709
@@ -2752,7 +2752,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 f2b0f7f761d5fefd69c14815e9cca7d8
 2011-01-19T13:48:47.518794Z
 11709
@@ -2786,7 +2786,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 01172b8d83824e486560b2a5870cdf76
 2011-01-29T18:56:53.624656Z
 11782
@@ -2820,7 +2820,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 ac9d8d0d7356c3a83fb7af2dcc03fbdd
 2011-04-01T03:07:43.093392Z
 12289
@@ -2854,10 +2854,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-aab0ce0b5bd8bef2e5c32417976c88c1
-2011-09-26T06:18:48.397990Z
-12918
+2012-07-09T11:11:37.000000Z
+ad00d7ce1d9bfaf0e6781fa484e8c02d
+2011-12-22T19:35:13.399513Z
+13113
 jordan
 has-props
 
@@ -2880,7 +2880,7 @@
 
 
 
-8724
+8478
 
 bencode-test.c
 file
@@ -2888,10 +2888,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-184142112dfab2248aeb39c5d6530eec
-2011-04-27T21:22:08.054333Z
-12391
+2012-07-09T11:11:37.000000Z
+64a7b52d618bca3942c5a7c5754c1ed5
+2011-12-14T05:44:15.747214Z
+13111
 jordan
 has-props
 
@@ -2914,7 +2914,7 @@
 
 
 
-15454
+15436
 
 utils-test.c
 file
@@ -2922,7 +2922,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 d91edfc840d1910f523093e9817c8124
 2011-04-05T22:21:18.466613Z
 12324
@@ -2956,10 +2956,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-d59b59212c5027c8642337a1ca86ffb2
-2011-07-10T15:24:51.208445Z
-12539
+2012-07-09T11:11:37.000000Z
+e1567c43ebbc9f0dfe34f98371cc6a12
+2012-03-04T13:21:42.735450Z
+13245
 jordan
 has-props
 
@@ -2982,7 +2982,7 @@
 
 
 
-17018
+17905
 
 json.h
 file
@@ -2990,7 +2990,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 4e7c526129d8df2b52380301152ecd29
 2011-01-19T13:48:47.518794Z
 11709
@@ -3024,7 +3024,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 52f70efae023c2c819b394192290c8fe
 2011-03-24T21:49:42.822908Z
 12223
@@ -3058,10 +3058,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-db35961be7560cbff273a6dee33c8c32
-2011-09-26T06:18:48.397990Z
-12918
+2012-07-09T11:11:37.000000Z
+aa747527eac058b8b4d9e9771ae4d7a4
+2012-05-20T14:14:59.877229Z
+13310
 jordan
 has-props
 
@@ -3084,7 +3084,7 @@
 
 
 
-3739
+3599
 
 crypto.c
 file
@@ -3092,7 +3092,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 77ed9b1552a75ecd6ef6103b8e281fd9
 2011-09-16T22:55:58.143184Z
 12885
@@ -3126,7 +3126,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 06fc40c4449b2a39f45be61ecd33ec79
 2011-09-28T16:07:35.175691Z
 12932
@@ -3160,7 +3160,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 258303f3327ef63a2c624616858294bb
 2011-10-09T14:51:13.974182Z
 12958
@@ -3194,7 +3194,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 1dd5ed34da3a8380fcdfa8b60e710e51
 2011-07-10T15:24:51.208445Z
 12539
@@ -3228,10 +3228,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-fe034fbdd3adbcb5d115308030bb86ab
-2011-08-08T16:29:47.714029Z
-12649
+2012-07-09T11:11:37.000000Z
+1a629c293269c7205b421d7b88f22de6
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -3254,7 +3254,7 @@
 
 
 
-79252
+79340
 
 makemeta.c
 file
@@ -3262,7 +3262,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 73a7056a935b40c86ec79a15ee46364e
 2011-07-24T20:18:33.631478Z
 12581
@@ -3296,7 +3296,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 8ff965efc95843404dd95638d9b8b8f1
 2011-03-24T21:49:42.822908Z
 12223
@@ -3330,7 +3330,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 9d9f3e6265eab3b9ef7d3cddc8ac95fc
 2011-04-17T05:22:50.756550Z
 12365
@@ -3364,10 +3364,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-b4853b81e89e18907ab51fe3c1964c3b
-2011-10-08T23:53:27.421088Z
-12954
+2012-07-09T11:11:37.000000Z
+b8f81a65d080ed1c196ee5c34e90d94e
+2012-05-30T17:47:29.269572Z
+13329
 jordan
 has-props
 
@@ -3390,7 +3390,7 @@
 
 
 
-18556
+18581
 
 json-test.c
 file
@@ -3398,7 +3398,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 264ac8d8e2c8a688a9d915265ebcbb73
 2010-04-15T19:27:47.309611Z
 10487
@@ -3432,7 +3432,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 34e41000344e3a3bc1bd37fdbc3ca614
 2011-09-26T22:50:42.460877Z
 12921
@@ -3466,7 +3466,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 40647691a67207d3d1f9e6b809064625
 2011-01-19T13:48:47.518794Z
 11709
@@ -3500,7 +3500,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 80500da4a1436f790de8eab153a5e4ca
 2009-11-29T17:49:58.643028Z
 9630
@@ -3534,10 +3534,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-54a6ccd1ff09d5b02834768b3c732958
-2011-10-09T02:05:52.894699Z
-12957
+2012-07-09T11:11:37.000000Z
+f05e0ea54b8c226697afda60d0c5418f
+2012-02-04T01:28:15.182551Z
+13199
 jordan
 
 
@@ -3560,7 +3560,7 @@
 
 
 
-3722
+3675
 
 rpc-server.c
 file
@@ -3568,11 +3568,11 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-7725fc7b86bf79900a25b2251f29b5c3
-2011-09-27T22:34:52.475604Z
-12930
-livings124
+2012-07-09T11:11:37.000000Z
+6d18c674c0ad0504e9654c84cbdbf4a8
+2012-02-15T01:44:21.476797Z
+13226
+jordan
 has-props
 
 
@@ -3594,7 +3594,7 @@
 
 
 
-30423
+30441
 
 session.h
 file
@@ -3602,10 +3602,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-15ef478484e50ab3aa87bed380ae9466
-2011-08-07T19:24:33.958969Z
-12640
+2012-07-09T11:11:37.000000Z
+688e923b72455aa36c5250292f150886
+2012-07-01T02:17:35.661037Z
+13361
 jordan
 has-props
 
@@ -3628,7 +3628,7 @@
 
 
 
-9904
+9956
 
 makemeta.h
 file
@@ -3636,7 +3636,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 14ed3e7b7dc3a7ec70e807abd74a696f
 2011-01-19T13:48:47.518794Z
 11709
@@ -3670,7 +3670,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 45ce41fcfdba4f1decc7607a8738f380
 2010-12-27T19:18:17.768319Z
 11599
@@ -3704,7 +3704,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 555ea8eacc79bff586a7984779fe45b5
 2011-03-25T05:34:26.857517Z
 12229
@@ -3738,7 +3738,7 @@
 
 
 
-2011-11-15T08:27:22.000000Z
+2012-07-09T11:11:37.000000Z
 12617db66e49c904a834156017e510c1
 2011-03-22T15:19:54.669054Z
 12204
@@ -3772,10 +3772,10 @@
 
 
 
-2011-11-15T08:27:22.000000Z
-e482aebb87c4696435ce833bca10dd3a
-2011-11-10T03:31:43.242511Z
-13080
+2012-07-09T11:11:37.000000Z
+4fbb7eebc30d525279373188a8e76139
+2012-07-01T03:05:36.817034Z
+13362
 jordan
 has-props
 
@@ -3798,5 +3798,5 @@
 
 
 
-89284
+88891
 
diff -Naur ./.svn/prop-base/natpmp.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/prop-base/natpmp.h.svn-base
--- ./.svn/prop-base/natpmp.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/prop-base/natpmp.h.svn-base	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-K 12
-svn:keywords
-V 18
-Date Rev Author Id
-END
diff -Naur ./.svn/text-base/Makefile.am.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/Makefile.am.svn-base
--- ./.svn/text-base/Makefile.am.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/Makefile.am.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -1,7 +1,5 @@
 AM_CPPFLAGS = \
-    -I. \
     -I$(top_srcdir) \
-    -I$(top_srcdir)/third-party/ \
     -D__TRANSMISSION__ \
     -DPACKAGE_DATA_DIR=\""$(datadir)"\"
 
@@ -9,6 +7,7 @@
     @DHT_CFLAGS@ \
     @LIBUTP_CFLAGS@ \
     @LIBUPNP_CFLAGS@ \
+    @LIBNATPMP_CFLAGS@ \
     @LIBEVENT_CFLAGS@ \
     @LIBCURL_CFLAGS@ \
     @OPENSSL_CFLAGS@ \
@@ -91,7 +90,7 @@
     magnet.h \
     makemeta.h \
     metainfo.h \
-    natpmp.h \
+    natpmp_local.h \
     net.h \
     peer-common.h \
     peer-io.h \
@@ -141,7 +140,7 @@
 apps_ldadd = \
     ./libtransmission.a  \
     @LIBUPNP_LIBS@ \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
+    @LIBNATPMP_LIBS@ \
     @INTLLIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
diff -Naur ./.svn/text-base/announcer-common.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-common.h.svn-base
--- ./.svn/text-base/announcer-common.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-common.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -148,7 +148,7 @@
     uint64_t corrupt;
 
     /* the total size of the torrent minus the number of bytes completed */
-    uint64_t left;
+    uint64_t leftUntilComplete;
 
     /* the tracker's announce URL */
     char * url;
diff -Naur ./.svn/text-base/announcer-http.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-http.c.svn-base
--- ./.svn/text-base/announcer-http.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-http.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -50,7 +50,7 @@
     return tr_announce_event_get_string( req->event );
 }
 
-static struct evbuffer *
+static char*
 announce_url_new( const tr_session * session, const tr_announce_request * req )
 {
     const char * str;
@@ -81,7 +81,7 @@
                               req->port,
                               req->up,
                               req->down,
-                              req->left,
+                              req->leftUntilComplete,
                               req->numwant,
                               req->key );
 
@@ -116,7 +116,7 @@
         tr_http_escape( buf, ipv6_readable, -1, true );
     }
 
-    return buf;
+    return evbuffer_free_to_str( buf );
 }
 
 static tr_pex*
@@ -287,8 +287,7 @@
                           void                       * response_func_user_data )
 {
     struct announce_data * d;
-    struct evbuffer * buf = announce_url_new( session, request );
-    const char * url = (const char *) evbuffer_pullup( buf, -1 );
+    char * url = announce_url_new( session, request );
 
     d = tr_new0( struct announce_data, 1 );
     d->response.seeders = -1;
@@ -302,7 +301,7 @@
     dbgmsg( request->log_name, "Sending announce to libcurl: \"%s\"", url );
     tr_webRun( session, url, NULL, NULL, on_announce_done, d );
 
-    evbuffer_free( buf );
+    tr_free( url );
 }
 
 /****
@@ -363,7 +362,7 @@
         tr_benc * flags;
         const char * str;
         const int benc_loaded = !tr_bencLoad( msg, msglen, &top, NULL );
-        
+
         if( getenv( "TR_CURL_VERBOSE" ) != NULL )
         {
             if( !benc_loaded )
@@ -378,7 +377,7 @@
                 tr_free( str );
             }
         }
-        
+
         if( benc_loaded )
         {
             if( tr_bencDictFindStr( &top, "failure reason", &str ) )
@@ -429,7 +428,7 @@
     tr_runInEventThread( session, on_scrape_done_eventthread, data );
 }
 
-static struct evbuffer *
+static char *
 scrape_url_new( const tr_scrape_request * req )
 {
     int i;
@@ -446,7 +445,7 @@
         delimiter = '&';
     }
 
-    return buf;
+    return evbuffer_free_to_str( buf );
 }
 
 void
@@ -457,8 +456,7 @@
 {
     int i;
     struct scrape_data * d;
-    struct evbuffer * buf = scrape_url_new( request );
-    const char * url = (const char *) evbuffer_pullup( buf, -1 );
+    char * url = scrape_url_new( request );
 
     d = tr_new0( struct scrape_data, 1 );
     d->response.url = tr_strdup( request->url );
@@ -477,5 +475,5 @@
     dbgmsg( request->log_name, "Sending scrape to libcurl: \"%s\"", url );
     tr_webRun( session, url, NULL, NULL, on_scrape_done, d );
 
-    evbuffer_free( buf );
+    tr_free( url );
 }
diff -Naur ./.svn/text-base/announcer-udp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-udp.c.svn-base
--- ./.svn/text-base/announcer-udp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-udp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -323,7 +323,7 @@
     evbuffer_add        ( buf, in->info_hash, SHA_DIGEST_LENGTH );
     evbuffer_add        ( buf, in->peer_id, PEER_ID_LEN );
     evbuffer_add_hton_64( buf, in->down );
-    evbuffer_add_hton_64( buf, in->left );
+    evbuffer_add_hton_64( buf, in->leftUntilComplete );
     evbuffer_add_hton_64( buf, in->up );
     evbuffer_add_hton_32( buf, get_tau_announce_event( in->event ) );
     evbuffer_add_hton_32( buf, 0 );
diff -Naur ./.svn/text-base/announcer.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer.c.svn-base
--- ./.svn/text-base/announcer.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -753,6 +753,7 @@
     {
         int i;
         char name[128];
+        char * message;
         struct evbuffer * buf = evbuffer_new( );
 
         tier_build_log_name( tier, name, sizeof( name ) );
@@ -763,8 +764,9 @@
             evbuffer_add_printf( buf, "[%d:%s]", i, str );
         }
 
-        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", evbuffer_pullup( buf, -1 ) );
-        evbuffer_free( buf );
+        message = evbuffer_free_to_str( buf );
+        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", message );
+        tr_free( message );
     }
 }
 
@@ -910,7 +912,9 @@
     req->up = tier->byteCounts[TR_ANN_UP];
     req->down = tier->byteCounts[TR_ANN_DOWN];
     req->corrupt = tier->byteCounts[TR_ANN_CORRUPT];
-    req->left = tr_cpLeftUntilComplete( &tor->completion ),
+    req->leftUntilComplete = tr_torrentHasMetadata( tor )
+            ? tor->info.totalSize - tr_cpHaveTotal( &tor->completion )
+            : ~(uint64_t)0;
     req->event = event;
     req->numwant = event == TR_ANNOUNCE_EVENT_STOPPED ? 0 : NUMWANT;
     req->key = announcer->key;
@@ -1139,7 +1143,7 @@
 
             /* if the tracker included scrape fields in its announce response,
                then a separate scrape isn't needed */
-            if( scrape_fields >= 3 )
+            if( ( scrape_fields >= 3 ) || ( !tracker->scrape && ( scrape_fields >= 1 ) ) )
             {
                 tr_tordbg( tier->tor, "Announce response contained scrape info; "
                                       "rescheduling next scrape to %d seconds from now.",
diff -Naur ./.svn/text-base/bandwidth.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/bandwidth.c.svn-base
--- ./.svn/text-base/bandwidth.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/bandwidth.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -174,8 +174,8 @@
     /* set the available bandwidth */
     if( b->band[dir].isLimited )
     {
-        const unsigned int nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
-        b->band[dir].bytesLeft = ( nextPulseSpeed * period_msec ) / 1000u;
+        const uint64_t nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
+        b->band[dir].bytesLeft = (unsigned int)( nextPulseSpeed * period_msec ) / 1000u;
     }
 
     /* add this bandwidth's peer, if any, to the peer pool */
diff -Naur ./.svn/text-base/bencode-test.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode-test.c.svn-base
--- ./.svn/text-base/bencode-test.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode-test.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -319,8 +319,8 @@
                  const char * expected )
 {
     tr_benc top;
-    struct evbuffer * buf = evbuffer_new( );
     char * serialized;
+    struct evbuffer * buf;
 
     tr_bencLoad( benc_str, strlen( benc_str ), &top, NULL );
     buf = tr_bencToBuf( &top, TR_FMT_JSON );
diff -Naur ./.svn/text-base/bencode.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode.c.svn-base
--- ./.svn/text-base/bencode.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -1593,6 +1593,16 @@
                     tr_bencListCopy( tr_bencDictAddList( target, key, tr_bencListSize( val ) ), val );
                 }
             }
+            else if( tr_bencIsDict( val ) )
+            {
+                tr_benc * target_dict = tr_bencDictFind( target, key );
+
+                if( target_dict == NULL )
+                    target_dict = tr_bencDictAddDict( target, key, tr_bencDictSize( val ) );
+
+                if( tr_bencIsDict( target_dict ) )
+                    tr_bencMergeDicts( target_dict, val );
+            }
             else
             {
                 tr_dbg( "tr_bencMergeDicts skipping \"%s\"", key );
diff -Naur ./.svn/text-base/clients.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/clients.c.svn-base
--- ./.svn/text-base/clients.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/clients.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -304,6 +304,29 @@
             return;
     }
 
+    /* uTorrent will replace the trailing dash with an extra digit for longer version numbers */
+    if( id[0] == '-' )
+    {
+        if( !memcmp( id+1, "UT", 2 ) )
+        {
+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent %d.%d.%d%s",
+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
+        }
+        else if( !memcmp( id+1, "UM", 2 ) )
+        {
+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Mac %d.%d.%d%s",
+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
+        }
+        else if( !memcmp( id+1, "UE", 2 ) )
+        {
+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Embedded %d.%d.%d%s",
+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
+        }
+
+        if( *buf )
+            return;
+    }
+
     /* Mainline */
     if( isMainlineStyle( id ) )
     {
diff -Naur ./.svn/text-base/completion.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.c.svn-base
--- ./.svn/text-base/completion.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -165,19 +165,13 @@
                 }
                 else
                 {
-                    uint64_t o = 0;
-                    tr_block_index_t b, f, l;
+                    tr_block_index_t f, l;
                     tr_torGetPieceBlockRange( cp->tor, p, &f, &l );
-                    for( b=f; b<=l; ++b )
-                        if( tr_cpBlockIsComplete( cp, b ) )
-                            n += tr_torBlockCountBytes( tor, b );
 
-                    o = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
-                    o *= cp->tor->blockSize;
+                    n = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
+                    n *= cp->tor->blockSize;
                     if( l == ( cp->tor->blockCount - 1 )  && tr_bitfieldHas( &cp->blockBitfield, l ) )
-                        o -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
-
-                    assert( n == o );
+                        n -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
                 }
 
                 assert( n <= tr_torPieceCountBytes( tor, p ) );
diff -Naur ./.svn/text-base/completion.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.h.svn-base
--- ./.svn/text-base/completion.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -89,12 +89,6 @@
     return cp->sizeNow;
 }
 
-static inline uint64_t
-tr_cpLeftUntilComplete( const tr_completion * cp )
-{
-    return tr_torrentInfo(cp->tor)->totalSize - cp->sizeNow;
-}
-
 static inline bool tr_cpHasAll( const tr_completion * cp )
 {
     return tr_bitfieldHasAll( &cp->blockBitfield );
diff -Naur ./.svn/text-base/fdlimit.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/fdlimit.c.svn-base
--- ./.svn/text-base/fdlimit.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/fdlimit.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -478,19 +478,25 @@
 static struct tr_cached_file *
 fileset_get_empty_slot( struct tr_fileset * set )
 {
-    struct tr_cached_file * o;
-    struct tr_cached_file * cull;
+    struct tr_cached_file * cull = NULL;
+
+    if( set->begin != NULL )
+    {
+        struct tr_cached_file * o;
+
+        /* try to find an unused slot */
+        for( o=set->begin; o!=set->end; ++o )
+            if( !cached_file_is_open( o ) )
+                return o;
+
+        /* all slots are full... recycle the least recently used */
+        for( cull=NULL, o=set->begin; o!=set->end; ++o )
+            if( !cull || o->used_at < cull->used_at )
+                cull = o;
+
+        cached_file_close( cull );
+    }
 
-    /* try to find an unused slot */
-    for( o=set->begin; o!=set->end; ++o )
-        if( !cached_file_is_open( o ) )
-            return o;
-
-    /* all slots are full... recycle the least recently used */
-    for( cull=NULL, o=set->begin; o!=set->end; ++o )
-        if( !cull || o->used_at < cull->used_at )
-            cull = o;
-    cached_file_close( cull );
     return cull;
 }
 
diff -Naur ./.svn/text-base/metainfo.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/metainfo.c.svn-base
--- ./.svn/text-base/metainfo.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/metainfo.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -268,6 +268,11 @@
         *walk++ = '\0';
         assert( walk - scrape == (int)alloc_len );
     }
+    /* Some torrents with UDP annouce URLs don't have /announce. */
+    else if ( !strncmp( announce, "udp:", 4 ) )
+    {
+        scrape = tr_strdup( announce );
+    }
 
     return scrape;
 }
diff -Naur ./.svn/text-base/natpmp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.c.svn-base
--- ./.svn/text-base/natpmp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -17,10 +17,10 @@
 #include <event2/util.h> /* evutil_inet_ntop() */
 
 #define ENABLE_STRNATPMPERR
-#include <libnatpmp/natpmp.h>
+#include "natpmp.h"
 
 #include "transmission.h"
-#include "natpmp.h"
+#include "natpmp_local.h"
 #include "net.h" /* tr_netCloseSocket */
 #include "port-forwarding.h"
 #include "utils.h"
@@ -120,7 +120,7 @@
 
     if( is_enabled && ( nat->state == TR_NATPMP_DISCOVER ) )
     {
-        int val = initnatpmp( &nat->natpmp );
+        int val = initnatpmp( &nat->natpmp, 0, 0 );
         logVal( "initnatpmp", val );
         val = sendpublicaddressrequest( &nat->natpmp );
         logVal( "sendpublicaddressrequest", val );
diff -Naur ./.svn/text-base/natpmp.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.h.svn-base
--- ./.svn/text-base/natpmp.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.h.svn-base	1970-01-01 01:00:00.000000000 +0100
@@ -1,34 +0,0 @@
-/*
- * This file Copyright (C) Mnemosyne LLC
- *
- * This file is licensed by the GPL version 2. Works owned by the
- * Transmission project are granted a special exemption to clause 2(b)
- * so that the bulk of its code can remain under the MIT license.
- * This exemption does not extend to derived works not owned by
- * the Transmission project.
- *
- * $Id$
- */
-
-#ifndef __TRANSMISSION__
-#error only libtransmission should #include this header.
-#endif
-
-#ifndef TR_NATPMP_H
-#define TR_NATPMP_H 1
-
-/**
- * @addtogroup port_forwarding Port Forwarding
- * @{
- */
-
-typedef struct tr_natpmp tr_natpmp;
-
-tr_natpmp * tr_natpmpInit( void );
-
-void tr_natpmpClose( tr_natpmp * );
-
-int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
-
-/* @} */
-#endif
diff -Naur ./.svn/text-base/natpmp_local.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp_local.h.svn-base
--- ./.svn/text-base/natpmp_local.h.svn-base	1970-01-01 01:00:00.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp_local.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -0,0 +1,34 @@
+/*
+ * This file Copyright (C) Mnemosyne LLC
+ *
+ * This file is licensed by the GPL version 2. Works owned by the
+ * Transmission project are granted a special exemption to clause 2(b)
+ * so that the bulk of its code can remain under the MIT license.
+ * This exemption does not extend to derived works not owned by
+ * the Transmission project.
+ *
+ * $Id: natpmp.h 12204 2011-03-22 15:19:54Z jordan $
+ */
+
+#ifndef __TRANSMISSION__
+#error only libtransmission should #include this header.
+#endif
+
+#ifndef TR_NATPMP_H
+#define TR_NATPMP_H 1
+
+/**
+ * @addtogroup port_forwarding Port Forwarding
+ * @{
+ */
+
+typedef struct tr_natpmp tr_natpmp;
+
+tr_natpmp * tr_natpmpInit( void );
+
+void tr_natpmpClose( tr_natpmp * );
+
+int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
+
+/* @} */
+#endif
diff -Naur ./.svn/text-base/net.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/net.c.svn-base
--- ./.svn/text-base/net.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/net.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -38,6 +38,8 @@
 
 #include <event2/util.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "fdlimit.h" /* tr_fdSocketClose() */
 #include "net.h"
diff -Naur ./.svn/text-base/peer-io.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-io.c.svn-base
--- ./.svn/text-base/peer-io.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-io.c.svn-base	2012-07-09 13:11:36.000000000 +0200
@@ -18,6 +18,8 @@
 #include <event2/buffer.h>
 #include <event2/bufferevent.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "session.h"
 #include "bandwidth.h"
diff -Naur ./.svn/text-base/peer-mgr.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.c.svn-base
--- ./.svn/text-base/peer-mgr.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -18,6 +18,8 @@
 
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "announcer.h"
 #include "bandwidth.h"
@@ -2492,11 +2494,21 @@
         const float true_count = tr_bitfieldCountTrueBits( have );
 
         if( tr_torrentHasMetadata( tor ) )
+        {
             peer->progress = true_count / tor->info.pieceCount;
+        }
         else /* without pieceCount, this result is only a best guess... */
+        {
             peer->progress = true_count / ( have->bit_count + 1 );
+        }
     }
 
+    /* clamp the progress range */
+    if ( peer->progress < 0.0 )
+        peer->progress = 0.0;
+    if ( peer->progress > 1.0 )
+        peer->progress = 1.0;
+
     if( peer->atom && ( peer->progress >= 1.0 ) )
         atomSetSeed( tor->torrentPeers, peer->atom );
 }
@@ -2664,7 +2676,7 @@
     assert( webseedCount == tor->info.webseedCount );
 
     for( i=0; i<webseedCount; ++i ) {
-        int Bps;
+        unsigned int Bps;
         if( tr_webseedGetSpeed_Bps( webseeds[i], now, &Bps ) )
             ret[i] = Bps / (double)tr_speed_K;
         else
@@ -2674,7 +2686,7 @@
     return ret;
 }
 
-int
+unsigned int
 tr_peerGetPieceSpeed_Bps( const tr_peer * peer, uint64_t now, tr_direction direction )
 {
     return peer->io ? tr_peerIoGetPieceSpeed_Bps( peer->io, now, direction ) : 0.0;
@@ -3011,7 +3023,7 @@
 static int
 getRate( const tr_torrent * tor, struct peer_atom * atom, uint64_t now )
 {
-    int Bps;
+    unsigned int Bps;
 
     if( tr_torrentIsSeed( tor ) )
         Bps = tr_peerGetPieceSpeed_Bps( atom->peer, now, TR_CLIENT_TO_PEER );
@@ -3037,8 +3049,8 @@
     if( !tr_bandwidthIsLimited( b, dir ) )
         return false;
     else {
-        const int got = tr_bandwidthGetPieceSpeed_Bps( b, now_msec, dir );
-        const int want = tr_bandwidthGetDesiredSpeed_Bps( b, dir );
+        const unsigned int got = tr_bandwidthGetPieceSpeed_Bps( b, now_msec, dir );
+        const unsigned int want = tr_bandwidthGetDesiredSpeed_Bps( b, dir );
         return got >= want;
     }
 }
@@ -3832,22 +3844,105 @@
     return score;
 }
 
-/* sort an array of peer candidates */
+#ifndef NDEBUG
 static int
-comparePeerCandidates( const void * va, const void * vb )
+checkPartition( const struct peer_candidate * candidates, int left, int right, uint64_t pivotScore, int storeIndex )
 {
-    const struct peer_candidate * a = va;
-    const struct peer_candidate * b = vb;
+    int i;
 
-    if( a->score < b->score ) return -1;
-    if( a->score > b->score ) return 1;
+    assert( storeIndex >= left );
+    assert( storeIndex <= right );
+    assert( candidates[storeIndex].score == pivotScore );
+
+    for( i=left; i<storeIndex; ++i )
+        assert( candidates[i].score < pivotScore );
+    for( i=storeIndex+1; i<=right; ++i )
+        assert( candidates[i].score >= pivotScore );
 
-    return 0;
+    return true;
 }
+#endif
+
+/* Helper to selectBestCandidates().
+ * Adapted from http://en.wikipedia.org/wiki/Selection_algorithm */
+static int
+partitionPeerCandidates( struct peer_candidate * candidates, int left, int right, int pivotIndex )
+{
+    int i;
+    int storeIndex;
+    struct peer_candidate tmp;
+    const struct peer_candidate pivotValue = candidates[pivotIndex];
+
+    /* move pivot to end */
+    tmp = candidates[right];
+    candidates[right] = pivotValue;
+    candidates[pivotIndex] = tmp;
+
+    storeIndex = left;
+    for( i=left; i<=right; ++i )
+    {
+        if( candidates[i].score < pivotValue.score )
+        {
+            tmp = candidates[storeIndex];
+            candidates[storeIndex] = candidates[i];
+            candidates[i] = tmp;
+            storeIndex++;
+        }
+    }
+
+    /* move pivot to its final place */
+    tmp = candidates[right];
+    candidates[right] = candidates[storeIndex];
+    candidates[storeIndex] = tmp;
+
+    /* sanity check */
+    assert( checkPartition( candidates, left, right, pivotValue.score, storeIndex ) );
+
+    return storeIndex;
+}
+
+/* Adapted from http://en.wikipedia.org/wiki/Selection_algorithm */
+static void
+selectPeerCandidates( struct peer_candidate * candidates, int left, int right, int k )
+{
+    if( right > left )
+    {
+        const int pivotIndex = left + (right-left)/2;
+
+        int pivotNewIndex = partitionPeerCandidates( candidates, left, right, pivotIndex );
+
+        if( pivotNewIndex > left + k ) /* new condition */
+            selectPeerCandidates( candidates, left, pivotNewIndex-1, k );
+        else if( pivotNewIndex < left + k )
+            selectPeerCandidates( candidates, pivotNewIndex+1, right, k+left-pivotNewIndex-1 );
+    }
+}
+
+#ifndef NDEBUG
+static bool
+checkBestScoresComeFirst( const struct peer_candidate * candidates, int n, int k )
+{
+    int i;
+    uint64_t worstFirstScore = 0;
+    const int x = MIN( n, k ) - 1;
+
+    for( i=0; i<x; i++ )
+        if( worstFirstScore < candidates[i].score )
+            worstFirstScore = candidates[i].score;
+
+    for( i=0; i<x; i++ )
+        assert( candidates[i].score <= worstFirstScore );
+
+    for( i=x+1; i<n; i++ )
+        assert( candidates[i].score >= worstFirstScore );
+
+    return true;
+}
+#endif /* NDEBUG */
 
 /** @return an array of all the atoms we might want to connect to */
 static struct peer_candidate*
-getPeerCandidates( tr_session * session, int * candidateCount )
+getPeerCandidates( tr_session * session, int * candidateCount, int max )
 {
     int atomCount;
     int peerCount;
@@ -3912,8 +4007,11 @@
     }
 
     *candidateCount = walk - candidates;
-    if( *candidateCount > 1 )
-        qsort( candidates, *candidateCount, sizeof( struct peer_candidate ), comparePeerCandidates );
+    if( walk != candidates )
+        selectPeerCandidates( candidates, 0, (walk-candidates)-1, max );
+
+    assert( checkBestScoresComeFirst( candidates, *candidateCount, max ) );
+
     return candidates;
 }
 
@@ -3990,7 +4088,7 @@
     int i, n;
     struct peer_candidate * candidates;
 
-    candidates = getPeerCandidates( mgr->session, &n );
+    candidates = getPeerCandidates( mgr->session, &n, max );
 
     for( i=0; i<n && i<max; ++i )
         initiateCandidateConnection( mgr, &candidates[i] );
diff -Naur ./.svn/text-base/peer-mgr.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.h.svn-base
--- ./.svn/text-base/peer-mgr.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -248,9 +248,9 @@
 double* tr_peerMgrWebSpeeds_KBps( const tr_torrent * tor );
 
 
-int tr_peerGetPieceSpeed_Bps( const tr_peer    * peer,
-                              uint64_t           now,
-                              tr_direction       direction );
+unsigned int tr_peerGetPieceSpeed_Bps( const tr_peer    * peer,
+                                       uint64_t           now,
+                                       tr_direction       direction );
 
 void tr_peerMgrClearInterest( tr_torrent * tor );
 
diff -Naur ./.svn/text-base/peer-msgs.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-msgs.c.svn-base
--- ./.svn/text-base/peer-msgs.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-msgs.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -16,8 +16,6 @@
 #include <stdlib.h>
 #include <string.h>
 
-#include <alloca.h>
-
 #include <event2/buffer.h>
 #include <event2/bufferevent.h>
 #include <event2/event.h>
@@ -241,6 +239,7 @@
         char              timestr[64];
         struct evbuffer * buf = evbuffer_new( );
         char *            base = tr_basename( file );
+        char *            message;
 
         evbuffer_add_printf( buf, "[%s] %s - %s [%s]: ",
                              tr_getLogTimeStr( timestr, sizeof( timestr ) ),
@@ -251,10 +250,12 @@
         evbuffer_add_vprintf( buf, fmt, args );
         va_end( args );
         evbuffer_add_printf( buf, " (%s:%d)\n", base, line );
-        fputs( (const char*)evbuffer_pullup( buf, -1 ), fp );
+
+        message = evbuffer_free_to_str( buf );
+        fputs( message, fp );
 
         tr_free( base );
-        evbuffer_free( buf );
+        tr_free( message );
     }
 }
 
@@ -1675,8 +1676,8 @@
     else
     {
         int estimatedBlocksInPeriod;
-        int rate_Bps;
-        int irate_Bps;
+        unsigned int rate_Bps;
+        unsigned int irate_Bps;
         const int floor = 4;
         const int seconds = REQUEST_BUF_SECS;
         const uint64_t now = tr_time_msec( );
@@ -1688,8 +1689,8 @@
             rate_Bps = MIN( rate_Bps, tr_torrentGetSpeedLimit_Bps( torrent, TR_PEER_TO_CLIENT ) );
 
         /* honor the session limits, if enabled */
-        if( tr_torrentUsesSessionLimits( torrent ) )
-            if( tr_sessionGetActiveSpeedLimit_Bps( torrent->session, TR_PEER_TO_CLIENT, &irate_Bps ) )
+        if( tr_torrentUsesSessionLimits( torrent ) 
+	&&  tr_sessionGetActiveSpeedLimit_Bps( torrent->session, TR_PEER_TO_CLIENT, &irate_Bps ) )
                 rate_Bps = MIN( rate_Bps, irate_Bps );
 
         /* use this desired rate to figure out how
@@ -1748,7 +1749,7 @@
         int i;
         int n;
         const int numwant = msgs->desiredRequestCount - msgs->peer->pendingReqsToPeer;
-        tr_block_index_t * blocks = alloca( sizeof( tr_block_index_t ) * numwant );
+        tr_block_index_t * blocks = tr_new( tr_block_index_t, numwant );
 
         tr_peerMgrGetNextRequests( msgs->torrent, msgs->peer, numwant, blocks, &n, false );
 
@@ -1758,6 +1759,8 @@
             blockToReq( msgs->torrent, blocks[i], &req );
             protocolSendRequest( msgs, &req );
         }
+
+        tr_free( blocks );
     }
 }
 
diff -Naur ./.svn/text-base/port-forwarding.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/port-forwarding.c.svn-base
--- ./.svn/text-base/port-forwarding.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/port-forwarding.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -18,7 +18,7 @@
 #include <event2/event.h>
 
 #include "transmission.h"
-#include "natpmp.h"
+#include "natpmp_local.h"
 #include "net.h"
 #include "peer-mgr.h"
 #include "port-forwarding.h"
diff -Naur ./.svn/text-base/rpc-server.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/rpc-server.c.svn-base
--- ./.svn/text-base/rpc-server.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/rpc-server.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -160,7 +160,7 @@
     size_t inlen = evbuffer_get_length( body );
 
     const char * boundary_key = "boundary=";
-    const char * boundary_key_begin = strstr( content_type, boundary_key );
+    const char * boundary_key_begin = content_type ? strstr( content_type, boundary_key ) : NULL;
     const char * boundary_val = boundary_key_begin ? boundary_key_begin + strlen( boundary_key ) : "arglebargle";
     char * boundary = tr_strdup_printf( "--%s", boundary_val );
     const size_t boundary_len = strlen( boundary );
diff -Naur ./.svn/text-base/rpcimpl.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/rpcimpl.c.svn-base
--- ./.svn/text-base/rpcimpl.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/rpcimpl.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -523,7 +523,7 @@
 
     for( i = 0; i < peerCount; ++i )
     {
-        tr_benc *            d = tr_bencListAddDict( list, 14 );
+        tr_benc *            d = tr_bencListAddDict( list, 16 );
         const tr_peer_stat * peer = peers + i;
         tr_bencDictAddStr ( d, "address", peer->addr );
         tr_bencDictAddStr ( d, "clientName", peer->client );
@@ -637,7 +637,7 @@
         tr_bencDictAddInt( d, key, st->peersConnected );
     else if( tr_streq( key, keylen, "peersFrom" ) )
     {
-        tr_benc *   tmp = tr_bencDictAddDict( d, key, 6 );
+        tr_benc *   tmp = tr_bencDictAddDict( d, key, 7 );
         const int * f = st->peersFrom;
         tr_bencDictAddInt( tmp, "fromCache",    f[TR_PEER_FROM_RESUME] );
         tr_bencDictAddInt( tmp, "fromDht",      f[TR_PEER_FROM_DHT] );
diff -Naur ./.svn/text-base/session.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/session.c.svn-base
--- ./.svn/text-base/session.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/session.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -24,6 +24,8 @@
 #include <event2/dns.h> /* evdns_base_free() */
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 //#define TR_SHOW_DEPRECATED
 #include "transmission.h"
 #include "announcer.h"
@@ -1215,7 +1217,7 @@
 ***/
 
 bool
-tr_sessionGetActiveSpeedLimit_Bps( const tr_session * session, tr_direction dir, int * setme_Bps )
+tr_sessionGetActiveSpeedLimit_Bps( const tr_session * session, tr_direction dir, unsigned int * setme_Bps )
 {
     int isLimited = true;
 
@@ -1236,7 +1238,7 @@
                                     tr_direction        dir,
                                     double            * setme_KBps )
 {
-    int Bps = 0;
+    unsigned int Bps = 0;
     const bool is_active = tr_sessionGetActiveSpeedLimit_Bps( session, dir, &Bps );
     *setme_KBps = toSpeedKBps( Bps );
     return is_active;
@@ -1245,7 +1247,7 @@
 static void
 updateBandwidth( tr_session * session, tr_direction dir )
 {
-    int limit_Bps = 0;
+    unsigned int limit_Bps = 0;
     const bool isLimited = tr_sessionGetActiveSpeedLimit_Bps( session, dir, &limit_Bps );
     const bool zeroCase = isLimited && !limit_Bps;
 
@@ -1392,23 +1394,22 @@
 ***/
 
 void
-tr_sessionSetSpeedLimit_Bps( tr_session * s, tr_direction d, int Bps )
+tr_sessionSetSpeedLimit_Bps( tr_session * s, tr_direction d, unsigned int Bps )
 {
     assert( tr_isSession( s ) );
     assert( tr_isDirection( d ) );
-    assert( Bps >= 0 );
 
     s->speedLimit_Bps[d] = Bps;
 
     updateBandwidth( s, d );
 }
 void
-tr_sessionSetSpeedLimit_KBps( tr_session * s, tr_direction d, int KBps )
+tr_sessionSetSpeedLimit_KBps( tr_session * s, tr_direction d, unsigned int KBps )
 {
     tr_sessionSetSpeedLimit_Bps( s, d, toSpeedBytes( KBps ) );
 }
 
-int
+unsigned int
 tr_sessionGetSpeedLimit_Bps( const tr_session * s, tr_direction d )
 {
     assert( tr_isSession( s ) );
@@ -1416,7 +1417,7 @@
 
     return s->speedLimit_Bps[d];
 }
-int
+unsigned int
 tr_sessionGetSpeedLimit_KBps( const tr_session * s, tr_direction d )
 {
     return toSpeedKBps( tr_sessionGetSpeedLimit_Bps( s, d ) );
@@ -1448,11 +1449,10 @@
 ***/
 
 void
-tr_sessionSetAltSpeed_Bps( tr_session * s, tr_direction d, int Bps )
+tr_sessionSetAltSpeed_Bps( tr_session * s, tr_direction d, unsigned int Bps )
 {
     assert( tr_isSession( s ) );
     assert( tr_isDirection( d ) );
-    assert( Bps >= 0 );
 
     s->turtle.speedLimit_Bps[d] = Bps;
 
@@ -1460,12 +1460,12 @@
 }
 
 void
-tr_sessionSetAltSpeed_KBps( tr_session * s, tr_direction d, int KBps )
+tr_sessionSetAltSpeed_KBps( tr_session * s, tr_direction d, unsigned int KBps )
 {
     tr_sessionSetAltSpeed_Bps( s, d, toSpeedBytes( KBps ) );
 }
 
-int
+unsigned int
 tr_sessionGetAltSpeed_Bps( const tr_session * s, tr_direction d )
 {
     assert( tr_isSession( s ) );
@@ -1473,7 +1473,7 @@
 
     return s->turtle.speedLimit_Bps[d];
 }
-int
+unsigned int
 tr_sessionGetAltSpeed_KBps( const tr_session * s, tr_direction d )
 {
     return toSpeedKBps( tr_sessionGetAltSpeed_Bps( s, d ) );
@@ -1682,13 +1682,13 @@
 ****
 ***/
 
-int
+unsigned int
 tr_sessionGetPieceSpeed_Bps( const tr_session * session, tr_direction dir )
 {
     return tr_isSession( session ) ? tr_bandwidthGetPieceSpeed_Bps( &session->bandwidth, 0, dir ) : 0;
 }
 
-int
+unsigned int
 tr_sessionGetRawSpeed_Bps( const tr_session * session, tr_direction dir )
 {
     return tr_isSession( session ) ? tr_bandwidthGetRawSpeed_Bps( &session->bandwidth, 0, dir ) : 0;
@@ -2675,7 +2675,6 @@
     assert( minutes > 0 );
 
     session->queueStalledMinutes = minutes;
-   
 }
 
 void
@@ -2686,7 +2685,7 @@
 
     session->stalledEnabled = is_enabled;
 }
-  
+
 bool
 tr_sessionGetQueueStalledEnabled( const tr_session * session )
 {
diff -Naur ./.svn/text-base/session.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/session.h.svn-base
--- ./.svn/text-base/session.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/session.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -56,7 +56,7 @@
 struct tr_turtle_info
 {
     /* TR_UP and TR_DOWN speed limits */
-    int speedLimit_Bps[2];
+    unsigned int speedLimit_Bps[2];
 
     /* is turtle mode on right now? */
     bool isEnabled;
@@ -118,7 +118,7 @@
 
     int                          umask;
 
-    int                          speedLimit_Bps[2];
+    unsigned int                 speedLimit_Bps[2];
     bool                         speedLimitEnabled[2];
 
     struct tr_turtle_info        turtle;
@@ -292,26 +292,30 @@
 ****
 ***/
 
-static inline unsigned int toSpeedBytes ( unsigned int KBps ) { return KBps * tr_speed_K; }
-static inline double       toSpeedKBps  ( unsigned int Bps )  { return Bps / (double)tr_speed_K; }
-
-static inline uint64_t toMemBytes ( unsigned int MB ) { uint64_t B = tr_mem_K * tr_mem_K; B *= MB; return B; }
-static inline int      toMemMB    ( uint64_t B )      { return B / ( tr_mem_K * tr_mem_K ); }
+static inline unsigned int
+toSpeedBytes ( unsigned int KBps ) { return KBps * tr_speed_K; }
+static inline double
+toSpeedKBps  ( unsigned int Bps )  { return Bps / (double)tr_speed_K; }
+
+static inline uint64_t
+toMemBytes ( unsigned int MB ) { uint64_t B = tr_mem_K * tr_mem_K; B *= MB; return B; }
+static inline int
+toMemMB    ( uint64_t B )      { return B / ( tr_mem_K * tr_mem_K ); }
 
 /**
 **/
 
-int  tr_sessionGetSpeedLimit_Bps( const tr_session *, tr_direction );
-int  tr_sessionGetAltSpeed_Bps  ( const tr_session *, tr_direction );
-int  tr_sessionGetRawSpeed_Bps  ( const tr_session *, tr_direction );
-int  tr_sessionGetPieceSpeed_Bps( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetSpeedLimit_Bps( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetAltSpeed_Bps  ( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetRawSpeed_Bps  ( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetPieceSpeed_Bps( const tr_session *, tr_direction );
 
-void tr_sessionSetSpeedLimit_Bps( tr_session *, tr_direction, int Bps );
-void tr_sessionSetAltSpeed_Bps  ( tr_session *, tr_direction, int Bps );
+void tr_sessionSetSpeedLimit_Bps( tr_session *, tr_direction, unsigned int Bps );
+void tr_sessionSetAltSpeed_Bps  ( tr_session *, tr_direction, unsigned int Bps );
 
 bool  tr_sessionGetActiveSpeedLimit_Bps( const tr_session  * session,
                                          tr_direction        dir,
-                                         int               * setme );
+                                         unsigned int      * setme );
 
 tr_torrent * tr_sessionGetNextQueuedSeed( tr_session * session );
 tr_torrent * tr_sessionGetNextQueuedTorrent( tr_session * session, tr_direction );
diff -Naur ./.svn/text-base/stats.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/stats.c.svn-base
--- ./.svn/text-base/stats.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/stats.c.svn-base	2012-07-09 13:11:36.000000000 +0200
@@ -210,6 +210,7 @@
     zero.sessionCount = 0;
     zero.secondsActive = 0;
 
+    session->sessionStats->isDirty = true;
     session->sessionStats->single = session->sessionStats->old = zero;
     session->sessionStats->startTime = tr_time( );
 }
diff -Naur ./.svn/text-base/torrent.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.c.svn-base
--- ./.svn/text-base/torrent.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -153,7 +153,7 @@
 tr_torrentIsPieceTransferAllowed( const tr_torrent  * tor,
                                   tr_direction        direction )
 {
-    int limit;
+    unsigned int limit;
     bool allowed = true;
 
     if( tr_torrentUsesSpeedLimit( tor, direction ) )
@@ -173,22 +173,21 @@
 ***/
 
 void
-tr_torrentSetSpeedLimit_Bps( tr_torrent * tor, tr_direction dir, int Bps )
+tr_torrentSetSpeedLimit_Bps( tr_torrent * tor, tr_direction dir, unsigned int Bps )
 {
     assert( tr_isTorrent( tor ) );
     assert( tr_isDirection( dir ) );
-    assert( Bps >= 0 );
 
     if( tr_bandwidthSetDesiredSpeed_Bps( &tor->bandwidth, dir, Bps ) )
         tr_torrentSetDirty( tor );
 }
 void
-tr_torrentSetSpeedLimit_KBps( tr_torrent * tor, tr_direction dir, int KBps )
+tr_torrentSetSpeedLimit_KBps( tr_torrent * tor, tr_direction dir, unsigned int KBps )
 {
     tr_torrentSetSpeedLimit_Bps( tor, dir, toSpeedBytes( KBps ) );
 }
 
-int
+unsigned int
 tr_torrentGetSpeedLimit_Bps( const tr_torrent * tor, tr_direction dir )
 {
     assert( tr_isTorrent( tor ) );
@@ -196,7 +195,7 @@
 
     return tr_bandwidthGetDesiredSpeed_Bps( &tor->bandwidth, dir );
 }
-int
+unsigned int
 tr_torrentGetSpeedLimit_KBps( const tr_torrent * tor, tr_direction dir )
 {
     return toSpeedKBps( tr_torrentGetSpeedLimit_Bps( tor, dir ) );
@@ -2722,8 +2721,6 @@
     }
 }
 
-static bool fileExists( const char * filename, time_t * optional_mtime );
-
 /**
  * This convoluted code does something (seemingly) simple:
  * remove the torrent's local files.
@@ -2762,12 +2759,12 @@
     for( f=0; f<tor->info.fileCount; ++f )
     {
         char * filename = tr_buildPath( top, tor->info.files[f].name, NULL );
-        if( !fileExists( filename, NULL ) ) {
+        if( !tr_fileExists( filename, NULL ) ) {
                 char * partial = tr_torrentBuildPartial( tor, f );
                 tr_free( filename );
                 filename = tr_buildPath( top, partial, NULL );
                 tr_free( partial );
-                if( !fileExists( filename, NULL ) ) {
+                if( !tr_fileExists( filename, NULL ) ) {
                         tr_free( filename );
                         filename = NULL;
                 }
@@ -2814,7 +2811,7 @@
     for( i=0, n=tr_ptrArraySize(&files); i<n; ++i )
     {
         char * walk = tr_strdup( tr_ptrArrayNth( &files, i ) );
-        while( fileExists( walk, NULL ) && !tr_is_same_file( tmpdir, walk ) )
+        while( tr_fileExists( walk, NULL ) && !tr_is_same_file( tmpdir, walk ) )
         {
             char * tmp = tr_dirname( walk );
             func( walk );
@@ -2833,13 +2830,9 @@
     /* build a list of 'top's child directories that belong to this torrent */
     for( f=0; f<tor->info.fileCount; ++f )
     {
-        char * dir;
-        char * filename;
-
         /* get the directory that this file goes in... */
-        filename = tr_buildPath( top, tor->info.files[f].name, NULL );
-        dir = tr_dirname( filename );
-        tr_free( filename );
+        char * filename = tr_buildPath( top, tor->info.files[f].name, NULL );
+        char * dir = tr_dirname( filename );
         if( !tr_is_same_file( top, dir ) && strcmp( top, dir ) ) {
             for( ;; ) {
                 char * parent = tr_dirname( dir );
@@ -2853,6 +2846,8 @@
                 dir = parent;
             }
         }
+        tr_free( dir );
+        tr_free( filename );
     }
     for( i=0, n=tr_ptrArraySize(&folders); i<n; ++i )
         removeEmptyFoldersAndJunkFiles( tr_ptrArrayNth( &folders, i ) );
@@ -3056,25 +3051,6 @@
 ****
 ***/
 
-#ifdef SYS_DARWIN
- #define TR_STAT_MTIME(sb) ((sb).st_mtimespec.tv_sec)
-#else
- #define TR_STAT_MTIME(sb) ((sb).st_mtime)
-#endif
-
-
-static bool
-fileExists( const char * filename, time_t * mtime )
-{
-    struct stat sb;
-    const bool ok = !stat( filename, &sb );
-
-    if( ok && ( mtime != NULL ) )
-        *mtime = TR_STAT_MTIME( sb );
-
-    return ok;
-}
-
 bool
 tr_torrentFindFile2( const tr_torrent * tor, tr_file_index_t fileNum,
                      const char ** base, char ** subpath, time_t * mtime )
@@ -3091,7 +3067,7 @@
 
     if( b == NULL ) {
         char * filename = tr_buildPath( tor->downloadDir, file->name, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->downloadDir;
             s = file->name;
         }
@@ -3100,7 +3076,7 @@
 
     if( ( b == NULL ) && ( tor->incompleteDir != NULL ) ) {
         char * filename = tr_buildPath( tor->incompleteDir, file->name, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->incompleteDir;
             s = file->name;
         }
@@ -3112,7 +3088,7 @@
 
     if( ( b == NULL ) && ( tor->incompleteDir != NULL ) ) {
         char * filename = tr_buildPath( tor->incompleteDir, part, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->incompleteDir;
             s = part;
         }
@@ -3121,7 +3097,7 @@
 
     if( b == NULL) {
         char * filename = tr_buildPath( tor->downloadDir, part, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->downloadDir;
             s = part;
         }
diff -Naur ./.svn/text-base/torrent.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.h.svn-base
--- ./.svn/text-base/torrent.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.h.svn-base	2012-07-09 13:11:36.000000000 +0200
@@ -414,8 +414,8 @@
  * piece size, etc. such as in BEP 9 where peers exchange metadata */
 void tr_torrentGotNewInfoDict( tr_torrent * tor );
 
-void tr_torrentSetSpeedLimit_Bps  ( tr_torrent *, tr_direction, int Bps );
-int tr_torrentGetSpeedLimit_Bps  ( const tr_torrent *, tr_direction );
+void tr_torrentSetSpeedLimit_Bps  ( tr_torrent *, tr_direction, unsigned int Bps );
+unsigned int tr_torrentGetSpeedLimit_Bps  ( const tr_torrent *, tr_direction );
 
 /**
  * @return true if this piece needs to be tested
diff -Naur ./.svn/text-base/tr-udp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-udp.c.svn-base
--- ./.svn/text-base/tr-udp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-udp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -29,6 +29,8 @@
 
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "net.h"
 #include "session.h"
diff -Naur ./.svn/text-base/tr-utp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.c.svn-base
--- ./.svn/text-base/tr-utp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -25,6 +25,8 @@
 
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "net.h"
 #include "session.h"
diff -Naur ./.svn/text-base/tr-utp.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.h.svn-base
--- ./.svn/text-base/tr-utp.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -28,9 +28,6 @@
 #ifndef _TR_UTP_H_
 #define _TR_UTP_H_
 
-/* this is included *after* transmission.h s.t. we get bool defined */
-#include <libutp/utp.h>
-
 int tr_utpPacket(const unsigned char *buf, size_t buflen,
                  const struct sockaddr *from, socklen_t fromlen,
                  tr_session *ss);
diff -Naur ./.svn/text-base/transmission.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/transmission.h.svn-base
--- ./.svn/text-base/transmission.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/transmission.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -652,8 +652,8 @@
 ****  Primary session speed limits
 ***/
 
-void  tr_sessionSetSpeedLimit_KBps ( tr_session *, tr_direction, int KBps );
-int   tr_sessionGetSpeedLimit_KBps ( const tr_session *, tr_direction );
+void         tr_sessionSetSpeedLimit_KBps ( tr_session *, tr_direction, unsigned int KBps );
+unsigned int tr_sessionGetSpeedLimit_KBps ( const tr_session *, tr_direction );
 
 void  tr_sessionLimitSpeed         ( tr_session *, tr_direction, bool );
 bool  tr_sessionIsSpeedLimited     ( const tr_session *, tr_direction );
@@ -663,8 +663,8 @@
 ****  Alternative speed limits that are used during scheduled times
 ***/
 
-void     tr_sessionSetAltSpeed_KBps   ( tr_session *, tr_direction, int Bps );
-int      tr_sessionGetAltSpeed_KBps   ( const tr_session *, tr_direction );
+void         tr_sessionSetAltSpeed_KBps   ( tr_session *, tr_direction, unsigned int Bps );
+unsigned int tr_sessionGetAltSpeed_KBps   ( const tr_session *, tr_direction );
 
 void     tr_sessionUseAltSpeed        ( tr_session *, bool );
 bool     tr_sessionUsesAltSpeed       ( const tr_session * );
@@ -759,7 +759,7 @@
 ****  Torrents can be moved in the queue using the simple functions
 ****  tr_torrentQueueMove{Top,Up,Down,Bottom}. They can be moved to
 ****  arbitrary points in the queue with tr_torrentSetQueuePosition().
-****  
+****
 ***/
 
 
@@ -1227,8 +1227,8 @@
 ****
 ***/
 
-void     tr_torrentSetSpeedLimit_KBps  ( tr_torrent *, tr_direction, int KBps );
-int      tr_torrentGetSpeedLimit_KBps  ( const tr_torrent *, tr_direction );
+void         tr_torrentSetSpeedLimit_KBps  ( tr_torrent *, tr_direction, unsigned int KBps );
+unsigned int tr_torrentGetSpeedLimit_KBps  ( const tr_torrent *, tr_direction );
 
 void     tr_torrentUseSpeedLimit      ( tr_torrent *, tr_direction, bool );
 bool     tr_torrentUsesSpeedLimit     ( const tr_torrent *, tr_direction );
diff -Naur ./.svn/text-base/utils.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.c.svn-base
--- ./.svn/text-base/utils.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.c.svn-base	2012-07-09 13:11:36.000000000 +0200
@@ -231,6 +231,7 @@
         char              timestr[64];
         struct evbuffer * buf = evbuffer_new( );
         char *            base = tr_basename( file );
+        char *            message;
 
         evbuffer_add_printf( buf, "[%s] ",
                             tr_getLogTimeStr( timestr, sizeof( timestr ) ) );
@@ -241,12 +242,13 @@
         va_end( args );
         evbuffer_add_printf( buf, " (%s:%d)\n", base, line );
         /* FIXME(libevent2) ifdef this out for nonwindows platforms */
-        OutputDebugString( evbuffer_pullup( buf, -1 ) );
+        message = evbuffer_free_to_str( buf );
+        OutputDebugString( message );
         if( fp )
-            fputs( (const char*)evbuffer_pullup( buf, -1 ), fp );
+            fputs( message, fp );
 
+        tr_free( message );
         tr_free( base );
-        evbuffer_free( buf );
     }
 }
 
@@ -636,6 +638,24 @@
     return buf;
 }
 
+#ifdef SYS_DARWIN
+ #define TR_STAT_MTIME(sb) ((sb).st_mtimespec.tv_sec)
+#else
+ #define TR_STAT_MTIME(sb) ((sb).st_mtime)
+#endif
+
+bool
+tr_fileExists( const char * filename, time_t * mtime )
+{
+    struct stat sb;
+    const bool ok = !stat( filename, &sb );
+
+    if( ok && ( mtime != NULL ) )
+        *mtime = TR_STAT_MTIME( sb );
+
+    return ok;
+}
+
 /****
 *****
 ****/
@@ -978,11 +998,19 @@
 tr_urlIsValidTracker( const char * url )
 {
     bool valid;
-    const int len = url ? strlen(url) : 0;
 
-    valid = isValidURLChars( url, len )
-         && !tr_urlParse( url, len, NULL, NULL, NULL, NULL )
-         && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"udp://",6) );
+    if( url == NULL )
+    {
+        valid = false;
+    }
+    else
+    {
+        const int len = strlen( url );
+
+        valid = isValidURLChars( url, len )
+            && !tr_urlParse( url, len, NULL, NULL, NULL, NULL )
+            && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"udp://",6) );
+    }
 
     return valid;
 }
@@ -992,12 +1020,20 @@
 tr_urlIsValid( const char * url, int url_len )
 {
     bool valid;
-    if( ( url_len < 0 ) && ( url != NULL ) )
-        url_len = strlen( url );
 
-    valid = isValidURLChars( url, url_len )
-         && !tr_urlParse( url, url_len, NULL, NULL, NULL, NULL )
-         && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"ftp://",6) || !memcmp(url,"sftp://",7) );
+    if( url == NULL )
+    {
+        valid = false;
+    }
+    else
+    {
+        if( url_len < 0 )
+            url_len = strlen( url );
+
+        valid = isValidURLChars( url, url_len )
+            && !tr_urlParse( url, url_len, NULL, NULL, NULL, NULL )
+            && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"ftp://",6) || !memcmp(url,"sftp://",7) );
+    }
 
     return valid;
 }
@@ -1618,12 +1654,12 @@
 #ifdef HAVE_HTONLL
     return htonll( x );
 #else
-    /* fallback code by bdonlan at 
-     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */ 
-    union { uint32_t lx[2]; uint64_t llx; } u; 
-    u.lx[0] = htonl(x >> 32); 
-    u.lx[1] = htonl(x & 0xFFFFFFFFULL); 
-    return u.llx; 
+    /* fallback code by bdonlan at
+     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */
+    union { uint32_t lx[2]; uint64_t llx; } u;
+    u.lx[0] = htonl(x >> 32);
+    u.lx[1] = htonl(x & 0xFFFFFFFFULL);
+    return u.llx;
 #endif
 }
 
@@ -1633,11 +1669,11 @@
 #ifdef HAVE_NTOHLL
     return ntohll( x );
 #else
-    /* fallback code by bdonlan at 
-     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */ 
-    union { uint32_t lx[2]; uint64_t llx; } u; 
-    u.llx = x; 
-    return ((uint64_t)ntohl(u.lx[0]) << 32) | (uint64_t)ntohl(u.lx[1]); 
+    /* fallback code by bdonlan at
+     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */
+    union { uint32_t lx[2]; uint64_t llx; } u;
+    u.llx = x;
+    return ((uint64_t)ntohl(u.lx[0]) << 32) | (uint64_t)ntohl(u.lx[1]);
 #endif
 }
 
diff -Naur ./.svn/text-base/utils.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.h.svn-base
--- ./.svn/text-base/utils.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -239,6 +239,9 @@
 char* tr_buildPath( const char * first_element, ... ) TR_GNUC_NULL_TERMINATED
                                                       TR_GNUC_MALLOC;
 
+bool tr_fileExists( const char * filename, time_t * mtime );
+
+
 struct event;
 
 /**
diff -Naur ./.svn/text-base/web.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/web.c.svn-base
--- ./.svn/text-base/web.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/web.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -95,6 +95,8 @@
 struct tr_web
 {
     bool curl_verbose;
+    bool curl_ssl_verify;
+    const char * curl_ca_bundle;
     int close_mode;
     struct tr_web_task * tasks;
     tr_lock * taskLock;
@@ -171,8 +173,12 @@
     curl_easy_setopt( e, CURLOPT_SOCKOPTFUNCTION, sockoptfunction );
     curl_easy_setopt( e, CURLOPT_SOCKOPTDATA, task );
 #endif
-    curl_easy_setopt( e, CURLOPT_SSL_VERIFYHOST, 0L );
-    curl_easy_setopt( e, CURLOPT_SSL_VERIFYPEER, 0L );
+    if( web->curl_ssl_verify )
+        curl_easy_setopt( e, CURLOPT_CAINFO, web->curl_ca_bundle );
+    else {
+        curl_easy_setopt( e, CURLOPT_SSL_VERIFYHOST, 0L );
+        curl_easy_setopt( e, CURLOPT_SSL_VERIFYPEER, 0L );
+    }
     curl_easy_setopt( e, CURLOPT_TIMEOUT, task->timeout_secs );
     curl_easy_setopt( e, CURLOPT_URL, task->url );
     curl_easy_setopt( e, CURLOPT_USERAGENT, TR_NAME "/" SHORT_VERSION_STRING );
@@ -188,8 +194,11 @@
     if( task->cookies != NULL )
         curl_easy_setopt( e, CURLOPT_COOKIE, task->cookies );
 
-    if( task->range )
+    if( task->range != NULL ) {
         curl_easy_setopt( e, CURLOPT_RANGE, task->range );
+        /* don't bother asking the server to compress webseed fragments */
+        curl_easy_setopt( e, CURLOPT_ENCODING, "identity" );
+    }
 
     return e;
 }
@@ -318,6 +327,14 @@
     web->taskLock = tr_lockNew( );
     web->tasks = NULL;
     web->curl_verbose = getenv( "TR_CURL_VERBOSE" ) != NULL;
+    web->curl_ssl_verify = getenv( "TR_CURL_SSL_VERIFY" ) != NULL;
+    web->curl_ca_bundle = getenv( "CURL_CA_BUNDLE" );
+    if( web->curl_ssl_verify ) {
+        tr_ninf( "web", "will verify tracker certs using envvar CURL_CA_BUNDLE: %s",
+                  web->curl_ca_bundle == NULL ? "none" : web->curl_ca_bundle );
+        tr_ninf( "web", "NB: this only works if you built against libcurl with openssl or gnutls, NOT nss" );
+        tr_ninf( "web", "NB: invalid certs will show up as 'Could not connect to tracker' like many other errors" );
+    }
     web->cookie_filename = tr_buildPath( session->configDir, "cookies.txt", NULL );
 
     multi = curl_multi_init( );
diff -Naur ./.svn/text-base/webseed.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.c.svn-base
--- ./.svn/text-base/webseed.c.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.c.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -481,19 +481,20 @@
         char ** urls = t->webseed->file_urls;
 
         const tr_info * inf = tr_torrentInfo( tor );
-        const uint32_t remain = t->length - t->blocks_done * tor->blockSize
+        const uint64_t remain = t->length - t->blocks_done * tor->blockSize
                                 - evbuffer_get_length( t->content );
 
-        const uint64_t total_offset = inf->pieceSize * t->piece_index
-                                    + t->piece_offset + t->length - remain;
+        const uint64_t total_offset = tr_pieceOffset( tor, t->piece_index,
+                                                           t->piece_offset,
+                                                           t->length - remain );
         const tr_piece_index_t step_piece = total_offset / inf->pieceSize;
-        const uint32_t step_piece_offset
+        const uint64_t step_piece_offset
                                = total_offset - ( inf->pieceSize * step_piece );
 
         tr_file_index_t file_index;
-        uint64_t file_offset;
         const tr_file * file;
-        uint32_t this_pass;
+        uint64_t file_offset;
+        uint64_t this_pass;
 
         tr_ioFindFileLocation( tor, step_piece, step_piece_offset,
                                     &file_index, &file_offset );
@@ -511,7 +512,9 @@
 }
 
 bool
-tr_webseedGetSpeed_Bps( const tr_webseed * w, uint64_t now, int * setme_Bps )
+tr_webseedGetSpeed_Bps( const tr_webseed * w,
+                        uint64_t           now,
+                        unsigned int     * setme_Bps )
 {
     const bool is_active = webseed_has_tasks( w );
     *setme_Bps = is_active ? tr_bandwidthGetPieceSpeed_Bps( &w->bandwidth, now, TR_DOWN ) : 0;
@@ -521,7 +524,7 @@
 bool
 tr_webseedIsActive( const tr_webseed * w )
 {
-    int Bps = 0;
+    unsigned int Bps = 0;
     return tr_webseedGetSpeed_Bps( w, tr_time_msec(), &Bps ) && ( Bps > 0 );
 }
 
diff -Naur ./.svn/text-base/webseed.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.h.svn-base
--- ./.svn/text-base/webseed.h.svn-base	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.h.svn-base	2012-07-09 13:11:37.000000000 +0200
@@ -31,7 +31,7 @@
 /** @return true if a request is being processed, or false if idle */
 bool        tr_webseedGetSpeed_Bps( const tr_webseed * w,
                                     uint64_t           now,
-                                    int              * setme_Bps );
+                                    unsigned int     * setme_Bps );
 
 /** @return true if a request is being processed, or false if idle */
 bool        tr_webseedIsActive( const tr_webseed * w );
diff -Naur ./Makefile.am ../../../tmp/Transmission/libtransmission/Makefile.am
--- ./Makefile.am	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/Makefile.am	2012-07-09 13:11:37.000000000 +0200
@@ -1,7 +1,5 @@
 AM_CPPFLAGS = \
-    -I. \
     -I$(top_srcdir) \
-    -I$(top_srcdir)/third-party/ \
     -D__TRANSMISSION__ \
     -DPACKAGE_DATA_DIR=\""$(datadir)"\"
 
@@ -9,6 +7,7 @@
     @DHT_CFLAGS@ \
     @LIBUTP_CFLAGS@ \
     @LIBUPNP_CFLAGS@ \
+    @LIBNATPMP_CFLAGS@ \
     @LIBEVENT_CFLAGS@ \
     @LIBCURL_CFLAGS@ \
     @OPENSSL_CFLAGS@ \
@@ -91,7 +90,7 @@
     magnet.h \
     makemeta.h \
     metainfo.h \
-    natpmp.h \
+    natpmp_local.h \
     net.h \
     peer-common.h \
     peer-io.h \
@@ -141,7 +140,7 @@
 apps_ldadd = \
     ./libtransmission.a  \
     @LIBUPNP_LIBS@ \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
+    @LIBNATPMP_LIBS@ \
     @INTLLIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
diff -Naur ./announcer-common.h ../../../tmp/Transmission/libtransmission/announcer-common.h
--- ./announcer-common.h	2012-06-14 15:01:27.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/announcer-common.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: announcer-common.h 12238 2011-03-26 12:06:04Z jordan $
+ * $Id: announcer-common.h 13310 2012-05-20 14:14:59Z jordan $
  */
 
 #ifndef __LIBTRANSMISSION_ANNOUNCER_MODULE___
@@ -110,83 +110,6 @@
                             void                     * user_data );
 
 /***
- ****  FILE REPLICATION
- ***/
-
-enum
-{
-    /* pick a number small enough for common tracker software:
-     *  - ocelot has no upper bound
-     *  - opentracker has an upper bound of 64
-     *  - udp protocol has an upper bound of 74
-     *  - xbtt has no upper bound */
-    TR_FILEREPLICATION_REQUEST_MAX = 64
-};
-
-typedef struct
-{
-    /* the scrape URL */
-    char * url;
-    
-    /* the name to use when deep logging is enabled */
-    char log_name[128];
-    
-    /* size avaiable for new download */
-    int avaiable_space;
-}
-tr_filereplicate_request;
-
-
-typedef struct
-{
-    /* the current torrent tiers*/
-    struct tr_torrent_tiers* torrent_tier;
-    
-    /* whether or not we managed to connect to the tracker */
-    bool                did_connect;
-    
-    /* whether or not the filereplicate timed out */
-    bool                did_timeout;
-    
-    /* the raw scrape url */
-    char *              url;
-    
-    /* human-readable error string on failure, or NULL */
-    char *              errmsg;
-    
-    /* minimum interval (in seconds) allowed between scrapes.
-     * this is an unofficial extension that some trackers won't support. */
-    int                 min_request_interval;
-    
-    /* the torrent's info_hash to download*/
-    uint8_t             info_hash[SHA_DIGEST_LENGTH];
-    
-    /* Torrent info */
-    uint32_t            pieceSize;
-    tr_piece_index_t    pieceCount;
-    uint32_t            pieceToDownload;
-    
-    /* total size of the torrent, in bytes */
-    uint64_t            totalSize;
-    
-    /* pieces raw sha */
-    char*      piecesRawSign;
-}tr_filereplicate_response;
-
-typedef void tr_filereplicate_response_func( const tr_scrape_response  * response,
-                                     void                      * user_data );
-
-void tr_tracker_http_filereplicate( tr_session               * session,
-                            const tr_filereplicate_request  * req,
-                            tr_filereplicate_response_func    response_func,
-                            void                     * user_data );
-
-void tr_tracker_udp_filereplicate( tr_session               * session,
-                           const tr_filereplicate_request  * req,
-                           tr_filereplicate_response_func    response_func,
-                           void                     * user_data );
-
-/***
 ****  ANNOUNCE
 ***/
 
@@ -225,7 +148,7 @@
     uint64_t corrupt;
 
     /* the total size of the torrent minus the number of bytes completed */
-    uint64_t left;
+    uint64_t leftUntilComplete;
 
     /* the tracker's announce URL */
     char * url;
@@ -243,17 +166,6 @@
 
     /* the name to use when deep logging is enabled */
     char log_name[128];
-    
-    /* ADDED fro File Replication */
-    
-    /* Torrent info */
-    uint32_t            pieceSize;
-    tr_piece_index_t    pieceCount;
-    uint64_t            totalSize;
-    
-    /* pieces raw sha */
-    char*      piecesRawSign;
-    
 }
 tr_announce_request;
 
diff -Naur ./announcer-http.c ../../../tmp/Transmission/libtransmission/announcer-http.c
--- ./announcer-http.c	2012-06-21 14:51:48.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/announcer-http.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: announcer-http.c 12982 2011-10-14 00:27:14Z jordan $
+ * $Id: announcer-http.c 13310 2012-05-20 14:14:59Z jordan $
  */
 
 #include <limits.h> /* USHRT_MAX */
@@ -50,7 +50,7 @@
     return tr_announce_event_get_string( req->event );
 }
 
-static struct evbuffer *
+static char*
 announce_url_new( const tr_session * session, const tr_announce_request * req )
 {
     const char * str;
@@ -73,11 +73,7 @@
                               "&numwant=%d"
                               "&key=%x"
                               "&compact=1"
-                              "&supportcrypto=1"
-                              "&piece_size=%d"     // Added for File Replication information
-                              "&piece_count=%d"    // 
-                              "&total_size=%llu"   // 
-                              "&piece_signs=%s",   // 
+                              "&supportcrypto=1",
                               req->url,
                               strchr( req->url, '?' ) ? '&' : '?',
                               escaped_info_hash,
@@ -85,13 +81,9 @@
                               req->port,
                               req->up,
                               req->down,
-                              req->left,
+                              req->leftUntilComplete,
                               req->numwant,
-                              req->key,
-                              req->pieceSize,
-                              req->pieceCount,
-                              req->totalSize,
-                              req->piecesRawSign);
+                              req->key );
 
     if( session->encryptionMode == TR_ENCRYPTION_REQUIRED )
         evbuffer_add_printf( buf, "&requirecrypto=1" );
@@ -124,7 +116,7 @@
         tr_http_escape( buf, ipv6_readable, -1, true );
     }
 
-    return buf;
+    return evbuffer_free_to_str( buf );
 }
 
 static tr_pex*
@@ -172,7 +164,6 @@
     char log_name[128];
 };
 
-
 static void
 on_announce_done_eventthread( void * vdata )
 {
@@ -296,8 +287,7 @@
                           void                       * response_func_user_data )
 {
     struct announce_data * d;
-    struct evbuffer * buf = announce_url_new( session, request );
-    const char * url = (const char *) evbuffer_pullup( buf, -1 );
+    char * url = announce_url_new( session, request );
 
     d = tr_new0( struct announce_data, 1 );
     d->response.seeders = -1;
@@ -311,7 +301,7 @@
     dbgmsg( request->log_name, "Sending announce to libcurl: \"%s\"", url );
     tr_webRun( session, url, NULL, NULL, on_announce_done, d );
 
-    evbuffer_free( buf );
+    tr_free( url );
 }
 
 /****
@@ -372,7 +362,7 @@
         tr_benc * flags;
         const char * str;
         const int benc_loaded = !tr_bencLoad( msg, msglen, &top, NULL );
-        
+
         if( getenv( "TR_CURL_VERBOSE" ) != NULL )
         {
             if( !benc_loaded )
@@ -387,7 +377,7 @@
                 tr_free( str );
             }
         }
-        
+
         if( benc_loaded )
         {
             if( tr_bencDictFindStr( &top, "failure reason", &str ) )
@@ -438,7 +428,7 @@
     tr_runInEventThread( session, on_scrape_done_eventthread, data );
 }
 
-static struct evbuffer *
+static char *
 scrape_url_new( const tr_scrape_request * req )
 {
     int i;
@@ -455,7 +445,7 @@
         delimiter = '&';
     }
 
-    return buf;
+    return evbuffer_free_to_str( buf );
 }
 
 void
@@ -466,8 +456,7 @@
 {
     int i;
     struct scrape_data * d;
-    struct evbuffer * buf = scrape_url_new( request );
-    const char * url = (const char *) evbuffer_pullup( buf, -1 );
+    char * url = scrape_url_new( request );
 
     d = tr_new0( struct scrape_data, 1 );
     d->response.url = tr_strdup( request->url );
@@ -486,138 +475,5 @@
     dbgmsg( request->log_name, "Sending scrape to libcurl: \"%s\"", url );
     tr_webRun( session, url, NULL, NULL, on_scrape_done, d );
 
-    evbuffer_free( buf );
-}
-
-/****
- *****
- *****  FILE REPLICATION
- *****
- ****/
-struct filereplication_data
-{
-    tr_filereplicate_response response;
-    tr_filereplicate_response_func * response_func;
-    void * response_func_user_data;
-    char log_name[128];
-};
-
-static void
-on_file_replication_done( tr_session   * session,
-               bool           did_connect,
-               bool           did_timeout,
-               long           response_code,
-               const void   * msg,
-               size_t         msglen,
-               void         * vdata ){
-    tr_filereplicate_response * response;
-    struct filereplication_data * data = vdata;
-    
-    response = &data->response; //HERE
-    response->did_connect = did_connect;
-    response->did_timeout = did_timeout;
-    dbgmsg( data->log_name, "Got file replication response for \"%s\"", response->url );
-
-    if( response_code != HTTP_OK )
-    {
-        const char * fmt = _( "Tracker gave HTTP response code %1$ld (%2$s)" );
-        const char * response_str = tr_webGetResponseStr( response_code );
-        response->errmsg = tr_strdup_printf( fmt, response_code, response_str );
-    }else{
-        tr_benc top;
-        const char *    str;
-        const char *    hash;
-        int64_t         pieceSize;
-        int64_t         pieceCount;
-        int64_t         totalSize;
-        const char *    piecesRawSign;
-        
-        const int benc_loaded = !tr_bencLoad( msg, msglen, &top, NULL );
-        if( getenv( "TR_CURL_VERBOSE" ) != NULL )
-        {
-            if( !benc_loaded )
-                fprintf( stderr, "%s", "Scrape response was not in benc format\n" );
-            else {
-                int i, len;
-                char * str = tr_bencToStr( &top, TR_FMT_JSON, &len );
-                fprintf( stderr, "%s", "Scrape response:\n< " );
-                for( i=0; i<len; ++i )
-                    fputc( str[i], stderr );
-                fputc( '\n', stderr );
-                tr_free( str );
-            }
-        }
-        
-        if( benc_loaded )
-        {
-            if( tr_bencDictFindStr( &top, "failure reason", &str ) )
-                return; //response->errmsg = tr_strdup( str );
-            if( tr_bencDictFindStr( &top, "hash", &hash ) ){
-                int size = memcmp( hash, response->info_hash, SHA_DIGEST_LENGTH);
-                memcpy( response->info_hash, hash,SHA_DIGEST_LENGTH); 
-            }
-            
-            if( tr_bencDictFindInt( &top, "p_count", &pieceCount ) ){
-                response->pieceCount    = pieceCount;
-            }
-            
-            if( tr_bencDictFindInt( &top, "p_size", &pieceSize ) ){
-                response->pieceSize    = pieceSize;
-            }
-            
-            if( tr_bencDictFindInt( &top, "t_size", &totalSize ) ){
-                response->totalSize    = totalSize;
-            }
-            
-            if( tr_bencDictFindStr( &top, "raw_pieces", &piecesRawSign ) ){
-                response->piecesRawSign     = tr_new0(char,  pieceCount * 2 *SHA_DIGEST_LENGTH);
-                memcpy( response->piecesRawSign, piecesRawSign,sizeof(char) * 2 * pieceCount * SHA_DIGEST_LENGTH); 
-            }
-            
-            data->response_func(response,data->response_func_user_data);
-        }
-        
-    }
-}
-static struct evbuffer *
-filereplication_url_new( const tr_filereplicate_request * req )
-{
-    char delimiter;
-    struct evbuffer * buf = evbuffer_new( );
-    
-    evbuffer_add_printf( buf, "%s", req->url );
-    delimiter = strchr( req->url, '?' ) ? '&' : '?';
-    /*for( i=0; i<req->info_hash_count; ++i )
-    {
-        char str[SHA_DIGEST_LENGTH*3 + 1];
-        tr_http_escape_sha1( str, req->info_hash[i] );
-        evbuffer_add_printf( buf, "%cinfo_hash=%s", delimiter, str );
-        delimiter = '&';
-    }*/
-    
-    return buf;
-}
-
-
-
-void
-tr_tracker_http_filereplicate( tr_session               * session,
-                       const tr_filereplicate_request  * request,
-                       tr_filereplicate_response_func    response_func,
-                       void                     * response_func_user_data ){
-    struct filereplication_data * d;
-    struct evbuffer * buf = filereplication_url_new( request );
-    const char * url = (const char *) evbuffer_pullup( buf, -1 );
-    
-    d = tr_new0( struct filereplication_data, 1 );
-    d->response.url = tr_strdup( request->url );
-    d->response_func = response_func;
-    d->response_func_user_data = response_func_user_data;
-
-    tr_strlcpy( d->log_name, request->log_name, sizeof( d->log_name ) );
-    
-    dbgmsg( request->log_name, "Sending file replication to libcurl: \"%s\"", url );
-    tr_webRun( session, url, NULL, NULL, on_file_replication_done, d );
-    
-    evbuffer_free( buf );
+    tr_free( url );
 }
diff -Naur ./announcer-udp.c ../../../tmp/Transmission/libtransmission/announcer-udp.c
--- ./announcer-udp.c	2011-12-05 11:33:53.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/announcer-udp.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: announcer-udp.c 12982 2011-10-14 00:27:14Z jordan $
+ * $Id: announcer-udp.c 13310 2012-05-20 14:14:59Z jordan $
  */
 
 #define __LIBTRANSMISSION_ANNOUNCER_MODULE___
@@ -266,12 +266,6 @@
 }
 
 /****
- *****
- *****  FILE REPLICATION
- *****
- ****/
-
-/****
 *****
 *****  ANNOUNCE
 *****
@@ -329,7 +323,7 @@
     evbuffer_add        ( buf, in->info_hash, SHA_DIGEST_LENGTH );
     evbuffer_add        ( buf, in->peer_id, PEER_ID_LEN );
     evbuffer_add_hton_64( buf, in->down );
-    evbuffer_add_hton_64( buf, in->left );
+    evbuffer_add_hton_64( buf, in->leftUntilComplete );
     evbuffer_add_hton_64( buf, in->up );
     evbuffer_add_hton_32( buf, get_tau_announce_event( in->event ) );
     evbuffer_add_hton_32( buf, 0 );
@@ -972,12 +966,3 @@
     tr_ptrArrayAppend( &tracker->scrapes, r );
     tau_tracker_upkeep( tracker );
 }
-
-void
-tr_tracker_udp_filereplicate( tr_session               * session,
-                      const tr_filereplicate_request  * request,
-                      tr_filereplicate_response_func    response_func,
-                      void                     * user_data )
-{
-   //TODO
-}
diff -Naur ./announcer.c ../../../tmp/Transmission/libtransmission/announcer.c
--- ./announcer.c	2012-06-26 12:10:06.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/announcer.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: announcer.c 12982 2011-10-14 00:27:14Z jordan $
+ * $Id: announcer.c 13313 2012-05-22 20:21:00Z jordan $
  */
 
 #include <assert.h>
@@ -30,12 +30,12 @@
 #include "session.h"
 #include "torrent.h"
 #include "utils.h"
-#include "metainfo.h"
 
 struct tr_tier;
-struct tr_announcer;
+
 static void tier_build_log_name( const struct tr_tier * tier,
                                  char * buf, size_t buflen );
+
 #define dbgmsg( tier, ... ) \
 if( tr_deepLoggingIsActive( ) ) do { \
   char name[128]; \
@@ -203,7 +203,7 @@
     char * key;
     char * announce;
     char * scrape;
-    char * file_replication;
+
     char * tracker_id_str;
 
     int seederCount;
@@ -241,7 +241,6 @@
     tracker->key = getKey( inf->announce );
     tracker->announce = tr_strdup( inf->announce );
     tracker->scrape = tr_strdup( inf->scrape );
-    tracker->file_replication   = tr_strdup( inf->file_replication );
     tracker->id = inf->id;
     tracker->seederCount = -1;
     tracker->leecherCount = -1;
@@ -653,8 +652,8 @@
                                                tor->info.trackerCount, &n );
 
     /* build the array of trackers */
-    tt->trackers        = tr_new0( tr_tracker, n );
-    tt->tracker_count   = n;
+    tt->trackers = tr_new0( tr_tracker, n );
+    tt->tracker_count = n;
     for( i=0; i<n; ++i )
         trackerConstruct( &tt->trackers[i], &infos[i] );
 
@@ -754,6 +753,7 @@
     {
         int i;
         char name[128];
+        char * message;
         struct evbuffer * buf = evbuffer_new( );
 
         tier_build_log_name( tier, name, sizeof( name ) );
@@ -764,8 +764,9 @@
             evbuffer_add_printf( buf, "[%d:%s]", i, str );
         }
 
-        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", evbuffer_pullup( buf, -1 ) );
-        evbuffer_free( buf );
+        message = evbuffer_free_to_str( buf );
+        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", message );
+        tr_free( message );
     }
 }
 
@@ -911,31 +912,13 @@
     req->up = tier->byteCounts[TR_ANN_UP];
     req->down = tier->byteCounts[TR_ANN_DOWN];
     req->corrupt = tier->byteCounts[TR_ANN_CORRUPT];
-    req->left = tr_cpLeftUntilComplete( &tor->completion ),
+    req->leftUntilComplete = tr_torrentHasMetadata( tor )
+            ? tor->info.totalSize - tr_cpHaveTotal( &tor->completion )
+            : ~(uint64_t)0;
     req->event = event;
     req->numwant = event == TR_ANNOUNCE_EVENT_STOPPED ? 0 : NUMWANT;
     req->key = announcer->key;
     req->partial_seed = tr_cpGetStatus( &tor->completion ) == TR_PARTIAL_SEED;
-    
-    //ADDED for file replication
-    req->pieceSize      = tor->info.pieceSize;
-    req->pieceCount     = tor->info.pieceCount;
-    req->totalSize      = tor->info.totalSize;
-    
-    //RAW pieces signs register
-    req->piecesRawSign  = tr_new0(char, ((2 * SHA_DIGEST_LENGTH) * req->pieceCount) +1);
-    int i               = 0;
-    for( i = 0; i < req->pieceCount; ++i ){
-        char* piecesRawSign      = tr_new0(char, 2 * SHA_DIGEST_LENGTH);
-        tr_sha1_to_hex(piecesRawSign, tor->info.pieces[i].hash);
-        memcpy( &req->piecesRawSign[i * (2 * SHA_DIGEST_LENGTH)], piecesRawSign, 2 * SHA_DIGEST_LENGTH);
-        tr_free(piecesRawSign);
-    }
-    
-    char* last = req->piecesRawSign;
-    last       += ((2 * SHA_DIGEST_LENGTH) * req->pieceCount) +1;
-    *last       =  '\0';
-    
     tier_build_log_name( tier, req->log_name, sizeof( req->log_name ) );
     return req;
 }
@@ -997,18 +980,6 @@
     bool isRunningOnSuccess;
 };
 
-struct announce_replication_data{
-    int tierId;
-    time_t timeSent;
-    tr_announce_event event;
-    tr_session * session;
-    tr_tracker_info * trackers;
-    int trackerCount;
-    
-    /** If the request succeeds, the value for tier's "isRunning" flag */
-    bool isRunningOnSuccess;
-};
-
 static void
 on_announce_error( tr_tier * tier, const char * err, tr_announce_event e )
 {
@@ -1033,21 +1004,6 @@
     tier_announce_event_push( tier, e, tr_time( ) + interval );
 }
 
-static void 
-tierFileReplicate( tr_announcer * announcer, tr_tier * tier);
-
-
-static bool compareHash(uint8_t hash_source[],uint8_t hash_target[]){
-    bool result = true;
-    
-    for(int i=0; i<SHA_DIGEST_LENGTH; i++){
-        if(hash_source[i] != hash_target[i]){
-            return false;
-        }
-    }
-    return result;
-}
-
 static void
 on_announce_done( const tr_announce_response  * response,
                   void                        * vdata )
@@ -1096,7 +1052,7 @@
         tier->lastAnnounceSucceeded = false;
         tier->isAnnouncing = false;
         tier->manualAnnounceAllowedAt = now + tier->announceMinIntervalSec;
-        
+
         if( !response->did_connect )
         {
             on_announce_error( tier, _( "Could not connect to tracker" ), event );
@@ -1187,7 +1143,7 @@
 
             /* if the tracker included scrape fields in its announce response,
                then a separate scrape isn't needed */
-            if( scrape_fields >= 3 )
+            if( ( scrape_fields >= 3 ) || ( !tracker->scrape && ( scrape_fields >= 1 ) ) )
             {
                 tr_tordbg( tier->tor, "Announce response contained scrape info; "
                                       "rescheduling next scrape to %d seconds from now.",
@@ -1223,8 +1179,6 @@
                 tier_announce_event_push( tier, TR_ANNOUNCE_EVENT_NONE, now + i );
             }
         }
-        
-        tierFileReplicate( announcer, tier);
     }
 
     tr_free( data );
@@ -1235,7 +1189,6 @@
 {
     tr_free( req->tracker_id_str );
     tr_free( req->url );
-    tr_free(req->piecesRawSign);
     tr_free( req );
 }
 
@@ -1287,112 +1240,6 @@
 }
 
 /***
- ****
- ****  FILE REPLICATION
- ****
- ***/
-
-static void
-on_file_replicate_done( const tr_filereplicate_response * response, void * vdata ){
-    struct announce_replication_data * data = vdata;
-    tr_torrent* tor     = NULL;
-    int i               = 0;
-    tor                 = tr_torrentFindFromHash(data->session, response->info_hash);
-    
-    //const uint8_t* raw  = tr_new0(uint8_t, SHA_DIGEST_LENGTH * 4);
-    
-    //TEST OK
-    /*if(tor2!=NULL){
-        for( i = 0; i < tor2->info.pieceCount; ++i )
-            memcpy( &raw[i * SHA_DIGEST_LENGTH], tor2->info.pieces[i].hash,
-                   SHA_DIGEST_LENGTH );
-    }*/
-    if(tor == NULL){
-        tor                     = tr_new0( tr_torrent, 1 ); //Torrent instanciation
-        tor->info.name          = "File replication";
-        
-        tor->isRunning          = true; //TE
-        tor->isFileReplicated   = true;
-        //hash capture
-        memcpy( tor->info.hash, response->info_hash, sizeof(uint8_t) * SHA_DIGEST_LENGTH );
-        tr_sha1_to_hex(tor->info.hashString,tor->info.hash);
-        
-        //session capture
-        tor->session            = data->session;
-        //file and pieces capture
-        tor->info.fileCount     = 1;
-        tor->info.pieceSize     = response->pieceSize;
-        tor->info.pieceCount    = response->pieceCount;
-        tor->info.totalSize     = response->totalSize;
-        
-        //pieces management
-        tor->info.pieces        = tr_new0( tr_piece, tor->info.pieceCount );
-        for( i = 0; i < tor->info.pieceCount; ++i ){
-            uint8_t* currentHash    = tr_new0(uint8_t, SHA_DIGEST_LENGTH);
-            tr_hex_to_sha1(currentHash, &response->piecesRawSign[i * SHA_DIGEST_LENGTH * 2]);
-            memcpy( tor->info.pieces[i].hash, currentHash,
-               SHA_DIGEST_LENGTH );
-            //tor->info.pieces[i].dnd = i == response->pieceToDownload ? 0 : 1;
-        }
-        tor->info.trackers         = data->trackers;
-        tor->info.trackerCount     = data->trackerCount;
-        //files management
-        tor->info.isMultifile      = 0;
-        tor->info.fileCount        = 1;
-        tor->info.files            = tr_new0( tr_file, 1 );
-        tor->info.files[0].name    = tr_strdup( tor->info.name );
-        tor->info.files[0].length  = tor->info.totalSize;
-
-        char* torrentFile            = getTorrentFilePath( data->session, &tor->info );
-        tor->info.torrent           = torrentFile;
-        fprintf(stdout, "Downloading %d \n",*tor->info.hashString );
-        fileRepTorrentInit(tor);
-    }
-}
-
-static void
-filereplicate_request_delegate( tr_announcer             * announcer,
-                               const tr_filereplicate_request  * request,
-                               tr_filereplicate_response_func  * callback,
-                               void                     * callback_data ){
-    tr_session * session = announcer->session;
-    
-    if( !memcmp( request->url, "http", 4 ) )
-        tr_tracker_http_filereplicate( session, request, callback, callback_data );
-    else if( !memcmp( request->url, "udp://", 6 ) )
-        tr_tracker_udp_filereplicate( session, request, callback, callback_data );
-    else
-        tr_err( "Unsupported url: %s", request->url );
-}
-
-
-static void 
-tierFileReplicate( tr_announcer * announcer, tr_tier * tier){
-    //request declaration and creation
-    tr_filereplicate_request * request = tr_new0( tr_filereplicate_request, 1 ); //TODO check number request 
-    char * url = tier->currentTracker->file_replication;
-    struct announce_replication_data * data;
-    
-    request->url = url;
-    tier_build_log_name( tier, request->log_name, sizeof( request->log_name ) );
-    
-    
-    data = tr_new0( struct announce_replication_data, 1 );
-    data->session       = announcer->session;
-    data->tierId        = tier->key;
-    data->trackers      = tier->tor->info.trackers;
-    data->trackerCount  = tier->tor->info.trackerCount;
-    if(request->url != 0){
-        filereplicate_request_delegate( announcer, request, on_file_replicate_done, data );
-    }
-
-    /* cleanup */
-    tr_free( request );
-    
-}
-
-
-/***
 ****
 ****  SCRAPE
 ****
@@ -1645,40 +1492,6 @@
     return ret;
 }
 
-static void 
-annouceFileReplication( tr_announcer * announcer ){
-    int i;
-    int n;
-    //Declaration of the current torrent
-    tr_torrent * tor = NULL;
-    //List of tier to annouce for file replication
-    tr_ptrArray fileReplicMe = TR_PTR_ARRAY_INIT;
-    //loop on each torrent
-    while(( tor = tr_torrentNext( announcer->session, tor ))) {
-        struct tr_torrent_tiers * tt = tor->tiers;
-        //loop on each tier
-        for( i=0; tt && i<tt->tier_count; ++i ) {
-            tr_tier * tier = &tt->tiers[i];
-            //TODO verify if tier already exist
-            tr_ptrArrayAppend( &fileReplicMe, tier );
-        }
-    }
-    
-    /* if there are more tiers than slots available, prioritize */
-    n = tr_ptrArraySize( &fileReplicMe );
-    if( n > announcer->slotsAvailable )
-        qsort( tr_ptrArrayBase(&fileReplicMe), n, sizeof(tr_tier*), compareTiers );
-    
-    /* announce file replication on all tiers */
-    n = tr_ptrArraySize( &fileReplicMe );
-    for( i=0; i<n; ++i ) {
-        tr_tier * tier = tr_ptrArrayNth( &fileReplicMe, i );
-        tr_tordbg( tier->tor, "%s", "Announcing to tracker" );
-        dbgmsg( tier, "announcing tier %d of %d", i, n );
-        tierFileReplicate( announcer, tier );
-    }
-}
-
 static void
 announceMore( tr_announcer * announcer )
 {
@@ -1745,7 +1558,7 @@
     /* maybe send out some announcements to trackers */
     if( !is_closing )
         announceMore( announcer );
-    
+
     /* TAU upkeep */
     if( announcer->tauUpkeepAt <= now ) {
         announcer->tauUpkeepAt = now + TAU_UPKEEP_INTERVAL_SECS;
@@ -1754,9 +1567,6 @@
 
     /* set up the next timer */
     tr_timerAdd( announcer->upkeepTimer, UPKEEP_INTERVAL_SECS, 0 );
-    
-    /*File replication announce*/
-    //annouceFileReplication(announcer);
 
     tr_sessionUnlock( session );
 }
diff -Naur ./bandwidth.c ../../../tmp/Transmission/libtransmission/bandwidth.c
--- ./bandwidth.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/bandwidth.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: bandwidth.c 13034 2011-10-25 21:54:51Z jordan $
+ * $Id: bandwidth.c 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #include <assert.h>
@@ -174,8 +174,8 @@
     /* set the available bandwidth */
     if( b->band[dir].isLimited )
     {
-        const unsigned int nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
-        b->band[dir].bytesLeft = ( nextPulseSpeed * period_msec ) / 1000u;
+        const uint64_t nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
+        b->band[dir].bytesLeft = (unsigned int)( nextPulseSpeed * period_msec ) / 1000u;
     }
 
     /* add this bandwidth's peer, if any, to the peer pool */
diff -Naur ./bencode-test.c ../../../tmp/Transmission/libtransmission/bencode-test.c
--- ./bencode-test.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/bencode-test.c	2012-07-09 13:11:37.000000000 +0200
@@ -319,8 +319,8 @@
                  const char * expected )
 {
     tr_benc top;
-    struct evbuffer * buf = evbuffer_new( );
     char * serialized;
+    struct evbuffer * buf;
 
     tr_bencLoad( benc_str, strlen( benc_str ), &top, NULL );
     buf = tr_bencToBuf( &top, TR_FMT_JSON );
diff -Naur ./bencode.c ../../../tmp/Transmission/libtransmission/bencode.c
--- ./bencode.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/bencode.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: bencode.c 12463 2011-05-27 23:28:40Z jordan $
+ * $Id: bencode.c 13198 2012-02-04 00:34:39Z jordan $
  */
 
 #include <assert.h>
@@ -1593,6 +1593,16 @@
                     tr_bencListCopy( tr_bencDictAddList( target, key, tr_bencListSize( val ) ), val );
                 }
             }
+            else if( tr_bencIsDict( val ) )
+            {
+                tr_benc * target_dict = tr_bencDictFind( target, key );
+
+                if( target_dict == NULL )
+                    target_dict = tr_bencDictAddDict( target, key, tr_bencDictSize( val ) );
+
+                if( tr_bencIsDict( target_dict ) )
+                    tr_bencMergeDicts( target_dict, val );
+            }
             else
             {
                 tr_dbg( "tr_bencMergeDicts skipping \"%s\"", key );
diff -Naur ./clients.c ../../../tmp/Transmission/libtransmission/clients.c
--- ./clients.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/clients.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: clients.c 12502 2011-06-16 12:08:52Z livings124 $
+ * $Id: clients.c 13099 2011-11-22 03:30:37Z livings124 $
  */
 
 /* thanks amc1! */
@@ -304,6 +304,29 @@
             return;
     }
 
+    /* uTorrent will replace the trailing dash with an extra digit for longer version numbers */
+    if( id[0] == '-' )
+    {
+        if( !memcmp( id+1, "UT", 2 ) )
+        {
+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent %d.%d.%d%s",
+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
+        }
+        else if( !memcmp( id+1, "UM", 2 ) )
+        {
+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Mac %d.%d.%d%s",
+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
+        }
+        else if( !memcmp( id+1, "UE", 2 ) )
+        {
+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Embedded %d.%d.%d%s",
+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
+        }
+
+        if( *buf )
+            return;
+    }
+
     /* Mainline */
     if( isMainlineStyle( id ) )
     {
diff -Naur ./completion.c ../../../tmp/Transmission/libtransmission/completion.c
--- ./completion.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/completion.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: completion.c 12918 2011-09-26 06:18:48Z jordan $
+ * $Id: completion.c 13113 2011-12-22 19:35:13Z jordan $
  */
 
 #include <assert.h>
@@ -165,19 +165,13 @@
                 }
                 else
                 {
-                    uint64_t o = 0;
-                    tr_block_index_t b, f, l;
+                    tr_block_index_t f, l;
                     tr_torGetPieceBlockRange( cp->tor, p, &f, &l );
-                    for( b=f; b<=l; ++b )
-                        if( tr_cpBlockIsComplete( cp, b ) )
-                            n += tr_torBlockCountBytes( tor, b );
 
-                    o = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
-                    o *= cp->tor->blockSize;
+                    n = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
+                    n *= cp->tor->blockSize;
                     if( l == ( cp->tor->blockCount - 1 )  && tr_bitfieldHas( &cp->blockBitfield, l ) )
-                        o -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
-
-                    assert( n == o );
+                        n -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
                 }
 
                 assert( n <= tr_torPieceCountBytes( tor, p ) );
diff -Naur ./completion.h ../../../tmp/Transmission/libtransmission/completion.h
--- ./completion.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/completion.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: completion.h 12918 2011-09-26 06:18:48Z jordan $
+ * $Id: completion.h 13310 2012-05-20 14:14:59Z jordan $
  */
 
 #ifndef __TRANSMISSION__
@@ -89,12 +89,6 @@
     return cp->sizeNow;
 }
 
-static inline uint64_t
-tr_cpLeftUntilComplete( const tr_completion * cp )
-{
-    return tr_torrentInfo(cp->tor)->totalSize - cp->sizeNow;
-}
-
 static inline bool tr_cpHasAll( const tr_completion * cp )
 {
     return tr_bitfieldHasAll( &cp->blockBitfield );
diff -Naur ./fdlimit.c ../../../tmp/Transmission/libtransmission/fdlimit.c
--- ./fdlimit.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/fdlimit.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: fdlimit.c 12582 2011-07-25 17:48:14Z jordan $
+ * $Id: fdlimit.c 13110 2011-12-14 05:42:15Z jordan $
  */
 
 #ifdef HAVE_POSIX_FADVISE
@@ -478,19 +478,25 @@
 static struct tr_cached_file *
 fileset_get_empty_slot( struct tr_fileset * set )
 {
-    struct tr_cached_file * o;
-    struct tr_cached_file * cull;
+    struct tr_cached_file * cull = NULL;
 
-    /* try to find an unused slot */
-    for( o=set->begin; o!=set->end; ++o )
-        if( !cached_file_is_open( o ) )
-            return o;
+    if( set->begin != NULL )
+    {
+        struct tr_cached_file * o;
+
+        /* try to find an unused slot */
+        for( o=set->begin; o!=set->end; ++o )
+            if( !cached_file_is_open( o ) )
+                return o;
+
+        /* all slots are full... recycle the least recently used */
+        for( cull=NULL, o=set->begin; o!=set->end; ++o )
+            if( !cull || o->used_at < cull->used_at )
+                cull = o;
+
+        cached_file_close( cull );
+    }
 
-    /* all slots are full... recycle the least recently used */
-    for( cull=NULL, o=set->begin; o!=set->end; ++o )
-        if( !cull || o->used_at < cull->used_at )
-            cull = o;
-    cached_file_close( cull );
     return cull;
 }
 
diff -Naur ./inout.c ../../../tmp/Transmission/libtransmission/inout.c
--- ./inout.c	2012-06-21 12:03:07.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/inout.c	2012-07-09 13:11:37.000000000 +0200
@@ -300,7 +300,7 @@
 tr_ioTestPiece( tr_torrent * tor, tr_piece_index_t piece )
 {
     uint8_t hash[SHA_DIGEST_LENGTH];
-    bool  success = recalculateHash( tor, piece, hash );
-    success         = success && !memcmp( hash, tor->info.pieces[piece].hash, SHA_DIGEST_LENGTH );
-    return success;
+
+    return recalculateHash( tor, piece, hash )
+           && !memcmp( hash, tor->info.pieces[piece].hash, SHA_DIGEST_LENGTH );
 }
diff -Naur ./metainfo.c ../../../tmp/Transmission/libtransmission/metainfo.c
--- ./metainfo.c	2012-06-26 12:06:09.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/metainfo.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: metainfo.c 12848 2011-09-06 16:45:48Z jordan $
+ * $Id: metainfo.c 13311 2012-05-20 14:47:18Z jordan $
  */
 
 #include <assert.h>
@@ -48,8 +48,6 @@
     return ret;
 }
 
-
-
 static char*
 getTorrentFilename( const tr_session * session, const tr_info * inf )
 {
@@ -60,12 +58,6 @@
     return filename;
 }
 
-//Use for file replication
-char* 
-getTorrentFilePath( const tr_session * session, const tr_info * inf ){
-    return getTorrentFilename(session, inf);
-}
-
 static char*
 getOldTorrentFilename( const tr_session * session, const tr_info * inf )
 {
@@ -276,38 +268,13 @@
         *walk++ = '\0';
         assert( walk - scrape == (int)alloc_len );
     }
-
-    return scrape;
-}
-
-static char *
-tr_convertAnnounceToFileReplication( const char * announce )
-{
-    char *       fr = NULL;
-    const char * s;
-    
-    /* To derive the scrape URL use the following steps:
-     * Begin with the announce URL. Find the last '/' in it.
-     * If the text immediately following that '/' isn't 'announce'
-     * it will be taken as a sign that that tracker doesn't support
-     * the scrape convention. If it does, substitute 'scrape' for
-     * 'announce' to find the scrape page. */
-    if( ( ( s = strrchr( announce, '/' ) ) ) && !strncmp( ++s, "announce", 8 ) )
+    /* Some torrents with UDP annouce URLs don't have /announce. */
+    else if ( !strncmp( announce, "udp:", 4 ) )
     {
-        const char * prefix = announce;
-        const size_t prefix_len = s - announce;
-        const char * suffix = s + 8;
-        const size_t suffix_len = strlen( suffix );
-        const size_t alloc_len = prefix_len + 6 + suffix_len + 1;
-        char * walk = fr = tr_new( char, alloc_len );
-        memcpy( walk, prefix, prefix_len ); walk += prefix_len;
-        memcpy( walk, "filrep", 6 );        walk += 6;
-        memcpy( walk, suffix, suffix_len ); walk += suffix_len;
-        *walk++ = '\0';
-        assert( walk - fr == (int)alloc_len );
+        scrape = tr_strdup( announce );
     }
-    
-    return fr;
+
+    return scrape;
 }
 
 static const char*
@@ -348,7 +315,6 @@
                         t->tier = validTiers;
                         t->announce = url;
                         t->scrape = tr_convertAnnounceToScrape( url );
-                        t->file_replication = tr_convertAnnounceToFileReplication( url ); //File replication
                         t->id = trackerCount;
 
                         anyAdded = true;
@@ -381,7 +347,6 @@
             trackers[trackerCount].tier = 0;
             trackers[trackerCount].announce = url;
             trackers[trackerCount].scrape = tr_convertAnnounceToScrape( url );
-            trackers[trackerCount].file_replication = tr_convertAnnounceToFileReplication(url);
             trackers[trackerCount].id = 0;
             trackerCount++;
             /*fprintf( stderr, "single announce: [%s]\n", url );*/
diff -Naur ./metainfo.h ../../../tmp/Transmission/libtransmission/metainfo.h
--- ./metainfo.h	2012-06-26 12:09:49.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/metainfo.h	2012-07-09 13:11:37.000000000 +0200
@@ -21,8 +21,6 @@
 
 struct tr_benc;
 
-
-char* getTorrentFilePath( const tr_session * session, const tr_info * inf );
 bool  tr_metainfoParse( const tr_session     * session,
                         const struct tr_benc * benc,
                         tr_info              * setmeInfo,
diff -Naur ./natpmp.c ../../../tmp/Transmission/libtransmission/natpmp.c
--- ./natpmp.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/natpmp.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: natpmp.c 12225 2011-03-24 22:57:39Z jordan $
+ * $Id: natpmp.c 13263 2012-04-07 00:12:57Z jordan $
  */
 
 #include <errno.h>
@@ -17,10 +17,10 @@
 #include <event2/util.h> /* evutil_inet_ntop() */
 
 #define ENABLE_STRNATPMPERR
-#include <libnatpmp/natpmp.h>
+#include "natpmp.h"
 
 #include "transmission.h"
-#include "natpmp.h"
+#include "natpmp_local.h"
 #include "net.h" /* tr_netCloseSocket */
 #include "port-forwarding.h"
 #include "utils.h"
@@ -120,7 +120,7 @@
 
     if( is_enabled && ( nat->state == TR_NATPMP_DISCOVER ) )
     {
-        int val = initnatpmp( &nat->natpmp );
+        int val = initnatpmp( &nat->natpmp, 0, 0 );
         logVal( "initnatpmp", val );
         val = sendpublicaddressrequest( &nat->natpmp );
         logVal( "sendpublicaddressrequest", val );
diff -Naur ./natpmp.h ../../../tmp/Transmission/libtransmission/natpmp.h
--- ./natpmp.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/natpmp.h	1970-01-01 01:00:00.000000000 +0100
@@ -1,34 +0,0 @@
-/*
- * This file Copyright (C) Mnemosyne LLC
- *
- * This file is licensed by the GPL version 2. Works owned by the
- * Transmission project are granted a special exemption to clause 2(b)
- * so that the bulk of its code can remain under the MIT license.
- * This exemption does not extend to derived works not owned by
- * the Transmission project.
- *
- * $Id: natpmp.h 12204 2011-03-22 15:19:54Z jordan $
- */
-
-#ifndef __TRANSMISSION__
-#error only libtransmission should #include this header.
-#endif
-
-#ifndef TR_NATPMP_H
-#define TR_NATPMP_H 1
-
-/**
- * @addtogroup port_forwarding Port Forwarding
- * @{
- */
-
-typedef struct tr_natpmp tr_natpmp;
-
-tr_natpmp * tr_natpmpInit( void );
-
-void tr_natpmpClose( tr_natpmp * );
-
-int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
-
-/* @} */
-#endif
diff -Naur ./natpmp_local.h ../../../tmp/Transmission/libtransmission/natpmp_local.h
--- ./natpmp_local.h	1970-01-01 01:00:00.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/natpmp_local.h	2012-07-09 13:11:37.000000000 +0200
@@ -0,0 +1,34 @@
+/*
+ * This file Copyright (C) Mnemosyne LLC
+ *
+ * This file is licensed by the GPL version 2. Works owned by the
+ * Transmission project are granted a special exemption to clause 2(b)
+ * so that the bulk of its code can remain under the MIT license.
+ * This exemption does not extend to derived works not owned by
+ * the Transmission project.
+ *
+ * $Id: natpmp.h 12204 2011-03-22 15:19:54Z jordan $
+ */
+
+#ifndef __TRANSMISSION__
+#error only libtransmission should #include this header.
+#endif
+
+#ifndef TR_NATPMP_H
+#define TR_NATPMP_H 1
+
+/**
+ * @addtogroup port_forwarding Port Forwarding
+ * @{
+ */
+
+typedef struct tr_natpmp tr_natpmp;
+
+tr_natpmp * tr_natpmpInit( void );
+
+void tr_natpmpClose( tr_natpmp * );
+
+int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
+
+/* @} */
+#endif
diff -Naur ./net.c ../../../tmp/Transmission/libtransmission/net.c
--- ./net.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/net.c	2012-07-09 13:11:37.000000000 +0200
@@ -1,6 +1,6 @@
 /******************************************************************************
  *
- * $Id: net.c 12954 2011-10-08 23:53:27Z jordan $
+ * $Id: net.c 13329 2012-05-30 17:47:29Z jordan $
  *
  * Copyright (c) Transmission authors and contributors
  *
@@ -38,6 +38,8 @@
 
 #include <event2/util.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "fdlimit.h" /* tr_fdSocketClose() */
 #include "net.h"
diff -Naur ./patch.txt ../../../tmp/Transmission/libtransmission/patch.txt
--- ./patch.txt	2012-07-09 13:12:50.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/patch.txt	1970-01-01 01:00:00.000000000 +0100
@@ -1,4552 +0,0 @@
-diff -Naur ./.svn/entries ../../../tmp/Transmission/libtransmission/.svn/entries
---- ./.svn/entries	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/entries	2012-07-09 13:11:37.000000000 +0200
-@@ -1,14 +1,14 @@
- 10
- 
- dir
--13094
-+13380
- svn://svn.transmissionbt.com/Transmission/trunk/libtransmission
- svn://svn.transmissionbt.com/Transmission
- 
- 
- 
--2011-11-12T00:16:04.220620Z
--13084
-+2012-07-01T04:00:27.737233Z
-+13363
- jordan
- has-props
- 
-@@ -32,10 +32,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--2fdac3cfa8edf7fbd672d37212292d72
--2011-03-22T15:19:54.669054Z
--12204
-+2012-07-09T11:11:37.000000Z
-+4e3d08bfef4dee78c1544610e6951d5b
-+2012-07-01T04:00:27.737233Z
-+13363
- jordan
- has-props
- 
-@@ -58,7 +58,7 @@
- 
- 
- 
--6394
-+6437
- 
- peer-io.c
- file
-@@ -66,10 +66,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--9f9fc84908661f1acf98df155e44c77b
--2011-10-08T23:53:27.421088Z
--12954
-+2012-07-09T11:11:37.000000Z
-+332839b59e88db07809e2c2883bcfbcc
-+2012-05-30T17:47:29.269572Z
-+13329
- jordan
- has-props
- 
-@@ -92,7 +92,7 @@
- 
- 
- 
--35155
-+35180
- 
- utils.c
- file
-@@ -100,10 +100,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--8a6d92b3c0d892f0a620deb949abb685
--2011-11-10T03:31:43.242511Z
--13080
-+2012-07-09T11:11:37.000000Z
-+f2ab0dd85404d5adeba9c629e3ee633a
-+2012-07-01T03:05:36.817034Z
-+13362
- jordan
- has-props
- 
-@@ -126,7 +126,7 @@
- 
- 
- 
--41221
-+41745
- 
- history.c
- file
-@@ -134,7 +134,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 7f4941bc7047bc55bcc948f944e73475
- 2011-04-06T23:27:11.111958Z
- 12328
-@@ -168,7 +168,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 75a45350404d9cfa9cde56f8b56609b7
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -202,10 +202,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--8f826812147ac97902faca9a024cbdd7
--2011-09-26T22:50:42.460877Z
--12921
-+2012-07-09T11:11:37.000000Z
-+ff4b3ad3cfc12a7cf74db213ba85e688
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -228,7 +228,7 @@
- 
- 
- 
--73217
-+73268
- 
- torrent.h
- file
-@@ -236,10 +236,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--474cead45454ed80d560e21348402e82
--2011-08-03T23:40:51.974573Z
--12617
-+2012-07-09T11:11:37.000000Z
-+01c66bed198d2e7a7192008e1161c63c
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -262,7 +262,7 @@
- 
- 
- 
--14720
-+14738
- 
- stats.h
- file
-@@ -270,7 +270,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 30863d63fe7b55acacf159879ef2676b
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -304,10 +304,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--76f03dff7489b0d13ef3f5873e8e0ef3
--2011-10-25T21:54:51.793164Z
--13034
-+2012-07-09T11:11:37.000000Z
-+d91855c485f3156f154d48e0b0ba7256
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -330,7 +330,7 @@
- 
- 
- 
--11697
-+11707
- 
- peer-io.h
- file
-@@ -338,7 +338,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 682b5b2cb3f1d21c7ac7ff80a2a27da4
- 2011-04-17T05:22:50.756550Z
- 12365
-@@ -372,10 +372,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--6727cfc851d95aebbccfed921ed771b5
--2011-11-12T00:16:04.220620Z
--13084
-+2012-07-09T11:11:37.000000Z
-+e54fef22781a9caeffa9fc629c69707c
-+2012-07-01T03:05:36.817034Z
-+13362
- jordan
- has-props
- 
-@@ -398,7 +398,7 @@
- 
- 
- 
--18886
-+18949
- 
- history.h
- file
-@@ -406,7 +406,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- be5ac2d1345fa5802bd618c329eb38b2
- 2011-04-06T23:27:11.111958Z
- 12328
-@@ -440,7 +440,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 6878f111d45584f9d1862931b4dad854
- 2011-05-01T19:10:34.309173Z
- 12411
-@@ -474,7 +474,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 7ed06acad95ed2880d1be05ebe770647
- 2011-06-19T18:34:10.617795Z
- 12509
-@@ -502,16 +502,16 @@
- 
- 9059
- 
--history-test.c
-+natpmp_local.h
- file
- 
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--70ac65f50b38815fa4df19bbdb21eb96
--2011-04-06T23:27:11.111958Z
--12328
-+2012-07-09T11:11:37.000000Z
-+3749c09ad96d8b44300c860c2a49a270
-+2012-02-04T01:28:15.182551Z
-+13199
- jordan
- 
- 
-@@ -534,7 +534,7 @@
- 
- 
- 
--1361
-+814
- 
- peer-mgr.c
- file
-@@ -542,10 +542,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--8a83b28188bcafffc115abc3a2e79912
--2011-10-08T23:53:27.421088Z
--12954
-+2012-07-09T11:11:37.000000Z
-+ac327f9b7979d3aa3943a7ed7da3bcdf
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -568,7 +568,41 @@
- 
- 
- 
--118693
-+121448
-+
-+history-test.c
-+file
-+
-+
-+
-+
-+2012-07-09T11:11:37.000000Z
-+70ac65f50b38815fa4df19bbdb21eb96
-+2011-04-06T23:27:11.111958Z
-+12328
-+jordan
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+
-+1361
- 
- peer-mgr.h
- file
-@@ -576,10 +610,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--08c18ed6c8aff4c71dabd0d8b3315889
--2011-07-10T15:24:51.208445Z
--12539
-+2012-07-09T11:11:37.000000Z
-+1c2c0f791a9f013c46098f53d6a25996
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -602,7 +636,7 @@
- 
- 
- 
--7780
-+7807
- 
- tr-getopt.c
- file
-@@ -610,7 +644,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 1636af54d8563e586c7870a7080b35be
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -644,7 +678,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 89a66100126b58fea7e3c738cbb8ea62
- 2011-03-25T05:34:26.857517Z
- 12229
-@@ -678,10 +712,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--c1309ae7bfb606d3b89598ba23138019
--2011-10-14T00:27:14.616222Z
--12982
-+2012-07-09T11:11:37.000000Z
-+67711048cf888552eea9ea8155244602
-+2012-05-22T20:21:00.592134Z
-+13313
- jordan
- has-props
- 
-@@ -704,7 +738,7 @@
- 
- 
- 
--53188
-+53389
- 
- tr-getopt.h
- file
-@@ -712,7 +746,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 5b8acc992e72b6888c4c0e472cc51ff1
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -746,7 +780,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 4747749c9e04045767b644949ed17dac
- 2011-03-25T05:34:26.857517Z
- 12229
-@@ -780,7 +814,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- c412529d289cf882cb493d0c2c63b780
- 2011-03-26T10:22:25.583417Z
- 12237
-@@ -814,10 +848,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--cdd582b7402b491012898b09221d6b71
--2011-05-27T23:28:40.968458Z
--12463
-+2012-07-09T11:11:37.000000Z
-+cdd83bf5cc951437ac10073924027c43
-+2012-02-04T00:34:39.005432Z
-+13198
- jordan
- has-props
- 
-@@ -840,7 +874,7 @@
- 
- 
- 
--44948
-+45339
- 
- ConvertUTF.c
- file
-@@ -848,7 +882,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 3efaecc3c7b9918e36973e5a1e57e928
- 2010-12-27T19:18:17.768319Z
- 11599
-@@ -882,10 +916,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--5225bf48a6742af076fb3eb3651298fa
--2011-09-06T16:45:48.978069Z
--12848
-+2012-07-09T11:11:37.000000Z
-+3126ba1799c25da33c2b64ab120ca85d
-+2012-05-20T14:47:18.714767Z
-+13311
- jordan
- has-props
- 
-@@ -908,7 +942,7 @@
- 
- 
- 
--18668
-+18836
- 
- bencode.h
- file
-@@ -916,7 +950,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 2d6da34b2f95181fbcde56de2cae6084
- 2011-04-27T21:22:08.054333Z
- 12391
-@@ -950,7 +984,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 4d2c4279b06fe4fb392edc8582cc321b
- 2010-12-27T19:18:17.768319Z
- 11599
-@@ -984,7 +1018,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 1518161524df91f6f64a3493f342187f
- 2011-07-31T14:04:43.694012Z
- 12606
-@@ -1018,7 +1052,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- c393c231daffe2b206927f0174971659
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -1052,10 +1086,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--5ed010615c81bda8b1ce391857ee40ac
--2011-10-17T12:44:17.964639Z
--12990
-+2012-07-09T11:11:37.000000Z
-+456a47e078e3b0aad6495ad8ce38545c
-+2012-07-01T01:42:58.877241Z
-+13359
- jordan
- has-props
- 
-@@ -1086,7 +1120,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- dd3b48395b9d9fec90cb277e9a984488
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -1120,7 +1154,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 8a355a7b74ddd362e87e91e0a91d20cd
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -1154,7 +1188,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 3e0fc19435456fc904ce5e3ebdfce4f2
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -1188,7 +1222,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- bf90e0ef224ffd645589a57681c80b94
- 2011-09-25T21:51:50.765744Z
- 12915
-@@ -1222,7 +1256,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- dec3e573343979bdb773521f0705312e
- 2011-04-05T00:59:49.150672Z
- 12314
-@@ -1256,7 +1290,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 39d087b6ea1866eff7a55edb428ccfa3
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -1290,10 +1324,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--8b139362603b2d229acf7dac6fa8a8d6
--2011-10-14T00:27:14.616222Z
--12982
-+2012-07-09T11:11:37.000000Z
-+ddedcae32c34328830fa6a4c5d195fab
-+2012-05-20T14:14:59.877229Z
-+13310
- jordan
- has-props
- 
-@@ -1316,7 +1350,7 @@
- 
- 
- 
--29525
-+29538
- 
- peer-msgs-test.c
- file
-@@ -1324,7 +1358,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 88270b6587f5b0c3646c51babb34d7f1
- 2011-03-25T06:20:12.675677Z
- 12230
-@@ -1358,7 +1392,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 70ac9fde761373d41d0ae5a13b3b50db
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -1392,7 +1426,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- bde86441c755a3fd31f9051c2752be4d
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -1426,10 +1460,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--4a6827c06c78dca68f90afba67c28744
--2011-03-25T01:41:57.030441Z
--12228
-+2012-07-09T11:11:37.000000Z
-+c51f76865b06cc8c737b8e5b36bc6187
-+2012-02-04T01:28:15.182551Z
-+13199
- jordan
- has-props
- 
-@@ -1452,7 +1486,7 @@
- 
- 
- 
--5360
-+5366
- 
- peer-common.h
- file
-@@ -1460,7 +1494,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- ee4236d8973e3f7f49134d9ba018d846
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -1494,7 +1528,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- a7108ad1d8f4477b1ac00afc5c7c1a37
- 2011-04-17T05:22:50.756550Z
- 12365
-@@ -1528,10 +1562,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--0ebbc4c0858ddfe746b576cce4e4d7b6
--2011-07-25T17:48:14.282774Z
--12582
-+2012-07-09T11:11:37.000000Z
-+fb8449a3bf92f4a7a1d46b6ffda0e3ce
-+2011-12-14T05:42:15.548968Z
-+13110
- jordan
- has-props
- 
-@@ -1554,7 +1588,7 @@
- 
- 
- 
--18587
-+18678
- 
- port-forwarding.h
- file
-@@ -1562,7 +1596,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- c602149c64ef18b7ac560551e32a7966
- 2011-03-24T22:45:04.211905Z
- 12224
-@@ -1596,7 +1630,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- a007ab4fa183357b97fbf4f3388a7f4e
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -1630,7 +1664,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 2a01eff1ee8c251aaaacba6ff0c03672
- 2011-07-25T17:48:14.282774Z
- 12582
-@@ -1664,10 +1698,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--d4675b4420ca4db9c57de4735c56376b
--2011-03-24T22:57:39.843676Z
--12225
-+2012-07-09T11:11:37.000000Z
-+0f1bcc2fdb9e1068f9d694988b95c2f4
-+2012-04-07T00:12:57.505729Z
-+13263
- jordan
- has-props
- 
-@@ -1690,7 +1724,7 @@
- 
- 
- 
--7094
-+7096
- 
- rpc-test.c
- file
-@@ -1698,7 +1732,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 102f7b57344cecbadf633d21878265de
- 2009-01-23T18:44:15.611877Z
- 7783
-@@ -1732,7 +1766,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 7a169c824b28b6ab454dd795d37d9a57
- 2009-05-29T19:17:12.297015Z
- 8561
-@@ -1766,7 +1800,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 0b5609247f2979606a3dc16272e749ea
- 2011-07-25T21:30:46.469796Z
- 12587
-@@ -1800,7 +1834,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 75b09cb49dabf1d8d6cbe1f2bbba81f2
- 2011-03-25T05:34:26.857517Z
- 12229
-@@ -1834,7 +1868,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 77ac0f65e46d161ebcd79288ac243e0e
- 2011-03-25T05:34:26.857517Z
- 12229
-@@ -1862,47 +1896,13 @@
- 
- 3496
- 
--natpmp.h
--file
--
--
--
--
--2011-11-15T08:27:22.000000Z
--0ccb0e3f11fce2b34032dbad44dbbd69
--2011-03-22T15:19:54.669054Z
--12204
--jordan
--has-props
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--
--814
--
- torrent-magnet.c
- file
- 
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 56287e4408dfd5463981e2450b04b9cb
- 2011-07-25T22:30:56.494108Z
- 12589
-@@ -1936,7 +1936,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- b76a3ceb83f11cf46f1a2d3482142f90
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -1970,7 +1970,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 4c5e395325a444de262514a42ade8741
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -2004,7 +2004,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 99a59ad14ba3c5ea69a3e9dd018bbbce
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -2038,10 +2038,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--7f82a4b3c6354ea8d33d9101e8c24eb7
--2011-07-22T17:47:08.888688Z
--12575
-+2012-07-09T11:11:37.000000Z
-+74ab4d12383756630d5177fc25963d32
-+2012-05-30T17:47:29.269572Z
-+13329
- jordan
- 
- 
-@@ -2064,7 +2064,7 @@
- 
- 
- 
--9513
-+9538
- 
- webseed.c
- file
-@@ -2072,10 +2072,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--25707357a6ab474b3a03bf00c4258489
--2011-09-12T21:46:15.149914Z
--12860
-+2012-07-09T11:11:37.000000Z
-+151e3ce188c872d024d2749af7312c40
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -2098,7 +2098,7 @@
- 
- 
- 
--18071
-+18237
- 
- tr-udp.h
- file
-@@ -2106,7 +2106,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 5836a1232950fd62d366af8ccd20bab9
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -2140,10 +2140,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--075ac7028dcda7d2837cd8c6c893fb6b
--2011-03-22T15:19:54.669054Z
--12204
-+2012-07-09T11:11:37.000000Z
-+ee9d3316f3374f32125105ab9363dc5b
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -2174,10 +2174,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--3fe56cf6f9d90fc4a9a6324e08d11f45
--2011-03-26T12:06:04.974284Z
--12238
-+2012-07-09T11:11:37.000000Z
-+fee77d24d9d8a6a4d3fe0ef0fa728801
-+2012-05-20T14:14:59.877229Z
-+13310
- jordan
- has-props
- 
-@@ -2200,7 +2200,7 @@
- 
- 
- 
--6869
-+6882
- 
- platform.c
- file
-@@ -2208,7 +2208,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 8e500dc572346cfc63adc75090e9f669
- 2011-08-15T00:10:06.835145Z
- 12684
-@@ -2242,7 +2242,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- a0524a2427605822d8337f9ecaceca8a
- 2011-03-25T01:41:57.030441Z
- 12228
-@@ -2276,7 +2276,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 760d812b8b3af607280989beaf0491fb
- 2011-10-25T15:57:10.648856Z
- 13029
-@@ -2310,10 +2310,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--245445c30646ae0d87c3b5cbfc6158ec
--2011-10-08T23:53:27.421088Z
--12954
-+2012-07-09T11:11:37.000000Z
-+8acd8b238c4a46d3f6f0c33ca0817501
-+2012-05-30T17:47:29.269572Z
-+13329
- jordan
- 
- 
-@@ -2336,7 +2336,7 @@
- 
- 
- 
--5712
-+5737
- 
- trevent.h
- file
-@@ -2344,7 +2344,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 98525ac877c9b5cbf9fdd1cca31cac2a
- 2011-03-25T06:20:12.675677Z
- 12230
-@@ -2378,7 +2378,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- ccfff4ec3e39c6becab53f7a5d4cfbee
- 2011-07-25T17:48:14.282774Z
- 12582
-@@ -2412,11 +2412,11 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--3b1819a5b80982b98ccb50c99c61b806
--2011-08-27T23:54:10.452302Z
--12772
--livings124
-+2012-07-09T11:11:37.000000Z
-+32252ba620d5a22fa271fd9dfb36b205
-+2012-07-01T02:17:35.661037Z
-+13361
-+jordan
- has-props
- 
- 
-@@ -2438,7 +2438,7 @@
- 
- 
- 
--72829
-+72880
- 
- resume.c
- file
-@@ -2446,7 +2446,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 9e6fa3d7a829638417a6820645df972d
- 2011-09-26T22:50:42.460877Z
- 12921
-@@ -2480,10 +2480,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--989731093066e09b08f7116b36295f45
--2011-10-08T23:53:27.421088Z
--12954
-+2012-07-09T11:11:37.000000Z
-+eac9c65fe48a0b2a87c2390f9b51bbfc
-+2012-05-30T17:47:29.269572Z
-+13329
- jordan
- 
- 
-@@ -2506,7 +2506,7 @@
- 
- 
- 
--1663
-+1567
- 
- clients.c
- file
-@@ -2514,10 +2514,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--97ad5c7f8ba3259c4d6288837da71775
--2011-06-16T12:08:52.264217Z
--12502
-+2012-07-09T11:11:37.000000Z
-+9f680a7b9fd81c9bb8e094ca0af415de
-+2011-11-22T03:30:37.563381Z
-+13099
- livings124
- has-props
- 
-@@ -2540,7 +2540,7 @@
- 
- 
- 
--18641
-+19509
- 
- test-peer-id.c
- file
-@@ -2548,7 +2548,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- f23b550f1d431f2dad425f57386f6b39
- 2011-03-10T12:35:23.250148Z
- 12121
-@@ -2582,7 +2582,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 9a88b5a8d65226387e871b68717a51ce
- 2011-03-25T17:42:47.640307Z
- 12234
-@@ -2616,7 +2616,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- dd8472df283c416b669865f06aeb4c2a
- 2011-07-13T03:23:37.535856Z
- 12545
-@@ -2650,7 +2650,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 4f61495aad8b98619d775abeb7e08ccf
- 2011-08-08T16:58:29.160460Z
- 12653
-@@ -2684,10 +2684,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--badd6fc0903c1d0f7acee98cd4b3ba39
--2011-10-14T00:27:14.616222Z
--12982
-+2012-07-09T11:11:37.000000Z
-+00278df59e0965ab955f35e218d1cf60
-+2012-05-20T14:14:59.877229Z
-+13310
- jordan
- has-props
- 
-@@ -2710,7 +2710,7 @@
- 
- 
- 
--15887
-+15743
- 
- resume.h
- file
-@@ -2718,7 +2718,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 72459a3b1af8e1899eec0c24c9fb17d1
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -2752,7 +2752,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- f2b0f7f761d5fefd69c14815e9cca7d8
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -2786,7 +2786,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 01172b8d83824e486560b2a5870cdf76
- 2011-01-29T18:56:53.624656Z
- 11782
-@@ -2820,7 +2820,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- ac9d8d0d7356c3a83fb7af2dcc03fbdd
- 2011-04-01T03:07:43.093392Z
- 12289
-@@ -2854,10 +2854,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--aab0ce0b5bd8bef2e5c32417976c88c1
--2011-09-26T06:18:48.397990Z
--12918
-+2012-07-09T11:11:37.000000Z
-+ad00d7ce1d9bfaf0e6781fa484e8c02d
-+2011-12-22T19:35:13.399513Z
-+13113
- jordan
- has-props
- 
-@@ -2880,7 +2880,7 @@
- 
- 
- 
--8724
-+8478
- 
- bencode-test.c
- file
-@@ -2888,10 +2888,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--184142112dfab2248aeb39c5d6530eec
--2011-04-27T21:22:08.054333Z
--12391
-+2012-07-09T11:11:37.000000Z
-+64a7b52d618bca3942c5a7c5754c1ed5
-+2011-12-14T05:44:15.747214Z
-+13111
- jordan
- has-props
- 
-@@ -2914,7 +2914,7 @@
- 
- 
- 
--15454
-+15436
- 
- utils-test.c
- file
-@@ -2922,7 +2922,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- d91edfc840d1910f523093e9817c8124
- 2011-04-05T22:21:18.466613Z
- 12324
-@@ -2956,10 +2956,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--d59b59212c5027c8642337a1ca86ffb2
--2011-07-10T15:24:51.208445Z
--12539
-+2012-07-09T11:11:37.000000Z
-+e1567c43ebbc9f0dfe34f98371cc6a12
-+2012-03-04T13:21:42.735450Z
-+13245
- jordan
- has-props
- 
-@@ -2982,7 +2982,7 @@
- 
- 
- 
--17018
-+17905
- 
- json.h
- file
-@@ -2990,7 +2990,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 4e7c526129d8df2b52380301152ecd29
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -3024,7 +3024,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 52f70efae023c2c819b394192290c8fe
- 2011-03-24T21:49:42.822908Z
- 12223
-@@ -3058,10 +3058,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--db35961be7560cbff273a6dee33c8c32
--2011-09-26T06:18:48.397990Z
--12918
-+2012-07-09T11:11:37.000000Z
-+aa747527eac058b8b4d9e9771ae4d7a4
-+2012-05-20T14:14:59.877229Z
-+13310
- jordan
- has-props
- 
-@@ -3084,7 +3084,7 @@
- 
- 
- 
--3739
-+3599
- 
- crypto.c
- file
-@@ -3092,7 +3092,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 77ed9b1552a75ecd6ef6103b8e281fd9
- 2011-09-16T22:55:58.143184Z
- 12885
-@@ -3126,7 +3126,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 06fc40c4449b2a39f45be61ecd33ec79
- 2011-09-28T16:07:35.175691Z
- 12932
-@@ -3160,7 +3160,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 258303f3327ef63a2c624616858294bb
- 2011-10-09T14:51:13.974182Z
- 12958
-@@ -3194,7 +3194,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 1dd5ed34da3a8380fcdfa8b60e710e51
- 2011-07-10T15:24:51.208445Z
- 12539
-@@ -3228,10 +3228,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--fe034fbdd3adbcb5d115308030bb86ab
--2011-08-08T16:29:47.714029Z
--12649
-+2012-07-09T11:11:37.000000Z
-+1a629c293269c7205b421d7b88f22de6
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -3254,7 +3254,7 @@
- 
- 
- 
--79252
-+79340
- 
- makemeta.c
- file
-@@ -3262,7 +3262,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 73a7056a935b40c86ec79a15ee46364e
- 2011-07-24T20:18:33.631478Z
- 12581
-@@ -3296,7 +3296,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 8ff965efc95843404dd95638d9b8b8f1
- 2011-03-24T21:49:42.822908Z
- 12223
-@@ -3330,7 +3330,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 9d9f3e6265eab3b9ef7d3cddc8ac95fc
- 2011-04-17T05:22:50.756550Z
- 12365
-@@ -3364,10 +3364,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--b4853b81e89e18907ab51fe3c1964c3b
--2011-10-08T23:53:27.421088Z
--12954
-+2012-07-09T11:11:37.000000Z
-+b8f81a65d080ed1c196ee5c34e90d94e
-+2012-05-30T17:47:29.269572Z
-+13329
- jordan
- has-props
- 
-@@ -3390,7 +3390,7 @@
- 
- 
- 
--18556
-+18581
- 
- json-test.c
- file
-@@ -3398,7 +3398,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 264ac8d8e2c8a688a9d915265ebcbb73
- 2010-04-15T19:27:47.309611Z
- 10487
-@@ -3432,7 +3432,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 34e41000344e3a3bc1bd37fdbc3ca614
- 2011-09-26T22:50:42.460877Z
- 12921
-@@ -3466,7 +3466,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 40647691a67207d3d1f9e6b809064625
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -3500,7 +3500,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 80500da4a1436f790de8eab153a5e4ca
- 2009-11-29T17:49:58.643028Z
- 9630
-@@ -3534,10 +3534,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--54a6ccd1ff09d5b02834768b3c732958
--2011-10-09T02:05:52.894699Z
--12957
-+2012-07-09T11:11:37.000000Z
-+f05e0ea54b8c226697afda60d0c5418f
-+2012-02-04T01:28:15.182551Z
-+13199
- jordan
- 
- 
-@@ -3560,7 +3560,7 @@
- 
- 
- 
--3722
-+3675
- 
- rpc-server.c
- file
-@@ -3568,11 +3568,11 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--7725fc7b86bf79900a25b2251f29b5c3
--2011-09-27T22:34:52.475604Z
--12930
--livings124
-+2012-07-09T11:11:37.000000Z
-+6d18c674c0ad0504e9654c84cbdbf4a8
-+2012-02-15T01:44:21.476797Z
-+13226
-+jordan
- has-props
- 
- 
-@@ -3594,7 +3594,7 @@
- 
- 
- 
--30423
-+30441
- 
- session.h
- file
-@@ -3602,10 +3602,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--15ef478484e50ab3aa87bed380ae9466
--2011-08-07T19:24:33.958969Z
--12640
-+2012-07-09T11:11:37.000000Z
-+688e923b72455aa36c5250292f150886
-+2012-07-01T02:17:35.661037Z
-+13361
- jordan
- has-props
- 
-@@ -3628,7 +3628,7 @@
- 
- 
- 
--9904
-+9956
- 
- makemeta.h
- file
-@@ -3636,7 +3636,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 14ed3e7b7dc3a7ec70e807abd74a696f
- 2011-01-19T13:48:47.518794Z
- 11709
-@@ -3670,7 +3670,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 45ce41fcfdba4f1decc7607a8738f380
- 2010-12-27T19:18:17.768319Z
- 11599
-@@ -3704,7 +3704,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 555ea8eacc79bff586a7984779fe45b5
- 2011-03-25T05:34:26.857517Z
- 12229
-@@ -3738,7 +3738,7 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
-+2012-07-09T11:11:37.000000Z
- 12617db66e49c904a834156017e510c1
- 2011-03-22T15:19:54.669054Z
- 12204
-@@ -3772,10 +3772,10 @@
- 
- 
- 
--2011-11-15T08:27:22.000000Z
--e482aebb87c4696435ce833bca10dd3a
--2011-11-10T03:31:43.242511Z
--13080
-+2012-07-09T11:11:37.000000Z
-+4fbb7eebc30d525279373188a8e76139
-+2012-07-01T03:05:36.817034Z
-+13362
- jordan
- has-props
- 
-@@ -3798,5 +3798,5 @@
- 
- 
- 
--89284
-+88891
- 
-diff -Naur ./.svn/prop-base/natpmp.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/prop-base/natpmp.h.svn-base
---- ./.svn/prop-base/natpmp.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/prop-base/natpmp.h.svn-base	1970-01-01 01:00:00.000000000 +0100
-@@ -1,5 +0,0 @@
--K 12
--svn:keywords
--V 18
--Date Rev Author Id
--END
-diff -Naur ./.svn/text-base/Makefile.am.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/Makefile.am.svn-base
---- ./.svn/text-base/Makefile.am.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/Makefile.am.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -1,7 +1,5 @@
- AM_CPPFLAGS = \
--    -I. \
-     -I$(top_srcdir) \
--    -I$(top_srcdir)/third-party/ \
-     -D__TRANSMISSION__ \
-     -DPACKAGE_DATA_DIR=\""$(datadir)"\"
- 
-@@ -9,6 +7,7 @@
-     @DHT_CFLAGS@ \
-     @LIBUTP_CFLAGS@ \
-     @LIBUPNP_CFLAGS@ \
-+    @LIBNATPMP_CFLAGS@ \
-     @LIBEVENT_CFLAGS@ \
-     @LIBCURL_CFLAGS@ \
-     @OPENSSL_CFLAGS@ \
-@@ -91,7 +90,7 @@
-     magnet.h \
-     makemeta.h \
-     metainfo.h \
--    natpmp.h \
-+    natpmp_local.h \
-     net.h \
-     peer-common.h \
-     peer-io.h \
-@@ -141,7 +140,7 @@
- apps_ldadd = \
-     ./libtransmission.a  \
-     @LIBUPNP_LIBS@ \
--    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
-+    @LIBNATPMP_LIBS@ \
-     @INTLLIBS@ \
-     @DHT_LIBS@ \
-     @LIBUTP_LIBS@ \
-diff -Naur ./.svn/text-base/announcer-common.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-common.h.svn-base
---- ./.svn/text-base/announcer-common.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-common.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -148,7 +148,7 @@
-     uint64_t corrupt;
- 
-     /* the total size of the torrent minus the number of bytes completed */
--    uint64_t left;
-+    uint64_t leftUntilComplete;
- 
-     /* the tracker's announce URL */
-     char * url;
-diff -Naur ./.svn/text-base/announcer-http.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-http.c.svn-base
---- ./.svn/text-base/announcer-http.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-http.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -50,7 +50,7 @@
-     return tr_announce_event_get_string( req->event );
- }
- 
--static struct evbuffer *
-+static char*
- announce_url_new( const tr_session * session, const tr_announce_request * req )
- {
-     const char * str;
-@@ -81,7 +81,7 @@
-                               req->port,
-                               req->up,
-                               req->down,
--                              req->left,
-+                              req->leftUntilComplete,
-                               req->numwant,
-                               req->key );
- 
-@@ -116,7 +116,7 @@
-         tr_http_escape( buf, ipv6_readable, -1, true );
-     }
- 
--    return buf;
-+    return evbuffer_free_to_str( buf );
- }
- 
- static tr_pex*
-@@ -287,8 +287,7 @@
-                           void                       * response_func_user_data )
- {
-     struct announce_data * d;
--    struct evbuffer * buf = announce_url_new( session, request );
--    const char * url = (const char *) evbuffer_pullup( buf, -1 );
-+    char * url = announce_url_new( session, request );
- 
-     d = tr_new0( struct announce_data, 1 );
-     d->response.seeders = -1;
-@@ -302,7 +301,7 @@
-     dbgmsg( request->log_name, "Sending announce to libcurl: \"%s\"", url );
-     tr_webRun( session, url, NULL, NULL, on_announce_done, d );
- 
--    evbuffer_free( buf );
-+    tr_free( url );
- }
- 
- /****
-@@ -363,7 +362,7 @@
-         tr_benc * flags;
-         const char * str;
-         const int benc_loaded = !tr_bencLoad( msg, msglen, &top, NULL );
--        
-+
-         if( getenv( "TR_CURL_VERBOSE" ) != NULL )
-         {
-             if( !benc_loaded )
-@@ -378,7 +377,7 @@
-                 tr_free( str );
-             }
-         }
--        
-+
-         if( benc_loaded )
-         {
-             if( tr_bencDictFindStr( &top, "failure reason", &str ) )
-@@ -429,7 +428,7 @@
-     tr_runInEventThread( session, on_scrape_done_eventthread, data );
- }
- 
--static struct evbuffer *
-+static char *
- scrape_url_new( const tr_scrape_request * req )
- {
-     int i;
-@@ -446,7 +445,7 @@
-         delimiter = '&';
-     }
- 
--    return buf;
-+    return evbuffer_free_to_str( buf );
- }
- 
- void
-@@ -457,8 +456,7 @@
- {
-     int i;
-     struct scrape_data * d;
--    struct evbuffer * buf = scrape_url_new( request );
--    const char * url = (const char *) evbuffer_pullup( buf, -1 );
-+    char * url = scrape_url_new( request );
- 
-     d = tr_new0( struct scrape_data, 1 );
-     d->response.url = tr_strdup( request->url );
-@@ -477,5 +475,5 @@
-     dbgmsg( request->log_name, "Sending scrape to libcurl: \"%s\"", url );
-     tr_webRun( session, url, NULL, NULL, on_scrape_done, d );
- 
--    evbuffer_free( buf );
-+    tr_free( url );
- }
-diff -Naur ./.svn/text-base/announcer-udp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-udp.c.svn-base
---- ./.svn/text-base/announcer-udp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer-udp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -323,7 +323,7 @@
-     evbuffer_add        ( buf, in->info_hash, SHA_DIGEST_LENGTH );
-     evbuffer_add        ( buf, in->peer_id, PEER_ID_LEN );
-     evbuffer_add_hton_64( buf, in->down );
--    evbuffer_add_hton_64( buf, in->left );
-+    evbuffer_add_hton_64( buf, in->leftUntilComplete );
-     evbuffer_add_hton_64( buf, in->up );
-     evbuffer_add_hton_32( buf, get_tau_announce_event( in->event ) );
-     evbuffer_add_hton_32( buf, 0 );
-diff -Naur ./.svn/text-base/announcer.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer.c.svn-base
---- ./.svn/text-base/announcer.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/announcer.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -753,6 +753,7 @@
-     {
-         int i;
-         char name[128];
-+        char * message;
-         struct evbuffer * buf = evbuffer_new( );
- 
-         tier_build_log_name( tier, name, sizeof( name ) );
-@@ -763,8 +764,9 @@
-             evbuffer_add_printf( buf, "[%d:%s]", i, str );
-         }
- 
--        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", evbuffer_pullup( buf, -1 ) );
--        evbuffer_free( buf );
-+        message = evbuffer_free_to_str( buf );
-+        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", message );
-+        tr_free( message );
-     }
- }
- 
-@@ -910,7 +912,9 @@
-     req->up = tier->byteCounts[TR_ANN_UP];
-     req->down = tier->byteCounts[TR_ANN_DOWN];
-     req->corrupt = tier->byteCounts[TR_ANN_CORRUPT];
--    req->left = tr_cpLeftUntilComplete( &tor->completion ),
-+    req->leftUntilComplete = tr_torrentHasMetadata( tor )
-+            ? tor->info.totalSize - tr_cpHaveTotal( &tor->completion )
-+            : ~(uint64_t)0;
-     req->event = event;
-     req->numwant = event == TR_ANNOUNCE_EVENT_STOPPED ? 0 : NUMWANT;
-     req->key = announcer->key;
-@@ -1139,7 +1143,7 @@
- 
-             /* if the tracker included scrape fields in its announce response,
-                then a separate scrape isn't needed */
--            if( scrape_fields >= 3 )
-+            if( ( scrape_fields >= 3 ) || ( !tracker->scrape && ( scrape_fields >= 1 ) ) )
-             {
-                 tr_tordbg( tier->tor, "Announce response contained scrape info; "
-                                       "rescheduling next scrape to %d seconds from now.",
-diff -Naur ./.svn/text-base/bandwidth.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/bandwidth.c.svn-base
---- ./.svn/text-base/bandwidth.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/bandwidth.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -174,8 +174,8 @@
-     /* set the available bandwidth */
-     if( b->band[dir].isLimited )
-     {
--        const unsigned int nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
--        b->band[dir].bytesLeft = ( nextPulseSpeed * period_msec ) / 1000u;
-+        const uint64_t nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
-+        b->band[dir].bytesLeft = (unsigned int)( nextPulseSpeed * period_msec ) / 1000u;
-     }
- 
-     /* add this bandwidth's peer, if any, to the peer pool */
-diff -Naur ./.svn/text-base/bencode-test.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode-test.c.svn-base
---- ./.svn/text-base/bencode-test.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode-test.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -319,8 +319,8 @@
-                  const char * expected )
- {
-     tr_benc top;
--    struct evbuffer * buf = evbuffer_new( );
-     char * serialized;
-+    struct evbuffer * buf;
- 
-     tr_bencLoad( benc_str, strlen( benc_str ), &top, NULL );
-     buf = tr_bencToBuf( &top, TR_FMT_JSON );
-diff -Naur ./.svn/text-base/bencode.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode.c.svn-base
---- ./.svn/text-base/bencode.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/bencode.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -1593,6 +1593,16 @@
-                     tr_bencListCopy( tr_bencDictAddList( target, key, tr_bencListSize( val ) ), val );
-                 }
-             }
-+            else if( tr_bencIsDict( val ) )
-+            {
-+                tr_benc * target_dict = tr_bencDictFind( target, key );
-+
-+                if( target_dict == NULL )
-+                    target_dict = tr_bencDictAddDict( target, key, tr_bencDictSize( val ) );
-+
-+                if( tr_bencIsDict( target_dict ) )
-+                    tr_bencMergeDicts( target_dict, val );
-+            }
-             else
-             {
-                 tr_dbg( "tr_bencMergeDicts skipping \"%s\"", key );
-diff -Naur ./.svn/text-base/clients.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/clients.c.svn-base
---- ./.svn/text-base/clients.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/clients.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -304,6 +304,29 @@
-             return;
-     }
- 
-+    /* uTorrent will replace the trailing dash with an extra digit for longer version numbers */
-+    if( id[0] == '-' )
-+    {
-+        if( !memcmp( id+1, "UT", 2 ) )
-+        {
-+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent %d.%d.%d%s",
-+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
-+        }
-+        else if( !memcmp( id+1, "UM", 2 ) )
-+        {
-+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Mac %d.%d.%d%s",
-+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
-+        }
-+        else if( !memcmp( id+1, "UE", 2 ) )
-+        {
-+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Embedded %d.%d.%d%s",
-+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
-+        }
-+
-+        if( *buf )
-+            return;
-+    }
-+
-     /* Mainline */
-     if( isMainlineStyle( id ) )
-     {
-diff -Naur ./.svn/text-base/completion.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.c.svn-base
---- ./.svn/text-base/completion.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -165,19 +165,13 @@
-                 }
-                 else
-                 {
--                    uint64_t o = 0;
--                    tr_block_index_t b, f, l;
-+                    tr_block_index_t f, l;
-                     tr_torGetPieceBlockRange( cp->tor, p, &f, &l );
--                    for( b=f; b<=l; ++b )
--                        if( tr_cpBlockIsComplete( cp, b ) )
--                            n += tr_torBlockCountBytes( tor, b );
- 
--                    o = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
--                    o *= cp->tor->blockSize;
-+                    n = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
-+                    n *= cp->tor->blockSize;
-                     if( l == ( cp->tor->blockCount - 1 )  && tr_bitfieldHas( &cp->blockBitfield, l ) )
--                        o -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
--
--                    assert( n == o );
-+                        n -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
-                 }
- 
-                 assert( n <= tr_torPieceCountBytes( tor, p ) );
-diff -Naur ./.svn/text-base/completion.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.h.svn-base
---- ./.svn/text-base/completion.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/completion.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -89,12 +89,6 @@
-     return cp->sizeNow;
- }
- 
--static inline uint64_t
--tr_cpLeftUntilComplete( const tr_completion * cp )
--{
--    return tr_torrentInfo(cp->tor)->totalSize - cp->sizeNow;
--}
--
- static inline bool tr_cpHasAll( const tr_completion * cp )
- {
-     return tr_bitfieldHasAll( &cp->blockBitfield );
-diff -Naur ./.svn/text-base/fdlimit.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/fdlimit.c.svn-base
---- ./.svn/text-base/fdlimit.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/fdlimit.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -478,19 +478,25 @@
- static struct tr_cached_file *
- fileset_get_empty_slot( struct tr_fileset * set )
- {
--    struct tr_cached_file * o;
--    struct tr_cached_file * cull;
-+    struct tr_cached_file * cull = NULL;
-+
-+    if( set->begin != NULL )
-+    {
-+        struct tr_cached_file * o;
-+
-+        /* try to find an unused slot */
-+        for( o=set->begin; o!=set->end; ++o )
-+            if( !cached_file_is_open( o ) )
-+                return o;
-+
-+        /* all slots are full... recycle the least recently used */
-+        for( cull=NULL, o=set->begin; o!=set->end; ++o )
-+            if( !cull || o->used_at < cull->used_at )
-+                cull = o;
-+
-+        cached_file_close( cull );
-+    }
- 
--    /* try to find an unused slot */
--    for( o=set->begin; o!=set->end; ++o )
--        if( !cached_file_is_open( o ) )
--            return o;
--
--    /* all slots are full... recycle the least recently used */
--    for( cull=NULL, o=set->begin; o!=set->end; ++o )
--        if( !cull || o->used_at < cull->used_at )
--            cull = o;
--    cached_file_close( cull );
-     return cull;
- }
- 
-diff -Naur ./.svn/text-base/metainfo.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/metainfo.c.svn-base
---- ./.svn/text-base/metainfo.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/metainfo.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -268,6 +268,11 @@
-         *walk++ = '\0';
-         assert( walk - scrape == (int)alloc_len );
-     }
-+    /* Some torrents with UDP annouce URLs don't have /announce. */
-+    else if ( !strncmp( announce, "udp:", 4 ) )
-+    {
-+        scrape = tr_strdup( announce );
-+    }
- 
-     return scrape;
- }
-diff -Naur ./.svn/text-base/natpmp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.c.svn-base
---- ./.svn/text-base/natpmp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -17,10 +17,10 @@
- #include <event2/util.h> /* evutil_inet_ntop() */
- 
- #define ENABLE_STRNATPMPERR
--#include <libnatpmp/natpmp.h>
-+#include "natpmp.h"
- 
- #include "transmission.h"
--#include "natpmp.h"
-+#include "natpmp_local.h"
- #include "net.h" /* tr_netCloseSocket */
- #include "port-forwarding.h"
- #include "utils.h"
-@@ -120,7 +120,7 @@
- 
-     if( is_enabled && ( nat->state == TR_NATPMP_DISCOVER ) )
-     {
--        int val = initnatpmp( &nat->natpmp );
-+        int val = initnatpmp( &nat->natpmp, 0, 0 );
-         logVal( "initnatpmp", val );
-         val = sendpublicaddressrequest( &nat->natpmp );
-         logVal( "sendpublicaddressrequest", val );
-diff -Naur ./.svn/text-base/natpmp.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.h.svn-base
---- ./.svn/text-base/natpmp.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp.h.svn-base	1970-01-01 01:00:00.000000000 +0100
-@@ -1,34 +0,0 @@
--/*
-- * This file Copyright (C) Mnemosyne LLC
-- *
-- * This file is licensed by the GPL version 2. Works owned by the
-- * Transmission project are granted a special exemption to clause 2(b)
-- * so that the bulk of its code can remain under the MIT license.
-- * This exemption does not extend to derived works not owned by
-- * the Transmission project.
-- *
-- * $Id$
-- */
--
--#ifndef __TRANSMISSION__
--#error only libtransmission should #include this header.
--#endif
--
--#ifndef TR_NATPMP_H
--#define TR_NATPMP_H 1
--
--/**
-- * @addtogroup port_forwarding Port Forwarding
-- * @{
-- */
--
--typedef struct tr_natpmp tr_natpmp;
--
--tr_natpmp * tr_natpmpInit( void );
--
--void tr_natpmpClose( tr_natpmp * );
--
--int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
--
--/* @} */
--#endif
-diff -Naur ./.svn/text-base/natpmp_local.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp_local.h.svn-base
---- ./.svn/text-base/natpmp_local.h.svn-base	1970-01-01 01:00:00.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/natpmp_local.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -0,0 +1,34 @@
-+/*
-+ * This file Copyright (C) Mnemosyne LLC
-+ *
-+ * This file is licensed by the GPL version 2. Works owned by the
-+ * Transmission project are granted a special exemption to clause 2(b)
-+ * so that the bulk of its code can remain under the MIT license.
-+ * This exemption does not extend to derived works not owned by
-+ * the Transmission project.
-+ *
-+ * $Id: natpmp.h 12204 2011-03-22 15:19:54Z jordan $
-+ */
-+
-+#ifndef __TRANSMISSION__
-+#error only libtransmission should #include this header.
-+#endif
-+
-+#ifndef TR_NATPMP_H
-+#define TR_NATPMP_H 1
-+
-+/**
-+ * @addtogroup port_forwarding Port Forwarding
-+ * @{
-+ */
-+
-+typedef struct tr_natpmp tr_natpmp;
-+
-+tr_natpmp * tr_natpmpInit( void );
-+
-+void tr_natpmpClose( tr_natpmp * );
-+
-+int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
-+
-+/* @} */
-+#endif
-diff -Naur ./.svn/text-base/net.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/net.c.svn-base
---- ./.svn/text-base/net.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/net.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -38,6 +38,8 @@
- 
- #include <event2/util.h>
- 
-+#include <libutp/utp.h>
-+
- #include "transmission.h"
- #include "fdlimit.h" /* tr_fdSocketClose() */
- #include "net.h"
-diff -Naur ./.svn/text-base/peer-io.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-io.c.svn-base
---- ./.svn/text-base/peer-io.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-io.c.svn-base	2012-07-09 13:11:36.000000000 +0200
-@@ -18,6 +18,8 @@
- #include <event2/buffer.h>
- #include <event2/bufferevent.h>
- 
-+#include <libutp/utp.h>
-+
- #include "transmission.h"
- #include "session.h"
- #include "bandwidth.h"
-diff -Naur ./.svn/text-base/peer-mgr.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.c.svn-base
---- ./.svn/text-base/peer-mgr.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -18,6 +18,8 @@
- 
- #include <event2/event.h>
- 
-+#include <libutp/utp.h>
-+
- #include "transmission.h"
- #include "announcer.h"
- #include "bandwidth.h"
-@@ -2492,11 +2494,21 @@
-         const float true_count = tr_bitfieldCountTrueBits( have );
- 
-         if( tr_torrentHasMetadata( tor ) )
-+        {
-             peer->progress = true_count / tor->info.pieceCount;
-+        }
-         else /* without pieceCount, this result is only a best guess... */
-+        {
-             peer->progress = true_count / ( have->bit_count + 1 );
-+        }
-     }
- 
-+    /* clamp the progress range */
-+    if ( peer->progress < 0.0 )
-+        peer->progress = 0.0;
-+    if ( peer->progress > 1.0 )
-+        peer->progress = 1.0;
-+
-     if( peer->atom && ( peer->progress >= 1.0 ) )
-         atomSetSeed( tor->torrentPeers, peer->atom );
- }
-@@ -2664,7 +2676,7 @@
-     assert( webseedCount == tor->info.webseedCount );
- 
-     for( i=0; i<webseedCount; ++i ) {
--        int Bps;
-+        unsigned int Bps;
-         if( tr_webseedGetSpeed_Bps( webseeds[i], now, &Bps ) )
-             ret[i] = Bps / (double)tr_speed_K;
-         else
-@@ -2674,7 +2686,7 @@
-     return ret;
- }
- 
--int
-+unsigned int
- tr_peerGetPieceSpeed_Bps( const tr_peer * peer, uint64_t now, tr_direction direction )
- {
-     return peer->io ? tr_peerIoGetPieceSpeed_Bps( peer->io, now, direction ) : 0.0;
-@@ -3011,7 +3023,7 @@
- static int
- getRate( const tr_torrent * tor, struct peer_atom * atom, uint64_t now )
- {
--    int Bps;
-+    unsigned int Bps;
- 
-     if( tr_torrentIsSeed( tor ) )
-         Bps = tr_peerGetPieceSpeed_Bps( atom->peer, now, TR_CLIENT_TO_PEER );
-@@ -3037,8 +3049,8 @@
-     if( !tr_bandwidthIsLimited( b, dir ) )
-         return false;
-     else {
--        const int got = tr_bandwidthGetPieceSpeed_Bps( b, now_msec, dir );
--        const int want = tr_bandwidthGetDesiredSpeed_Bps( b, dir );
-+        const unsigned int got = tr_bandwidthGetPieceSpeed_Bps( b, now_msec, dir );
-+        const unsigned int want = tr_bandwidthGetDesiredSpeed_Bps( b, dir );
-         return got >= want;
-     }
- }
-@@ -3832,22 +3844,105 @@
-     return score;
- }
- 
--/* sort an array of peer candidates */
-+#ifndef NDEBUG
- static int
--comparePeerCandidates( const void * va, const void * vb )
-+checkPartition( const struct peer_candidate * candidates, int left, int right, uint64_t pivotScore, int storeIndex )
- {
--    const struct peer_candidate * a = va;
--    const struct peer_candidate * b = vb;
-+    int i;
- 
--    if( a->score < b->score ) return -1;
--    if( a->score > b->score ) return 1;
-+    assert( storeIndex >= left );
-+    assert( storeIndex <= right );
-+    assert( candidates[storeIndex].score == pivotScore );
-+
-+    for( i=left; i<storeIndex; ++i )
-+        assert( candidates[i].score < pivotScore );
-+    for( i=storeIndex+1; i<=right; ++i )
-+        assert( candidates[i].score >= pivotScore );
- 
--    return 0;
-+    return true;
- }
-+#endif
-+
-+/* Helper to selectBestCandidates().
-+ * Adapted from http://en.wikipedia.org/wiki/Selection_algorithm */
-+static int
-+partitionPeerCandidates( struct peer_candidate * candidates, int left, int right, int pivotIndex )
-+{
-+    int i;
-+    int storeIndex;
-+    struct peer_candidate tmp;
-+    const struct peer_candidate pivotValue = candidates[pivotIndex];
-+
-+    /* move pivot to end */
-+    tmp = candidates[right];
-+    candidates[right] = pivotValue;
-+    candidates[pivotIndex] = tmp;
-+
-+    storeIndex = left;
-+    for( i=left; i<=right; ++i )
-+    {
-+        if( candidates[i].score < pivotValue.score )
-+        {
-+            tmp = candidates[storeIndex];
-+            candidates[storeIndex] = candidates[i];
-+            candidates[i] = tmp;
-+            storeIndex++;
-+        }
-+    }
-+
-+    /* move pivot to its final place */
-+    tmp = candidates[right];
-+    candidates[right] = candidates[storeIndex];
-+    candidates[storeIndex] = tmp;
-+
-+    /* sanity check */
-+    assert( checkPartition( candidates, left, right, pivotValue.score, storeIndex ) );
-+
-+    return storeIndex;
-+}
-+
-+/* Adapted from http://en.wikipedia.org/wiki/Selection_algorithm */
-+static void
-+selectPeerCandidates( struct peer_candidate * candidates, int left, int right, int k )
-+{
-+    if( right > left )
-+    {
-+        const int pivotIndex = left + (right-left)/2;
-+
-+        int pivotNewIndex = partitionPeerCandidates( candidates, left, right, pivotIndex );
-+
-+        if( pivotNewIndex > left + k ) /* new condition */
-+            selectPeerCandidates( candidates, left, pivotNewIndex-1, k );
-+        else if( pivotNewIndex < left + k )
-+            selectPeerCandidates( candidates, pivotNewIndex+1, right, k+left-pivotNewIndex-1 );
-+    }
-+}
-+
-+#ifndef NDEBUG
-+static bool
-+checkBestScoresComeFirst( const struct peer_candidate * candidates, int n, int k )
-+{
-+    int i;
-+    uint64_t worstFirstScore = 0;
-+    const int x = MIN( n, k ) - 1;
-+
-+    for( i=0; i<x; i++ )
-+        if( worstFirstScore < candidates[i].score )
-+            worstFirstScore = candidates[i].score;
-+
-+    for( i=0; i<x; i++ )
-+        assert( candidates[i].score <= worstFirstScore );
-+
-+    for( i=x+1; i<n; i++ )
-+        assert( candidates[i].score >= worstFirstScore );
-+
-+    return true;
-+}
-+#endif /* NDEBUG */
- 
- /** @return an array of all the atoms we might want to connect to */
- static struct peer_candidate*
--getPeerCandidates( tr_session * session, int * candidateCount )
-+getPeerCandidates( tr_session * session, int * candidateCount, int max )
- {
-     int atomCount;
-     int peerCount;
-@@ -3912,8 +4007,11 @@
-     }
- 
-     *candidateCount = walk - candidates;
--    if( *candidateCount > 1 )
--        qsort( candidates, *candidateCount, sizeof( struct peer_candidate ), comparePeerCandidates );
-+    if( walk != candidates )
-+        selectPeerCandidates( candidates, 0, (walk-candidates)-1, max );
-+
-+    assert( checkBestScoresComeFirst( candidates, *candidateCount, max ) );
-+
-     return candidates;
- }
- 
-@@ -3990,7 +4088,7 @@
-     int i, n;
-     struct peer_candidate * candidates;
- 
--    candidates = getPeerCandidates( mgr->session, &n );
-+    candidates = getPeerCandidates( mgr->session, &n, max );
- 
-     for( i=0; i<n && i<max; ++i )
-         initiateCandidateConnection( mgr, &candidates[i] );
-diff -Naur ./.svn/text-base/peer-mgr.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.h.svn-base
---- ./.svn/text-base/peer-mgr.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-mgr.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -248,9 +248,9 @@
- double* tr_peerMgrWebSpeeds_KBps( const tr_torrent * tor );
- 
- 
--int tr_peerGetPieceSpeed_Bps( const tr_peer    * peer,
--                              uint64_t           now,
--                              tr_direction       direction );
-+unsigned int tr_peerGetPieceSpeed_Bps( const tr_peer    * peer,
-+                                       uint64_t           now,
-+                                       tr_direction       direction );
- 
- void tr_peerMgrClearInterest( tr_torrent * tor );
- 
-diff -Naur ./.svn/text-base/peer-msgs.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-msgs.c.svn-base
---- ./.svn/text-base/peer-msgs.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/peer-msgs.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -16,8 +16,6 @@
- #include <stdlib.h>
- #include <string.h>
- 
--#include <alloca.h>
--
- #include <event2/buffer.h>
- #include <event2/bufferevent.h>
- #include <event2/event.h>
-@@ -241,6 +239,7 @@
-         char              timestr[64];
-         struct evbuffer * buf = evbuffer_new( );
-         char *            base = tr_basename( file );
-+        char *            message;
- 
-         evbuffer_add_printf( buf, "[%s] %s - %s [%s]: ",
-                              tr_getLogTimeStr( timestr, sizeof( timestr ) ),
-@@ -251,10 +250,12 @@
-         evbuffer_add_vprintf( buf, fmt, args );
-         va_end( args );
-         evbuffer_add_printf( buf, " (%s:%d)\n", base, line );
--        fputs( (const char*)evbuffer_pullup( buf, -1 ), fp );
-+
-+        message = evbuffer_free_to_str( buf );
-+        fputs( message, fp );
- 
-         tr_free( base );
--        evbuffer_free( buf );
-+        tr_free( message );
-     }
- }
- 
-@@ -1675,8 +1676,8 @@
-     else
-     {
-         int estimatedBlocksInPeriod;
--        int rate_Bps;
--        int irate_Bps;
-+        unsigned int rate_Bps;
-+        unsigned int irate_Bps;
-         const int floor = 4;
-         const int seconds = REQUEST_BUF_SECS;
-         const uint64_t now = tr_time_msec( );
-@@ -1688,8 +1689,8 @@
-             rate_Bps = MIN( rate_Bps, tr_torrentGetSpeedLimit_Bps( torrent, TR_PEER_TO_CLIENT ) );
- 
-         /* honor the session limits, if enabled */
--        if( tr_torrentUsesSessionLimits( torrent ) )
--            if( tr_sessionGetActiveSpeedLimit_Bps( torrent->session, TR_PEER_TO_CLIENT, &irate_Bps ) )
-+        if( tr_torrentUsesSessionLimits( torrent ) 
-+	&&  tr_sessionGetActiveSpeedLimit_Bps( torrent->session, TR_PEER_TO_CLIENT, &irate_Bps ) )
-                 rate_Bps = MIN( rate_Bps, irate_Bps );
- 
-         /* use this desired rate to figure out how
-@@ -1748,7 +1749,7 @@
-         int i;
-         int n;
-         const int numwant = msgs->desiredRequestCount - msgs->peer->pendingReqsToPeer;
--        tr_block_index_t * blocks = alloca( sizeof( tr_block_index_t ) * numwant );
-+        tr_block_index_t * blocks = tr_new( tr_block_index_t, numwant );
- 
-         tr_peerMgrGetNextRequests( msgs->torrent, msgs->peer, numwant, blocks, &n, false );
- 
-@@ -1758,6 +1759,8 @@
-             blockToReq( msgs->torrent, blocks[i], &req );
-             protocolSendRequest( msgs, &req );
-         }
-+
-+        tr_free( blocks );
-     }
- }
- 
-diff -Naur ./.svn/text-base/port-forwarding.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/port-forwarding.c.svn-base
---- ./.svn/text-base/port-forwarding.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/port-forwarding.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -18,7 +18,7 @@
- #include <event2/event.h>
- 
- #include "transmission.h"
--#include "natpmp.h"
-+#include "natpmp_local.h"
- #include "net.h"
- #include "peer-mgr.h"
- #include "port-forwarding.h"
-diff -Naur ./.svn/text-base/rpc-server.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/rpc-server.c.svn-base
---- ./.svn/text-base/rpc-server.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/rpc-server.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -160,7 +160,7 @@
-     size_t inlen = evbuffer_get_length( body );
- 
-     const char * boundary_key = "boundary=";
--    const char * boundary_key_begin = strstr( content_type, boundary_key );
-+    const char * boundary_key_begin = content_type ? strstr( content_type, boundary_key ) : NULL;
-     const char * boundary_val = boundary_key_begin ? boundary_key_begin + strlen( boundary_key ) : "arglebargle";
-     char * boundary = tr_strdup_printf( "--%s", boundary_val );
-     const size_t boundary_len = strlen( boundary );
-diff -Naur ./.svn/text-base/rpcimpl.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/rpcimpl.c.svn-base
---- ./.svn/text-base/rpcimpl.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/rpcimpl.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -523,7 +523,7 @@
- 
-     for( i = 0; i < peerCount; ++i )
-     {
--        tr_benc *            d = tr_bencListAddDict( list, 14 );
-+        tr_benc *            d = tr_bencListAddDict( list, 16 );
-         const tr_peer_stat * peer = peers + i;
-         tr_bencDictAddStr ( d, "address", peer->addr );
-         tr_bencDictAddStr ( d, "clientName", peer->client );
-@@ -637,7 +637,7 @@
-         tr_bencDictAddInt( d, key, st->peersConnected );
-     else if( tr_streq( key, keylen, "peersFrom" ) )
-     {
--        tr_benc *   tmp = tr_bencDictAddDict( d, key, 6 );
-+        tr_benc *   tmp = tr_bencDictAddDict( d, key, 7 );
-         const int * f = st->peersFrom;
-         tr_bencDictAddInt( tmp, "fromCache",    f[TR_PEER_FROM_RESUME] );
-         tr_bencDictAddInt( tmp, "fromDht",      f[TR_PEER_FROM_DHT] );
-diff -Naur ./.svn/text-base/session.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/session.c.svn-base
---- ./.svn/text-base/session.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/session.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -24,6 +24,8 @@
- #include <event2/dns.h> /* evdns_base_free() */
- #include <event2/event.h>
- 
-+#include <libutp/utp.h>
-+
- //#define TR_SHOW_DEPRECATED
- #include "transmission.h"
- #include "announcer.h"
-@@ -1215,7 +1217,7 @@
- ***/
- 
- bool
--tr_sessionGetActiveSpeedLimit_Bps( const tr_session * session, tr_direction dir, int * setme_Bps )
-+tr_sessionGetActiveSpeedLimit_Bps( const tr_session * session, tr_direction dir, unsigned int * setme_Bps )
- {
-     int isLimited = true;
- 
-@@ -1236,7 +1238,7 @@
-                                     tr_direction        dir,
-                                     double            * setme_KBps )
- {
--    int Bps = 0;
-+    unsigned int Bps = 0;
-     const bool is_active = tr_sessionGetActiveSpeedLimit_Bps( session, dir, &Bps );
-     *setme_KBps = toSpeedKBps( Bps );
-     return is_active;
-@@ -1245,7 +1247,7 @@
- static void
- updateBandwidth( tr_session * session, tr_direction dir )
- {
--    int limit_Bps = 0;
-+    unsigned int limit_Bps = 0;
-     const bool isLimited = tr_sessionGetActiveSpeedLimit_Bps( session, dir, &limit_Bps );
-     const bool zeroCase = isLimited && !limit_Bps;
- 
-@@ -1392,23 +1394,22 @@
- ***/
- 
- void
--tr_sessionSetSpeedLimit_Bps( tr_session * s, tr_direction d, int Bps )
-+tr_sessionSetSpeedLimit_Bps( tr_session * s, tr_direction d, unsigned int Bps )
- {
-     assert( tr_isSession( s ) );
-     assert( tr_isDirection( d ) );
--    assert( Bps >= 0 );
- 
-     s->speedLimit_Bps[d] = Bps;
- 
-     updateBandwidth( s, d );
- }
- void
--tr_sessionSetSpeedLimit_KBps( tr_session * s, tr_direction d, int KBps )
-+tr_sessionSetSpeedLimit_KBps( tr_session * s, tr_direction d, unsigned int KBps )
- {
-     tr_sessionSetSpeedLimit_Bps( s, d, toSpeedBytes( KBps ) );
- }
- 
--int
-+unsigned int
- tr_sessionGetSpeedLimit_Bps( const tr_session * s, tr_direction d )
- {
-     assert( tr_isSession( s ) );
-@@ -1416,7 +1417,7 @@
- 
-     return s->speedLimit_Bps[d];
- }
--int
-+unsigned int
- tr_sessionGetSpeedLimit_KBps( const tr_session * s, tr_direction d )
- {
-     return toSpeedKBps( tr_sessionGetSpeedLimit_Bps( s, d ) );
-@@ -1448,11 +1449,10 @@
- ***/
- 
- void
--tr_sessionSetAltSpeed_Bps( tr_session * s, tr_direction d, int Bps )
-+tr_sessionSetAltSpeed_Bps( tr_session * s, tr_direction d, unsigned int Bps )
- {
-     assert( tr_isSession( s ) );
-     assert( tr_isDirection( d ) );
--    assert( Bps >= 0 );
- 
-     s->turtle.speedLimit_Bps[d] = Bps;
- 
-@@ -1460,12 +1460,12 @@
- }
- 
- void
--tr_sessionSetAltSpeed_KBps( tr_session * s, tr_direction d, int KBps )
-+tr_sessionSetAltSpeed_KBps( tr_session * s, tr_direction d, unsigned int KBps )
- {
-     tr_sessionSetAltSpeed_Bps( s, d, toSpeedBytes( KBps ) );
- }
- 
--int
-+unsigned int
- tr_sessionGetAltSpeed_Bps( const tr_session * s, tr_direction d )
- {
-     assert( tr_isSession( s ) );
-@@ -1473,7 +1473,7 @@
- 
-     return s->turtle.speedLimit_Bps[d];
- }
--int
-+unsigned int
- tr_sessionGetAltSpeed_KBps( const tr_session * s, tr_direction d )
- {
-     return toSpeedKBps( tr_sessionGetAltSpeed_Bps( s, d ) );
-@@ -1682,13 +1682,13 @@
- ****
- ***/
- 
--int
-+unsigned int
- tr_sessionGetPieceSpeed_Bps( const tr_session * session, tr_direction dir )
- {
-     return tr_isSession( session ) ? tr_bandwidthGetPieceSpeed_Bps( &session->bandwidth, 0, dir ) : 0;
- }
- 
--int
-+unsigned int
- tr_sessionGetRawSpeed_Bps( const tr_session * session, tr_direction dir )
- {
-     return tr_isSession( session ) ? tr_bandwidthGetRawSpeed_Bps( &session->bandwidth, 0, dir ) : 0;
-@@ -2675,7 +2675,6 @@
-     assert( minutes > 0 );
- 
-     session->queueStalledMinutes = minutes;
--   
- }
- 
- void
-@@ -2686,7 +2685,7 @@
- 
-     session->stalledEnabled = is_enabled;
- }
--  
-+
- bool
- tr_sessionGetQueueStalledEnabled( const tr_session * session )
- {
-diff -Naur ./.svn/text-base/session.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/session.h.svn-base
---- ./.svn/text-base/session.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/session.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -56,7 +56,7 @@
- struct tr_turtle_info
- {
-     /* TR_UP and TR_DOWN speed limits */
--    int speedLimit_Bps[2];
-+    unsigned int speedLimit_Bps[2];
- 
-     /* is turtle mode on right now? */
-     bool isEnabled;
-@@ -118,7 +118,7 @@
- 
-     int                          umask;
- 
--    int                          speedLimit_Bps[2];
-+    unsigned int                 speedLimit_Bps[2];
-     bool                         speedLimitEnabled[2];
- 
-     struct tr_turtle_info        turtle;
-@@ -292,26 +292,30 @@
- ****
- ***/
- 
--static inline unsigned int toSpeedBytes ( unsigned int KBps ) { return KBps * tr_speed_K; }
--static inline double       toSpeedKBps  ( unsigned int Bps )  { return Bps / (double)tr_speed_K; }
--
--static inline uint64_t toMemBytes ( unsigned int MB ) { uint64_t B = tr_mem_K * tr_mem_K; B *= MB; return B; }
--static inline int      toMemMB    ( uint64_t B )      { return B / ( tr_mem_K * tr_mem_K ); }
-+static inline unsigned int
-+toSpeedBytes ( unsigned int KBps ) { return KBps * tr_speed_K; }
-+static inline double
-+toSpeedKBps  ( unsigned int Bps )  { return Bps / (double)tr_speed_K; }
-+
-+static inline uint64_t
-+toMemBytes ( unsigned int MB ) { uint64_t B = tr_mem_K * tr_mem_K; B *= MB; return B; }
-+static inline int
-+toMemMB    ( uint64_t B )      { return B / ( tr_mem_K * tr_mem_K ); }
- 
- /**
- **/
- 
--int  tr_sessionGetSpeedLimit_Bps( const tr_session *, tr_direction );
--int  tr_sessionGetAltSpeed_Bps  ( const tr_session *, tr_direction );
--int  tr_sessionGetRawSpeed_Bps  ( const tr_session *, tr_direction );
--int  tr_sessionGetPieceSpeed_Bps( const tr_session *, tr_direction );
-+unsigned int  tr_sessionGetSpeedLimit_Bps( const tr_session *, tr_direction );
-+unsigned int  tr_sessionGetAltSpeed_Bps  ( const tr_session *, tr_direction );
-+unsigned int  tr_sessionGetRawSpeed_Bps  ( const tr_session *, tr_direction );
-+unsigned int  tr_sessionGetPieceSpeed_Bps( const tr_session *, tr_direction );
- 
--void tr_sessionSetSpeedLimit_Bps( tr_session *, tr_direction, int Bps );
--void tr_sessionSetAltSpeed_Bps  ( tr_session *, tr_direction, int Bps );
-+void tr_sessionSetSpeedLimit_Bps( tr_session *, tr_direction, unsigned int Bps );
-+void tr_sessionSetAltSpeed_Bps  ( tr_session *, tr_direction, unsigned int Bps );
- 
- bool  tr_sessionGetActiveSpeedLimit_Bps( const tr_session  * session,
-                                          tr_direction        dir,
--                                         int               * setme );
-+                                         unsigned int      * setme );
- 
- tr_torrent * tr_sessionGetNextQueuedSeed( tr_session * session );
- tr_torrent * tr_sessionGetNextQueuedTorrent( tr_session * session, tr_direction );
-diff -Naur ./.svn/text-base/stats.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/stats.c.svn-base
---- ./.svn/text-base/stats.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/stats.c.svn-base	2012-07-09 13:11:36.000000000 +0200
-@@ -210,6 +210,7 @@
-     zero.sessionCount = 0;
-     zero.secondsActive = 0;
- 
-+    session->sessionStats->isDirty = true;
-     session->sessionStats->single = session->sessionStats->old = zero;
-     session->sessionStats->startTime = tr_time( );
- }
-diff -Naur ./.svn/text-base/torrent.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.c.svn-base
---- ./.svn/text-base/torrent.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -153,7 +153,7 @@
- tr_torrentIsPieceTransferAllowed( const tr_torrent  * tor,
-                                   tr_direction        direction )
- {
--    int limit;
-+    unsigned int limit;
-     bool allowed = true;
- 
-     if( tr_torrentUsesSpeedLimit( tor, direction ) )
-@@ -173,22 +173,21 @@
- ***/
- 
- void
--tr_torrentSetSpeedLimit_Bps( tr_torrent * tor, tr_direction dir, int Bps )
-+tr_torrentSetSpeedLimit_Bps( tr_torrent * tor, tr_direction dir, unsigned int Bps )
- {
-     assert( tr_isTorrent( tor ) );
-     assert( tr_isDirection( dir ) );
--    assert( Bps >= 0 );
- 
-     if( tr_bandwidthSetDesiredSpeed_Bps( &tor->bandwidth, dir, Bps ) )
-         tr_torrentSetDirty( tor );
- }
- void
--tr_torrentSetSpeedLimit_KBps( tr_torrent * tor, tr_direction dir, int KBps )
-+tr_torrentSetSpeedLimit_KBps( tr_torrent * tor, tr_direction dir, unsigned int KBps )
- {
-     tr_torrentSetSpeedLimit_Bps( tor, dir, toSpeedBytes( KBps ) );
- }
- 
--int
-+unsigned int
- tr_torrentGetSpeedLimit_Bps( const tr_torrent * tor, tr_direction dir )
- {
-     assert( tr_isTorrent( tor ) );
-@@ -196,7 +195,7 @@
- 
-     return tr_bandwidthGetDesiredSpeed_Bps( &tor->bandwidth, dir );
- }
--int
-+unsigned int
- tr_torrentGetSpeedLimit_KBps( const tr_torrent * tor, tr_direction dir )
- {
-     return toSpeedKBps( tr_torrentGetSpeedLimit_Bps( tor, dir ) );
-@@ -2722,8 +2721,6 @@
-     }
- }
- 
--static bool fileExists( const char * filename, time_t * optional_mtime );
--
- /**
-  * This convoluted code does something (seemingly) simple:
-  * remove the torrent's local files.
-@@ -2762,12 +2759,12 @@
-     for( f=0; f<tor->info.fileCount; ++f )
-     {
-         char * filename = tr_buildPath( top, tor->info.files[f].name, NULL );
--        if( !fileExists( filename, NULL ) ) {
-+        if( !tr_fileExists( filename, NULL ) ) {
-                 char * partial = tr_torrentBuildPartial( tor, f );
-                 tr_free( filename );
-                 filename = tr_buildPath( top, partial, NULL );
-                 tr_free( partial );
--                if( !fileExists( filename, NULL ) ) {
-+                if( !tr_fileExists( filename, NULL ) ) {
-                         tr_free( filename );
-                         filename = NULL;
-                 }
-@@ -2814,7 +2811,7 @@
-     for( i=0, n=tr_ptrArraySize(&files); i<n; ++i )
-     {
-         char * walk = tr_strdup( tr_ptrArrayNth( &files, i ) );
--        while( fileExists( walk, NULL ) && !tr_is_same_file( tmpdir, walk ) )
-+        while( tr_fileExists( walk, NULL ) && !tr_is_same_file( tmpdir, walk ) )
-         {
-             char * tmp = tr_dirname( walk );
-             func( walk );
-@@ -2833,13 +2830,9 @@
-     /* build a list of 'top's child directories that belong to this torrent */
-     for( f=0; f<tor->info.fileCount; ++f )
-     {
--        char * dir;
--        char * filename;
--
-         /* get the directory that this file goes in... */
--        filename = tr_buildPath( top, tor->info.files[f].name, NULL );
--        dir = tr_dirname( filename );
--        tr_free( filename );
-+        char * filename = tr_buildPath( top, tor->info.files[f].name, NULL );
-+        char * dir = tr_dirname( filename );
-         if( !tr_is_same_file( top, dir ) && strcmp( top, dir ) ) {
-             for( ;; ) {
-                 char * parent = tr_dirname( dir );
-@@ -2853,6 +2846,8 @@
-                 dir = parent;
-             }
-         }
-+        tr_free( dir );
-+        tr_free( filename );
-     }
-     for( i=0, n=tr_ptrArraySize(&folders); i<n; ++i )
-         removeEmptyFoldersAndJunkFiles( tr_ptrArrayNth( &folders, i ) );
-@@ -3056,25 +3051,6 @@
- ****
- ***/
- 
--#ifdef SYS_DARWIN
-- #define TR_STAT_MTIME(sb) ((sb).st_mtimespec.tv_sec)
--#else
-- #define TR_STAT_MTIME(sb) ((sb).st_mtime)
--#endif
--
--
--static bool
--fileExists( const char * filename, time_t * mtime )
--{
--    struct stat sb;
--    const bool ok = !stat( filename, &sb );
--
--    if( ok && ( mtime != NULL ) )
--        *mtime = TR_STAT_MTIME( sb );
--
--    return ok;
--}
--
- bool
- tr_torrentFindFile2( const tr_torrent * tor, tr_file_index_t fileNum,
-                      const char ** base, char ** subpath, time_t * mtime )
-@@ -3091,7 +3067,7 @@
- 
-     if( b == NULL ) {
-         char * filename = tr_buildPath( tor->downloadDir, file->name, NULL );
--        if( fileExists( filename, mtime ) ) {
-+        if( tr_fileExists( filename, mtime ) ) {
-             b = tor->downloadDir;
-             s = file->name;
-         }
-@@ -3100,7 +3076,7 @@
- 
-     if( ( b == NULL ) && ( tor->incompleteDir != NULL ) ) {
-         char * filename = tr_buildPath( tor->incompleteDir, file->name, NULL );
--        if( fileExists( filename, mtime ) ) {
-+        if( tr_fileExists( filename, mtime ) ) {
-             b = tor->incompleteDir;
-             s = file->name;
-         }
-@@ -3112,7 +3088,7 @@
- 
-     if( ( b == NULL ) && ( tor->incompleteDir != NULL ) ) {
-         char * filename = tr_buildPath( tor->incompleteDir, part, NULL );
--        if( fileExists( filename, mtime ) ) {
-+        if( tr_fileExists( filename, mtime ) ) {
-             b = tor->incompleteDir;
-             s = part;
-         }
-@@ -3121,7 +3097,7 @@
- 
-     if( b == NULL) {
-         char * filename = tr_buildPath( tor->downloadDir, part, NULL );
--        if( fileExists( filename, mtime ) ) {
-+        if( tr_fileExists( filename, mtime ) ) {
-             b = tor->downloadDir;
-             s = part;
-         }
-diff -Naur ./.svn/text-base/torrent.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.h.svn-base
---- ./.svn/text-base/torrent.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/torrent.h.svn-base	2012-07-09 13:11:36.000000000 +0200
-@@ -414,8 +414,8 @@
-  * piece size, etc. such as in BEP 9 where peers exchange metadata */
- void tr_torrentGotNewInfoDict( tr_torrent * tor );
- 
--void tr_torrentSetSpeedLimit_Bps  ( tr_torrent *, tr_direction, int Bps );
--int tr_torrentGetSpeedLimit_Bps  ( const tr_torrent *, tr_direction );
-+void tr_torrentSetSpeedLimit_Bps  ( tr_torrent *, tr_direction, unsigned int Bps );
-+unsigned int tr_torrentGetSpeedLimit_Bps  ( const tr_torrent *, tr_direction );
- 
- /**
-  * @return true if this piece needs to be tested
-diff -Naur ./.svn/text-base/tr-udp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-udp.c.svn-base
---- ./.svn/text-base/tr-udp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-udp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -29,6 +29,8 @@
- 
- #include <event2/event.h>
- 
-+#include <libutp/utp.h>
-+
- #include "transmission.h"
- #include "net.h"
- #include "session.h"
-diff -Naur ./.svn/text-base/tr-utp.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.c.svn-base
---- ./.svn/text-base/tr-utp.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -25,6 +25,8 @@
- 
- #include <event2/event.h>
- 
-+#include <libutp/utp.h>
-+
- #include "transmission.h"
- #include "net.h"
- #include "session.h"
-diff -Naur ./.svn/text-base/tr-utp.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.h.svn-base
---- ./.svn/text-base/tr-utp.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/tr-utp.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -28,9 +28,6 @@
- #ifndef _TR_UTP_H_
- #define _TR_UTP_H_
- 
--/* this is included *after* transmission.h s.t. we get bool defined */
--#include <libutp/utp.h>
--
- int tr_utpPacket(const unsigned char *buf, size_t buflen,
-                  const struct sockaddr *from, socklen_t fromlen,
-                  tr_session *ss);
-diff -Naur ./.svn/text-base/transmission.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/transmission.h.svn-base
---- ./.svn/text-base/transmission.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/transmission.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -652,8 +652,8 @@
- ****  Primary session speed limits
- ***/
- 
--void  tr_sessionSetSpeedLimit_KBps ( tr_session *, tr_direction, int KBps );
--int   tr_sessionGetSpeedLimit_KBps ( const tr_session *, tr_direction );
-+void         tr_sessionSetSpeedLimit_KBps ( tr_session *, tr_direction, unsigned int KBps );
-+unsigned int tr_sessionGetSpeedLimit_KBps ( const tr_session *, tr_direction );
- 
- void  tr_sessionLimitSpeed         ( tr_session *, tr_direction, bool );
- bool  tr_sessionIsSpeedLimited     ( const tr_session *, tr_direction );
-@@ -663,8 +663,8 @@
- ****  Alternative speed limits that are used during scheduled times
- ***/
- 
--void     tr_sessionSetAltSpeed_KBps   ( tr_session *, tr_direction, int Bps );
--int      tr_sessionGetAltSpeed_KBps   ( const tr_session *, tr_direction );
-+void         tr_sessionSetAltSpeed_KBps   ( tr_session *, tr_direction, unsigned int Bps );
-+unsigned int tr_sessionGetAltSpeed_KBps   ( const tr_session *, tr_direction );
- 
- void     tr_sessionUseAltSpeed        ( tr_session *, bool );
- bool     tr_sessionUsesAltSpeed       ( const tr_session * );
-@@ -759,7 +759,7 @@
- ****  Torrents can be moved in the queue using the simple functions
- ****  tr_torrentQueueMove{Top,Up,Down,Bottom}. They can be moved to
- ****  arbitrary points in the queue with tr_torrentSetQueuePosition().
--****  
-+****
- ***/
- 
- 
-@@ -1227,8 +1227,8 @@
- ****
- ***/
- 
--void     tr_torrentSetSpeedLimit_KBps  ( tr_torrent *, tr_direction, int KBps );
--int      tr_torrentGetSpeedLimit_KBps  ( const tr_torrent *, tr_direction );
-+void         tr_torrentSetSpeedLimit_KBps  ( tr_torrent *, tr_direction, unsigned int KBps );
-+unsigned int tr_torrentGetSpeedLimit_KBps  ( const tr_torrent *, tr_direction );
- 
- void     tr_torrentUseSpeedLimit      ( tr_torrent *, tr_direction, bool );
- bool     tr_torrentUsesSpeedLimit     ( const tr_torrent *, tr_direction );
-diff -Naur ./.svn/text-base/utils.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.c.svn-base
---- ./.svn/text-base/utils.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.c.svn-base	2012-07-09 13:11:36.000000000 +0200
-@@ -231,6 +231,7 @@
-         char              timestr[64];
-         struct evbuffer * buf = evbuffer_new( );
-         char *            base = tr_basename( file );
-+        char *            message;
- 
-         evbuffer_add_printf( buf, "[%s] ",
-                             tr_getLogTimeStr( timestr, sizeof( timestr ) ) );
-@@ -241,12 +242,13 @@
-         va_end( args );
-         evbuffer_add_printf( buf, " (%s:%d)\n", base, line );
-         /* FIXME(libevent2) ifdef this out for nonwindows platforms */
--        OutputDebugString( evbuffer_pullup( buf, -1 ) );
-+        message = evbuffer_free_to_str( buf );
-+        OutputDebugString( message );
-         if( fp )
--            fputs( (const char*)evbuffer_pullup( buf, -1 ), fp );
-+            fputs( message, fp );
- 
-+        tr_free( message );
-         tr_free( base );
--        evbuffer_free( buf );
-     }
- }
- 
-@@ -636,6 +638,24 @@
-     return buf;
- }
- 
-+#ifdef SYS_DARWIN
-+ #define TR_STAT_MTIME(sb) ((sb).st_mtimespec.tv_sec)
-+#else
-+ #define TR_STAT_MTIME(sb) ((sb).st_mtime)
-+#endif
-+
-+bool
-+tr_fileExists( const char * filename, time_t * mtime )
-+{
-+    struct stat sb;
-+    const bool ok = !stat( filename, &sb );
-+
-+    if( ok && ( mtime != NULL ) )
-+        *mtime = TR_STAT_MTIME( sb );
-+
-+    return ok;
-+}
-+
- /****
- *****
- ****/
-@@ -978,11 +998,19 @@
- tr_urlIsValidTracker( const char * url )
- {
-     bool valid;
--    const int len = url ? strlen(url) : 0;
- 
--    valid = isValidURLChars( url, len )
--         && !tr_urlParse( url, len, NULL, NULL, NULL, NULL )
--         && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"udp://",6) );
-+    if( url == NULL )
-+    {
-+        valid = false;
-+    }
-+    else
-+    {
-+        const int len = strlen( url );
-+
-+        valid = isValidURLChars( url, len )
-+            && !tr_urlParse( url, len, NULL, NULL, NULL, NULL )
-+            && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"udp://",6) );
-+    }
- 
-     return valid;
- }
-@@ -992,12 +1020,20 @@
- tr_urlIsValid( const char * url, int url_len )
- {
-     bool valid;
--    if( ( url_len < 0 ) && ( url != NULL ) )
--        url_len = strlen( url );
- 
--    valid = isValidURLChars( url, url_len )
--         && !tr_urlParse( url, url_len, NULL, NULL, NULL, NULL )
--         && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"ftp://",6) || !memcmp(url,"sftp://",7) );
-+    if( url == NULL )
-+    {
-+        valid = false;
-+    }
-+    else
-+    {
-+        if( url_len < 0 )
-+            url_len = strlen( url );
-+
-+        valid = isValidURLChars( url, url_len )
-+            && !tr_urlParse( url, url_len, NULL, NULL, NULL, NULL )
-+            && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"ftp://",6) || !memcmp(url,"sftp://",7) );
-+    }
- 
-     return valid;
- }
-@@ -1618,12 +1654,12 @@
- #ifdef HAVE_HTONLL
-     return htonll( x );
- #else
--    /* fallback code by bdonlan at 
--     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */ 
--    union { uint32_t lx[2]; uint64_t llx; } u; 
--    u.lx[0] = htonl(x >> 32); 
--    u.lx[1] = htonl(x & 0xFFFFFFFFULL); 
--    return u.llx; 
-+    /* fallback code by bdonlan at
-+     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */
-+    union { uint32_t lx[2]; uint64_t llx; } u;
-+    u.lx[0] = htonl(x >> 32);
-+    u.lx[1] = htonl(x & 0xFFFFFFFFULL);
-+    return u.llx;
- #endif
- }
- 
-@@ -1633,11 +1669,11 @@
- #ifdef HAVE_NTOHLL
-     return ntohll( x );
- #else
--    /* fallback code by bdonlan at 
--     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */ 
--    union { uint32_t lx[2]; uint64_t llx; } u; 
--    u.llx = x; 
--    return ((uint64_t)ntohl(u.lx[0]) << 32) | (uint64_t)ntohl(u.lx[1]); 
-+    /* fallback code by bdonlan at
-+     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */
-+    union { uint32_t lx[2]; uint64_t llx; } u;
-+    u.llx = x;
-+    return ((uint64_t)ntohl(u.lx[0]) << 32) | (uint64_t)ntohl(u.lx[1]);
- #endif
- }
- 
-diff -Naur ./.svn/text-base/utils.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.h.svn-base
---- ./.svn/text-base/utils.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/utils.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -239,6 +239,9 @@
- char* tr_buildPath( const char * first_element, ... ) TR_GNUC_NULL_TERMINATED
-                                                       TR_GNUC_MALLOC;
- 
-+bool tr_fileExists( const char * filename, time_t * mtime );
-+
-+
- struct event;
- 
- /**
-diff -Naur ./.svn/text-base/web.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/web.c.svn-base
---- ./.svn/text-base/web.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/web.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -95,6 +95,8 @@
- struct tr_web
- {
-     bool curl_verbose;
-+    bool curl_ssl_verify;
-+    const char * curl_ca_bundle;
-     int close_mode;
-     struct tr_web_task * tasks;
-     tr_lock * taskLock;
-@@ -171,8 +173,12 @@
-     curl_easy_setopt( e, CURLOPT_SOCKOPTFUNCTION, sockoptfunction );
-     curl_easy_setopt( e, CURLOPT_SOCKOPTDATA, task );
- #endif
--    curl_easy_setopt( e, CURLOPT_SSL_VERIFYHOST, 0L );
--    curl_easy_setopt( e, CURLOPT_SSL_VERIFYPEER, 0L );
-+    if( web->curl_ssl_verify )
-+        curl_easy_setopt( e, CURLOPT_CAINFO, web->curl_ca_bundle );
-+    else {
-+        curl_easy_setopt( e, CURLOPT_SSL_VERIFYHOST, 0L );
-+        curl_easy_setopt( e, CURLOPT_SSL_VERIFYPEER, 0L );
-+    }
-     curl_easy_setopt( e, CURLOPT_TIMEOUT, task->timeout_secs );
-     curl_easy_setopt( e, CURLOPT_URL, task->url );
-     curl_easy_setopt( e, CURLOPT_USERAGENT, TR_NAME "/" SHORT_VERSION_STRING );
-@@ -188,8 +194,11 @@
-     if( task->cookies != NULL )
-         curl_easy_setopt( e, CURLOPT_COOKIE, task->cookies );
- 
--    if( task->range )
-+    if( task->range != NULL ) {
-         curl_easy_setopt( e, CURLOPT_RANGE, task->range );
-+        /* don't bother asking the server to compress webseed fragments */
-+        curl_easy_setopt( e, CURLOPT_ENCODING, "identity" );
-+    }
- 
-     return e;
- }
-@@ -318,6 +327,14 @@
-     web->taskLock = tr_lockNew( );
-     web->tasks = NULL;
-     web->curl_verbose = getenv( "TR_CURL_VERBOSE" ) != NULL;
-+    web->curl_ssl_verify = getenv( "TR_CURL_SSL_VERIFY" ) != NULL;
-+    web->curl_ca_bundle = getenv( "CURL_CA_BUNDLE" );
-+    if( web->curl_ssl_verify ) {
-+        tr_ninf( "web", "will verify tracker certs using envvar CURL_CA_BUNDLE: %s",
-+                  web->curl_ca_bundle == NULL ? "none" : web->curl_ca_bundle );
-+        tr_ninf( "web", "NB: this only works if you built against libcurl with openssl or gnutls, NOT nss" );
-+        tr_ninf( "web", "NB: invalid certs will show up as 'Could not connect to tracker' like many other errors" );
-+    }
-     web->cookie_filename = tr_buildPath( session->configDir, "cookies.txt", NULL );
- 
-     multi = curl_multi_init( );
-diff -Naur ./.svn/text-base/webseed.c.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.c.svn-base
---- ./.svn/text-base/webseed.c.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.c.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -481,19 +481,20 @@
-         char ** urls = t->webseed->file_urls;
- 
-         const tr_info * inf = tr_torrentInfo( tor );
--        const uint32_t remain = t->length - t->blocks_done * tor->blockSize
-+        const uint64_t remain = t->length - t->blocks_done * tor->blockSize
-                                 - evbuffer_get_length( t->content );
- 
--        const uint64_t total_offset = inf->pieceSize * t->piece_index
--                                    + t->piece_offset + t->length - remain;
-+        const uint64_t total_offset = tr_pieceOffset( tor, t->piece_index,
-+                                                           t->piece_offset,
-+                                                           t->length - remain );
-         const tr_piece_index_t step_piece = total_offset / inf->pieceSize;
--        const uint32_t step_piece_offset
-+        const uint64_t step_piece_offset
-                                = total_offset - ( inf->pieceSize * step_piece );
- 
-         tr_file_index_t file_index;
--        uint64_t file_offset;
-         const tr_file * file;
--        uint32_t this_pass;
-+        uint64_t file_offset;
-+        uint64_t this_pass;
- 
-         tr_ioFindFileLocation( tor, step_piece, step_piece_offset,
-                                     &file_index, &file_offset );
-@@ -511,7 +512,9 @@
- }
- 
- bool
--tr_webseedGetSpeed_Bps( const tr_webseed * w, uint64_t now, int * setme_Bps )
-+tr_webseedGetSpeed_Bps( const tr_webseed * w,
-+                        uint64_t           now,
-+                        unsigned int     * setme_Bps )
- {
-     const bool is_active = webseed_has_tasks( w );
-     *setme_Bps = is_active ? tr_bandwidthGetPieceSpeed_Bps( &w->bandwidth, now, TR_DOWN ) : 0;
-@@ -521,7 +524,7 @@
- bool
- tr_webseedIsActive( const tr_webseed * w )
- {
--    int Bps = 0;
-+    unsigned int Bps = 0;
-     return tr_webseedGetSpeed_Bps( w, tr_time_msec(), &Bps ) && ( Bps > 0 );
- }
- 
-diff -Naur ./.svn/text-base/webseed.h.svn-base ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.h.svn-base
---- ./.svn/text-base/webseed.h.svn-base	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/.svn/text-base/webseed.h.svn-base	2012-07-09 13:11:37.000000000 +0200
-@@ -31,7 +31,7 @@
- /** @return true if a request is being processed, or false if idle */
- bool        tr_webseedGetSpeed_Bps( const tr_webseed * w,
-                                     uint64_t           now,
--                                    int              * setme_Bps );
-+                                    unsigned int     * setme_Bps );
- 
- /** @return true if a request is being processed, or false if idle */
- bool        tr_webseedIsActive( const tr_webseed * w );
-diff -Naur ./Makefile.am ../../../tmp/Transmission/libtransmission/Makefile.am
---- ./Makefile.am	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/Makefile.am	2012-07-09 13:11:37.000000000 +0200
-@@ -1,7 +1,5 @@
- AM_CPPFLAGS = \
--    -I. \
-     -I$(top_srcdir) \
--    -I$(top_srcdir)/third-party/ \
-     -D__TRANSMISSION__ \
-     -DPACKAGE_DATA_DIR=\""$(datadir)"\"
- 
-@@ -9,6 +7,7 @@
-     @DHT_CFLAGS@ \
-     @LIBUTP_CFLAGS@ \
-     @LIBUPNP_CFLAGS@ \
-+    @LIBNATPMP_CFLAGS@ \
-     @LIBEVENT_CFLAGS@ \
-     @LIBCURL_CFLAGS@ \
-     @OPENSSL_CFLAGS@ \
-@@ -91,7 +90,7 @@
-     magnet.h \
-     makemeta.h \
-     metainfo.h \
--    natpmp.h \
-+    natpmp_local.h \
-     net.h \
-     peer-common.h \
-     peer-io.h \
-@@ -141,7 +140,7 @@
- apps_ldadd = \
-     ./libtransmission.a  \
-     @LIBUPNP_LIBS@ \
--    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
-+    @LIBNATPMP_LIBS@ \
-     @INTLLIBS@ \
-     @DHT_LIBS@ \
-     @LIBUTP_LIBS@ \
-diff -Naur ./announcer-common.h ../../../tmp/Transmission/libtransmission/announcer-common.h
---- ./announcer-common.h	2012-06-14 15:01:27.000000000 +0200
-+++ ../../../tmp/Transmission/libtransmission/announcer-common.h	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: announcer-common.h 12238 2011-03-26 12:06:04Z jordan $
-+ * $Id: announcer-common.h 13310 2012-05-20 14:14:59Z jordan $
-  */
- 
- #ifndef __LIBTRANSMISSION_ANNOUNCER_MODULE___
-@@ -110,83 +110,6 @@
-                             void                     * user_data );
- 
- /***
-- ****  FILE REPLICATION
-- ***/
--
--enum
--{
--    /* pick a number small enough for common tracker software:
--     *  - ocelot has no upper bound
--     *  - opentracker has an upper bound of 64
--     *  - udp protocol has an upper bound of 74
--     *  - xbtt has no upper bound */
--    TR_FILEREPLICATION_REQUEST_MAX = 64
--};
--
--typedef struct
--{
--    /* the scrape URL */
--    char * url;
--    
--    /* the name to use when deep logging is enabled */
--    char log_name[128];
--    
--    /* size avaiable for new download */
--    int avaiable_space;
--}
--tr_filereplicate_request;
--
--
--typedef struct
--{
--    /* the current torrent tiers*/
--    struct tr_torrent_tiers* torrent_tier;
--    
--    /* whether or not we managed to connect to the tracker */
--    bool                did_connect;
--    
--    /* whether or not the filereplicate timed out */
--    bool                did_timeout;
--    
--    /* the raw scrape url */
--    char *              url;
--    
--    /* human-readable error string on failure, or NULL */
--    char *              errmsg;
--    
--    /* minimum interval (in seconds) allowed between scrapes.
--     * this is an unofficial extension that some trackers won't support. */
--    int                 min_request_interval;
--    
--    /* the torrent's info_hash to download*/
--    uint8_t             info_hash[SHA_DIGEST_LENGTH];
--    
--    /* Torrent info */
--    uint32_t            pieceSize;
--    tr_piece_index_t    pieceCount;
--    uint32_t            pieceToDownload;
--    
--    /* total size of the torrent, in bytes */
--    uint64_t            totalSize;
--    
--    /* pieces raw sha */
--    char*      piecesRawSign;
--}tr_filereplicate_response;
--
--typedef void tr_filereplicate_response_func( const tr_scrape_response  * response,
--                                     void                      * user_data );
--
--void tr_tracker_http_filereplicate( tr_session               * session,
--                            const tr_filereplicate_request  * req,
--                            tr_filereplicate_response_func    response_func,
--                            void                     * user_data );
--
--void tr_tracker_udp_filereplicate( tr_session               * session,
--                           const tr_filereplicate_request  * req,
--                           tr_filereplicate_response_func    response_func,
--                           void                     * user_data );
--
--/***
- ****  ANNOUNCE
- ***/
- 
-@@ -225,7 +148,7 @@
-     uint64_t corrupt;
- 
-     /* the total size of the torrent minus the number of bytes completed */
--    uint64_t left;
-+    uint64_t leftUntilComplete;
- 
-     /* the tracker's announce URL */
-     char * url;
-@@ -243,17 +166,6 @@
- 
-     /* the name to use when deep logging is enabled */
-     char log_name[128];
--    
--    /* ADDED fro File Replication */
--    
--    /* Torrent info */
--    uint32_t            pieceSize;
--    tr_piece_index_t    pieceCount;
--    uint64_t            totalSize;
--    
--    /* pieces raw sha */
--    char*      piecesRawSign;
--    
- }
- tr_announce_request;
- 
-diff -Naur ./announcer-http.c ../../../tmp/Transmission/libtransmission/announcer-http.c
---- ./announcer-http.c	2012-06-21 14:51:48.000000000 +0200
-+++ ../../../tmp/Transmission/libtransmission/announcer-http.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: announcer-http.c 12982 2011-10-14 00:27:14Z jordan $
-+ * $Id: announcer-http.c 13310 2012-05-20 14:14:59Z jordan $
-  */
- 
- #include <limits.h> /* USHRT_MAX */
-@@ -50,7 +50,7 @@
-     return tr_announce_event_get_string( req->event );
- }
- 
--static struct evbuffer *
-+static char*
- announce_url_new( const tr_session * session, const tr_announce_request * req )
- {
-     const char * str;
-@@ -73,11 +73,7 @@
-                               "&numwant=%d"
-                               "&key=%x"
-                               "&compact=1"
--                              "&supportcrypto=1"
--                              "&piece_size=%d"     // Added for File Replication information
--                              "&piece_count=%d"    // 
--                              "&total_size=%llu"   // 
--                              "&piece_signs=%s",   // 
-+                              "&supportcrypto=1",
-                               req->url,
-                               strchr( req->url, '?' ) ? '&' : '?',
-                               escaped_info_hash,
-@@ -85,13 +81,9 @@
-                               req->port,
-                               req->up,
-                               req->down,
--                              req->left,
-+                              req->leftUntilComplete,
-                               req->numwant,
--                              req->key,
--                              req->pieceSize,
--                              req->pieceCount,
--                              req->totalSize,
--                              req->piecesRawSign);
-+                              req->key );
- 
-     if( session->encryptionMode == TR_ENCRYPTION_REQUIRED )
-         evbuffer_add_printf( buf, "&requirecrypto=1" );
-@@ -124,7 +116,7 @@
-         tr_http_escape( buf, ipv6_readable, -1, true );
-     }
- 
--    return buf;
-+    return evbuffer_free_to_str( buf );
- }
- 
- static tr_pex*
-@@ -172,7 +164,6 @@
-     char log_name[128];
- };
- 
--
- static void
- on_announce_done_eventthread( void * vdata )
- {
-@@ -296,8 +287,7 @@
-                           void                       * response_func_user_data )
- {
-     struct announce_data * d;
--    struct evbuffer * buf = announce_url_new( session, request );
--    const char * url = (const char *) evbuffer_pullup( buf, -1 );
-+    char * url = announce_url_new( session, request );
- 
-     d = tr_new0( struct announce_data, 1 );
-     d->response.seeders = -1;
-@@ -311,7 +301,7 @@
-     dbgmsg( request->log_name, "Sending announce to libcurl: \"%s\"", url );
-     tr_webRun( session, url, NULL, NULL, on_announce_done, d );
- 
--    evbuffer_free( buf );
-+    tr_free( url );
- }
- 
- /****
-@@ -372,7 +362,7 @@
-         tr_benc * flags;
-         const char * str;
-         const int benc_loaded = !tr_bencLoad( msg, msglen, &top, NULL );
--        
-+
-         if( getenv( "TR_CURL_VERBOSE" ) != NULL )
-         {
-             if( !benc_loaded )
-@@ -387,7 +377,7 @@
-                 tr_free( str );
-             }
-         }
--        
-+
-         if( benc_loaded )
-         {
-             if( tr_bencDictFindStr( &top, "failure reason", &str ) )
-@@ -438,7 +428,7 @@
-     tr_runInEventThread( session, on_scrape_done_eventthread, data );
- }
- 
--static struct evbuffer *
-+static char *
- scrape_url_new( const tr_scrape_request * req )
- {
-     int i;
-@@ -455,7 +445,7 @@
-         delimiter = '&';
-     }
- 
--    return buf;
-+    return evbuffer_free_to_str( buf );
- }
- 
- void
-@@ -466,8 +456,7 @@
- {
-     int i;
-     struct scrape_data * d;
--    struct evbuffer * buf = scrape_url_new( request );
--    const char * url = (const char *) evbuffer_pullup( buf, -1 );
-+    char * url = scrape_url_new( request );
- 
-     d = tr_new0( struct scrape_data, 1 );
-     d->response.url = tr_strdup( request->url );
-@@ -486,138 +475,5 @@
-     dbgmsg( request->log_name, "Sending scrape to libcurl: \"%s\"", url );
-     tr_webRun( session, url, NULL, NULL, on_scrape_done, d );
- 
--    evbuffer_free( buf );
--}
--
--/****
-- *****
-- *****  FILE REPLICATION
-- *****
-- ****/
--struct filereplication_data
--{
--    tr_filereplicate_response response;
--    tr_filereplicate_response_func * response_func;
--    void * response_func_user_data;
--    char log_name[128];
--};
--
--static void
--on_file_replication_done( tr_session   * session,
--               bool           did_connect,
--               bool           did_timeout,
--               long           response_code,
--               const void   * msg,
--               size_t         msglen,
--               void         * vdata ){
--    tr_filereplicate_response * response;
--    struct filereplication_data * data = vdata;
--    
--    response = &data->response; //HERE
--    response->did_connect = did_connect;
--    response->did_timeout = did_timeout;
--    dbgmsg( data->log_name, "Got file replication response for \"%s\"", response->url );
--
--    if( response_code != HTTP_OK )
--    {
--        const char * fmt = _( "Tracker gave HTTP response code %1$ld (%2$s)" );
--        const char * response_str = tr_webGetResponseStr( response_code );
--        response->errmsg = tr_strdup_printf( fmt, response_code, response_str );
--    }else{
--        tr_benc top;
--        const char *    str;
--        const char *    hash;
--        int64_t         pieceSize;
--        int64_t         pieceCount;
--        int64_t         totalSize;
--        const char *    piecesRawSign;
--        
--        const int benc_loaded = !tr_bencLoad( msg, msglen, &top, NULL );
--        if( getenv( "TR_CURL_VERBOSE" ) != NULL )
--        {
--            if( !benc_loaded )
--                fprintf( stderr, "%s", "Scrape response was not in benc format\n" );
--            else {
--                int i, len;
--                char * str = tr_bencToStr( &top, TR_FMT_JSON, &len );
--                fprintf( stderr, "%s", "Scrape response:\n< " );
--                for( i=0; i<len; ++i )
--                    fputc( str[i], stderr );
--                fputc( '\n', stderr );
--                tr_free( str );
--            }
--        }
--        
--        if( benc_loaded )
--        {
--            if( tr_bencDictFindStr( &top, "failure reason", &str ) )
--                return; //response->errmsg = tr_strdup( str );
--            if( tr_bencDictFindStr( &top, "hash", &hash ) ){
--                int size = memcmp( hash, response->info_hash, SHA_DIGEST_LENGTH);
--                memcpy( response->info_hash, hash,SHA_DIGEST_LENGTH); 
--            }
--            
--            if( tr_bencDictFindInt( &top, "p_count", &pieceCount ) ){
--                response->pieceCount    = pieceCount;
--            }
--            
--            if( tr_bencDictFindInt( &top, "p_size", &pieceSize ) ){
--                response->pieceSize    = pieceSize;
--            }
--            
--            if( tr_bencDictFindInt( &top, "t_size", &totalSize ) ){
--                response->totalSize    = totalSize;
--            }
--            
--            if( tr_bencDictFindStr( &top, "raw_pieces", &piecesRawSign ) ){
--                response->piecesRawSign     = tr_new0(char,  pieceCount * 2 *SHA_DIGEST_LENGTH);
--                memcpy( response->piecesRawSign, piecesRawSign,sizeof(char) * 2 * pieceCount * SHA_DIGEST_LENGTH); 
--            }
--            
--            data->response_func(response,data->response_func_user_data);
--        }
--        
--    }
--}
--static struct evbuffer *
--filereplication_url_new( const tr_filereplicate_request * req )
--{
--    char delimiter;
--    struct evbuffer * buf = evbuffer_new( );
--    
--    evbuffer_add_printf( buf, "%s", req->url );
--    delimiter = strchr( req->url, '?' ) ? '&' : '?';
--    /*for( i=0; i<req->info_hash_count; ++i )
--    {
--        char str[SHA_DIGEST_LENGTH*3 + 1];
--        tr_http_escape_sha1( str, req->info_hash[i] );
--        evbuffer_add_printf( buf, "%cinfo_hash=%s", delimiter, str );
--        delimiter = '&';
--    }*/
--    
--    return buf;
--}
--
--
--
--void
--tr_tracker_http_filereplicate( tr_session               * session,
--                       const tr_filereplicate_request  * request,
--                       tr_filereplicate_response_func    response_func,
--                       void                     * response_func_user_data ){
--    struct filereplication_data * d;
--    struct evbuffer * buf = filereplication_url_new( request );
--    const char * url = (const char *) evbuffer_pullup( buf, -1 );
--    
--    d = tr_new0( struct filereplication_data, 1 );
--    d->response.url = tr_strdup( request->url );
--    d->response_func = response_func;
--    d->response_func_user_data = response_func_user_data;
--
--    tr_strlcpy( d->log_name, request->log_name, sizeof( d->log_name ) );
--    
--    dbgmsg( request->log_name, "Sending file replication to libcurl: \"%s\"", url );
--    tr_webRun( session, url, NULL, NULL, on_file_replication_done, d );
--    
--    evbuffer_free( buf );
-+    tr_free( url );
- }
-diff -Naur ./announcer-udp.c ../../../tmp/Transmission/libtransmission/announcer-udp.c
---- ./announcer-udp.c	2011-12-05 11:33:53.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/announcer-udp.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: announcer-udp.c 12982 2011-10-14 00:27:14Z jordan $
-+ * $Id: announcer-udp.c 13310 2012-05-20 14:14:59Z jordan $
-  */
- 
- #define __LIBTRANSMISSION_ANNOUNCER_MODULE___
-@@ -266,12 +266,6 @@
- }
- 
- /****
-- *****
-- *****  FILE REPLICATION
-- *****
-- ****/
--
--/****
- *****
- *****  ANNOUNCE
- *****
-@@ -329,7 +323,7 @@
-     evbuffer_add        ( buf, in->info_hash, SHA_DIGEST_LENGTH );
-     evbuffer_add        ( buf, in->peer_id, PEER_ID_LEN );
-     evbuffer_add_hton_64( buf, in->down );
--    evbuffer_add_hton_64( buf, in->left );
-+    evbuffer_add_hton_64( buf, in->leftUntilComplete );
-     evbuffer_add_hton_64( buf, in->up );
-     evbuffer_add_hton_32( buf, get_tau_announce_event( in->event ) );
-     evbuffer_add_hton_32( buf, 0 );
-@@ -972,12 +966,3 @@
-     tr_ptrArrayAppend( &tracker->scrapes, r );
-     tau_tracker_upkeep( tracker );
- }
--
--void
--tr_tracker_udp_filereplicate( tr_session               * session,
--                      const tr_filereplicate_request  * request,
--                      tr_filereplicate_response_func    response_func,
--                      void                     * user_data )
--{
--   //TODO
--}
-diff -Naur ./announcer.c ../../../tmp/Transmission/libtransmission/announcer.c
---- ./announcer.c	2012-06-26 12:10:06.000000000 +0200
-+++ ../../../tmp/Transmission/libtransmission/announcer.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: announcer.c 12982 2011-10-14 00:27:14Z jordan $
-+ * $Id: announcer.c 13313 2012-05-22 20:21:00Z jordan $
-  */
- 
- #include <assert.h>
-@@ -30,12 +30,12 @@
- #include "session.h"
- #include "torrent.h"
- #include "utils.h"
--#include "metainfo.h"
- 
- struct tr_tier;
--struct tr_announcer;
-+
- static void tier_build_log_name( const struct tr_tier * tier,
-                                  char * buf, size_t buflen );
-+
- #define dbgmsg( tier, ... ) \
- if( tr_deepLoggingIsActive( ) ) do { \
-   char name[128]; \
-@@ -203,7 +203,7 @@
-     char * key;
-     char * announce;
-     char * scrape;
--    char * file_replication;
-+
-     char * tracker_id_str;
- 
-     int seederCount;
-@@ -241,7 +241,6 @@
-     tracker->key = getKey( inf->announce );
-     tracker->announce = tr_strdup( inf->announce );
-     tracker->scrape = tr_strdup( inf->scrape );
--    tracker->file_replication   = tr_strdup( inf->file_replication );
-     tracker->id = inf->id;
-     tracker->seederCount = -1;
-     tracker->leecherCount = -1;
-@@ -653,8 +652,8 @@
-                                                tor->info.trackerCount, &n );
- 
-     /* build the array of trackers */
--    tt->trackers        = tr_new0( tr_tracker, n );
--    tt->tracker_count   = n;
-+    tt->trackers = tr_new0( tr_tracker, n );
-+    tt->tracker_count = n;
-     for( i=0; i<n; ++i )
-         trackerConstruct( &tt->trackers[i], &infos[i] );
- 
-@@ -754,6 +753,7 @@
-     {
-         int i;
-         char name[128];
-+        char * message;
-         struct evbuffer * buf = evbuffer_new( );
- 
-         tier_build_log_name( tier, name, sizeof( name ) );
-@@ -764,8 +764,9 @@
-             evbuffer_add_printf( buf, "[%d:%s]", i, str );
-         }
- 
--        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", evbuffer_pullup( buf, -1 ) );
--        evbuffer_free( buf );
-+        message = evbuffer_free_to_str( buf );
-+        tr_deepLog( __FILE__, __LINE__, name, "announce queue is %s", message );
-+        tr_free( message );
-     }
- }
- 
-@@ -911,31 +912,13 @@
-     req->up = tier->byteCounts[TR_ANN_UP];
-     req->down = tier->byteCounts[TR_ANN_DOWN];
-     req->corrupt = tier->byteCounts[TR_ANN_CORRUPT];
--    req->left = tr_cpLeftUntilComplete( &tor->completion ),
-+    req->leftUntilComplete = tr_torrentHasMetadata( tor )
-+            ? tor->info.totalSize - tr_cpHaveTotal( &tor->completion )
-+            : ~(uint64_t)0;
-     req->event = event;
-     req->numwant = event == TR_ANNOUNCE_EVENT_STOPPED ? 0 : NUMWANT;
-     req->key = announcer->key;
-     req->partial_seed = tr_cpGetStatus( &tor->completion ) == TR_PARTIAL_SEED;
--    
--    //ADDED for file replication
--    req->pieceSize      = tor->info.pieceSize;
--    req->pieceCount     = tor->info.pieceCount;
--    req->totalSize      = tor->info.totalSize;
--    
--    //RAW pieces signs register
--    req->piecesRawSign  = tr_new0(char, ((2 * SHA_DIGEST_LENGTH) * req->pieceCount) +1);
--    int i               = 0;
--    for( i = 0; i < req->pieceCount; ++i ){
--        char* piecesRawSign      = tr_new0(char, 2 * SHA_DIGEST_LENGTH);
--        tr_sha1_to_hex(piecesRawSign, tor->info.pieces[i].hash);
--        memcpy( &req->piecesRawSign[i * (2 * SHA_DIGEST_LENGTH)], piecesRawSign, 2 * SHA_DIGEST_LENGTH);
--        tr_free(piecesRawSign);
--    }
--    
--    char* last = req->piecesRawSign;
--    last       += ((2 * SHA_DIGEST_LENGTH) * req->pieceCount) +1;
--    *last       =  '\0';
--    
-     tier_build_log_name( tier, req->log_name, sizeof( req->log_name ) );
-     return req;
- }
-@@ -997,18 +980,6 @@
-     bool isRunningOnSuccess;
- };
- 
--struct announce_replication_data{
--    int tierId;
--    time_t timeSent;
--    tr_announce_event event;
--    tr_session * session;
--    tr_tracker_info * trackers;
--    int trackerCount;
--    
--    /** If the request succeeds, the value for tier's "isRunning" flag */
--    bool isRunningOnSuccess;
--};
--
- static void
- on_announce_error( tr_tier * tier, const char * err, tr_announce_event e )
- {
-@@ -1033,21 +1004,6 @@
-     tier_announce_event_push( tier, e, tr_time( ) + interval );
- }
- 
--static void 
--tierFileReplicate( tr_announcer * announcer, tr_tier * tier);
--
--
--static bool compareHash(uint8_t hash_source[],uint8_t hash_target[]){
--    bool result = true;
--    
--    for(int i=0; i<SHA_DIGEST_LENGTH; i++){
--        if(hash_source[i] != hash_target[i]){
--            return false;
--        }
--    }
--    return result;
--}
--
- static void
- on_announce_done( const tr_announce_response  * response,
-                   void                        * vdata )
-@@ -1096,7 +1052,7 @@
-         tier->lastAnnounceSucceeded = false;
-         tier->isAnnouncing = false;
-         tier->manualAnnounceAllowedAt = now + tier->announceMinIntervalSec;
--        
-+
-         if( !response->did_connect )
-         {
-             on_announce_error( tier, _( "Could not connect to tracker" ), event );
-@@ -1187,7 +1143,7 @@
- 
-             /* if the tracker included scrape fields in its announce response,
-                then a separate scrape isn't needed */
--            if( scrape_fields >= 3 )
-+            if( ( scrape_fields >= 3 ) || ( !tracker->scrape && ( scrape_fields >= 1 ) ) )
-             {
-                 tr_tordbg( tier->tor, "Announce response contained scrape info; "
-                                       "rescheduling next scrape to %d seconds from now.",
-@@ -1223,8 +1179,6 @@
-                 tier_announce_event_push( tier, TR_ANNOUNCE_EVENT_NONE, now + i );
-             }
-         }
--        
--        tierFileReplicate( announcer, tier);
-     }
- 
-     tr_free( data );
-@@ -1235,7 +1189,6 @@
- {
-     tr_free( req->tracker_id_str );
-     tr_free( req->url );
--    tr_free(req->piecesRawSign);
-     tr_free( req );
- }
- 
-@@ -1287,112 +1240,6 @@
- }
- 
- /***
-- ****
-- ****  FILE REPLICATION
-- ****
-- ***/
--
--static void
--on_file_replicate_done( const tr_filereplicate_response * response, void * vdata ){
--    struct announce_replication_data * data = vdata;
--    tr_torrent* tor     = NULL;
--    int i               = 0;
--    tor                 = tr_torrentFindFromHash(data->session, response->info_hash);
--    
--    //const uint8_t* raw  = tr_new0(uint8_t, SHA_DIGEST_LENGTH * 4);
--    
--    //TEST OK
--    /*if(tor2!=NULL){
--        for( i = 0; i < tor2->info.pieceCount; ++i )
--            memcpy( &raw[i * SHA_DIGEST_LENGTH], tor2->info.pieces[i].hash,
--                   SHA_DIGEST_LENGTH );
--    }*/
--    if(tor == NULL){
--        tor                     = tr_new0( tr_torrent, 1 ); //Torrent instanciation
--        tor->info.name          = "File replication";
--        
--        tor->isRunning          = true; //TE
--        tor->isFileReplicated   = true;
--        //hash capture
--        memcpy( tor->info.hash, response->info_hash, sizeof(uint8_t) * SHA_DIGEST_LENGTH );
--        tr_sha1_to_hex(tor->info.hashString,tor->info.hash);
--        
--        //session capture
--        tor->session            = data->session;
--        //file and pieces capture
--        tor->info.fileCount     = 1;
--        tor->info.pieceSize     = response->pieceSize;
--        tor->info.pieceCount    = response->pieceCount;
--        tor->info.totalSize     = response->totalSize;
--        
--        //pieces management
--        tor->info.pieces        = tr_new0( tr_piece, tor->info.pieceCount );
--        for( i = 0; i < tor->info.pieceCount; ++i ){
--            uint8_t* currentHash    = tr_new0(uint8_t, SHA_DIGEST_LENGTH);
--            tr_hex_to_sha1(currentHash, &response->piecesRawSign[i * SHA_DIGEST_LENGTH * 2]);
--            memcpy( tor->info.pieces[i].hash, currentHash,
--               SHA_DIGEST_LENGTH );
--            //tor->info.pieces[i].dnd = i == response->pieceToDownload ? 0 : 1;
--        }
--        tor->info.trackers         = data->trackers;
--        tor->info.trackerCount     = data->trackerCount;
--        //files management
--        tor->info.isMultifile      = 0;
--        tor->info.fileCount        = 1;
--        tor->info.files            = tr_new0( tr_file, 1 );
--        tor->info.files[0].name    = tr_strdup( tor->info.name );
--        tor->info.files[0].length  = tor->info.totalSize;
--
--        char* torrentFile            = getTorrentFilePath( data->session, &tor->info );
--        tor->info.torrent           = torrentFile;
--        fprintf(stdout, "Downloading %d \n",*tor->info.hashString );
--        fileRepTorrentInit(tor);
--    }
--}
--
--static void
--filereplicate_request_delegate( tr_announcer             * announcer,
--                               const tr_filereplicate_request  * request,
--                               tr_filereplicate_response_func  * callback,
--                               void                     * callback_data ){
--    tr_session * session = announcer->session;
--    
--    if( !memcmp( request->url, "http", 4 ) )
--        tr_tracker_http_filereplicate( session, request, callback, callback_data );
--    else if( !memcmp( request->url, "udp://", 6 ) )
--        tr_tracker_udp_filereplicate( session, request, callback, callback_data );
--    else
--        tr_err( "Unsupported url: %s", request->url );
--}
--
--
--static void 
--tierFileReplicate( tr_announcer * announcer, tr_tier * tier){
--    //request declaration and creation
--    tr_filereplicate_request * request = tr_new0( tr_filereplicate_request, 1 ); //TODO check number request 
--    char * url = tier->currentTracker->file_replication;
--    struct announce_replication_data * data;
--    
--    request->url = url;
--    tier_build_log_name( tier, request->log_name, sizeof( request->log_name ) );
--    
--    
--    data = tr_new0( struct announce_replication_data, 1 );
--    data->session       = announcer->session;
--    data->tierId        = tier->key;
--    data->trackers      = tier->tor->info.trackers;
--    data->trackerCount  = tier->tor->info.trackerCount;
--    if(request->url != 0){
--        filereplicate_request_delegate( announcer, request, on_file_replicate_done, data );
--    }
--
--    /* cleanup */
--    tr_free( request );
--    
--}
--
--
--/***
- ****
- ****  SCRAPE
- ****
-@@ -1645,40 +1492,6 @@
-     return ret;
- }
- 
--static void 
--annouceFileReplication( tr_announcer * announcer ){
--    int i;
--    int n;
--    //Declaration of the current torrent
--    tr_torrent * tor = NULL;
--    //List of tier to annouce for file replication
--    tr_ptrArray fileReplicMe = TR_PTR_ARRAY_INIT;
--    //loop on each torrent
--    while(( tor = tr_torrentNext( announcer->session, tor ))) {
--        struct tr_torrent_tiers * tt = tor->tiers;
--        //loop on each tier
--        for( i=0; tt && i<tt->tier_count; ++i ) {
--            tr_tier * tier = &tt->tiers[i];
--            //TODO verify if tier already exist
--            tr_ptrArrayAppend( &fileReplicMe, tier );
--        }
--    }
--    
--    /* if there are more tiers than slots available, prioritize */
--    n = tr_ptrArraySize( &fileReplicMe );
--    if( n > announcer->slotsAvailable )
--        qsort( tr_ptrArrayBase(&fileReplicMe), n, sizeof(tr_tier*), compareTiers );
--    
--    /* announce file replication on all tiers */
--    n = tr_ptrArraySize( &fileReplicMe );
--    for( i=0; i<n; ++i ) {
--        tr_tier * tier = tr_ptrArrayNth( &fileReplicMe, i );
--        tr_tordbg( tier->tor, "%s", "Announcing to tracker" );
--        dbgmsg( tier, "announcing tier %d of %d", i, n );
--        tierFileReplicate( announcer, tier );
--    }
--}
--
- static void
- announceMore( tr_announcer * announcer )
- {
-@@ -1745,7 +1558,7 @@
-     /* maybe send out some announcements to trackers */
-     if( !is_closing )
-         announceMore( announcer );
--    
-+
-     /* TAU upkeep */
-     if( announcer->tauUpkeepAt <= now ) {
-         announcer->tauUpkeepAt = now + TAU_UPKEEP_INTERVAL_SECS;
-@@ -1754,9 +1567,6 @@
- 
-     /* set up the next timer */
-     tr_timerAdd( announcer->upkeepTimer, UPKEEP_INTERVAL_SECS, 0 );
--    
--    /*File replication announce*/
--    //annouceFileReplication(announcer);
- 
-     tr_sessionUnlock( session );
- }
-diff -Naur ./bandwidth.c ../../../tmp/Transmission/libtransmission/bandwidth.c
---- ./bandwidth.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/bandwidth.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: bandwidth.c 13034 2011-10-25 21:54:51Z jordan $
-+ * $Id: bandwidth.c 13361 2012-07-01 02:17:35Z jordan $
-  */
- 
- #include <assert.h>
-@@ -174,8 +174,8 @@
-     /* set the available bandwidth */
-     if( b->band[dir].isLimited )
-     {
--        const unsigned int nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
--        b->band[dir].bytesLeft = ( nextPulseSpeed * period_msec ) / 1000u;
-+        const uint64_t nextPulseSpeed = b->band[dir].desiredSpeed_Bps;
-+        b->band[dir].bytesLeft = (unsigned int)( nextPulseSpeed * period_msec ) / 1000u;
-     }
- 
-     /* add this bandwidth's peer, if any, to the peer pool */
-diff -Naur ./bencode-test.c ../../../tmp/Transmission/libtransmission/bencode-test.c
---- ./bencode-test.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/bencode-test.c	2012-07-09 13:11:37.000000000 +0200
-@@ -319,8 +319,8 @@
-                  const char * expected )
- {
-     tr_benc top;
--    struct evbuffer * buf = evbuffer_new( );
-     char * serialized;
-+    struct evbuffer * buf;
- 
-     tr_bencLoad( benc_str, strlen( benc_str ), &top, NULL );
-     buf = tr_bencToBuf( &top, TR_FMT_JSON );
-diff -Naur ./bencode.c ../../../tmp/Transmission/libtransmission/bencode.c
---- ./bencode.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/bencode.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: bencode.c 12463 2011-05-27 23:28:40Z jordan $
-+ * $Id: bencode.c 13198 2012-02-04 00:34:39Z jordan $
-  */
- 
- #include <assert.h>
-@@ -1593,6 +1593,16 @@
-                     tr_bencListCopy( tr_bencDictAddList( target, key, tr_bencListSize( val ) ), val );
-                 }
-             }
-+            else if( tr_bencIsDict( val ) )
-+            {
-+                tr_benc * target_dict = tr_bencDictFind( target, key );
-+
-+                if( target_dict == NULL )
-+                    target_dict = tr_bencDictAddDict( target, key, tr_bencDictSize( val ) );
-+
-+                if( tr_bencIsDict( target_dict ) )
-+                    tr_bencMergeDicts( target_dict, val );
-+            }
-             else
-             {
-                 tr_dbg( "tr_bencMergeDicts skipping \"%s\"", key );
-diff -Naur ./clients.c ../../../tmp/Transmission/libtransmission/clients.c
---- ./clients.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/clients.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: clients.c 12502 2011-06-16 12:08:52Z livings124 $
-+ * $Id: clients.c 13099 2011-11-22 03:30:37Z livings124 $
-  */
- 
- /* thanks amc1! */
-@@ -304,6 +304,29 @@
-             return;
-     }
- 
-+    /* uTorrent will replace the trailing dash with an extra digit for longer version numbers */
-+    if( id[0] == '-' )
-+    {
-+        if( !memcmp( id+1, "UT", 2 ) )
-+        {
-+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent %d.%d.%d%s",
-+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
-+        }
-+        else if( !memcmp( id+1, "UM", 2 ) )
-+        {
-+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Mac %d.%d.%d%s",
-+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
-+        }
-+        else if( !memcmp( id+1, "UE", 2 ) )
-+        {
-+            tr_snprintf( buf, buflen, "\xc2\xb5Torrent Embedded %d.%d.%d%s",
-+                        strint(id+3,1), strint(id+4,1), strint(id+5,2), getMnemonicEnd(id[7]) );
-+        }
-+
-+        if( *buf )
-+            return;
-+    }
-+
-     /* Mainline */
-     if( isMainlineStyle( id ) )
-     {
-diff -Naur ./completion.c ../../../tmp/Transmission/libtransmission/completion.c
---- ./completion.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/completion.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: completion.c 12918 2011-09-26 06:18:48Z jordan $
-+ * $Id: completion.c 13113 2011-12-22 19:35:13Z jordan $
-  */
- 
- #include <assert.h>
-@@ -165,19 +165,13 @@
-                 }
-                 else
-                 {
--                    uint64_t o = 0;
--                    tr_block_index_t b, f, l;
-+                    tr_block_index_t f, l;
-                     tr_torGetPieceBlockRange( cp->tor, p, &f, &l );
--                    for( b=f; b<=l; ++b )
--                        if( tr_cpBlockIsComplete( cp, b ) )
--                            n += tr_torBlockCountBytes( tor, b );
- 
--                    o = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
--                    o *= cp->tor->blockSize;
-+                    n = tr_bitfieldCountRange( &cp->blockBitfield, f, l+1 );
-+                    n *= cp->tor->blockSize;
-                     if( l == ( cp->tor->blockCount - 1 )  && tr_bitfieldHas( &cp->blockBitfield, l ) )
--                        o -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
--
--                    assert( n == o );
-+                        n -= ( cp->tor->blockSize - cp->tor->lastBlockSize );
-                 }
- 
-                 assert( n <= tr_torPieceCountBytes( tor, p ) );
-diff -Naur ./completion.h ../../../tmp/Transmission/libtransmission/completion.h
---- ./completion.h	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/completion.h	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: completion.h 12918 2011-09-26 06:18:48Z jordan $
-+ * $Id: completion.h 13310 2012-05-20 14:14:59Z jordan $
-  */
- 
- #ifndef __TRANSMISSION__
-@@ -89,12 +89,6 @@
-     return cp->sizeNow;
- }
- 
--static inline uint64_t
--tr_cpLeftUntilComplete( const tr_completion * cp )
--{
--    return tr_torrentInfo(cp->tor)->totalSize - cp->sizeNow;
--}
--
- static inline bool tr_cpHasAll( const tr_completion * cp )
- {
-     return tr_bitfieldHasAll( &cp->blockBitfield );
-diff -Naur ./fdlimit.c ../../../tmp/Transmission/libtransmission/fdlimit.c
---- ./fdlimit.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/fdlimit.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: fdlimit.c 12582 2011-07-25 17:48:14Z jordan $
-+ * $Id: fdlimit.c 13110 2011-12-14 05:42:15Z jordan $
-  */
- 
- #ifdef HAVE_POSIX_FADVISE
-@@ -478,19 +478,25 @@
- static struct tr_cached_file *
- fileset_get_empty_slot( struct tr_fileset * set )
- {
--    struct tr_cached_file * o;
--    struct tr_cached_file * cull;
-+    struct tr_cached_file * cull = NULL;
- 
--    /* try to find an unused slot */
--    for( o=set->begin; o!=set->end; ++o )
--        if( !cached_file_is_open( o ) )
--            return o;
-+    if( set->begin != NULL )
-+    {
-+        struct tr_cached_file * o;
-+
-+        /* try to find an unused slot */
-+        for( o=set->begin; o!=set->end; ++o )
-+            if( !cached_file_is_open( o ) )
-+                return o;
-+
-+        /* all slots are full... recycle the least recently used */
-+        for( cull=NULL, o=set->begin; o!=set->end; ++o )
-+            if( !cull || o->used_at < cull->used_at )
-+                cull = o;
-+
-+        cached_file_close( cull );
-+    }
- 
--    /* all slots are full... recycle the least recently used */
--    for( cull=NULL, o=set->begin; o!=set->end; ++o )
--        if( !cull || o->used_at < cull->used_at )
--            cull = o;
--    cached_file_close( cull );
-     return cull;
- }
- 
-diff -Naur ./inout.c ../../../tmp/Transmission/libtransmission/inout.c
---- ./inout.c	2012-06-21 12:03:07.000000000 +0200
-+++ ../../../tmp/Transmission/libtransmission/inout.c	2012-07-09 13:11:37.000000000 +0200
-@@ -300,7 +300,7 @@
- tr_ioTestPiece( tr_torrent * tor, tr_piece_index_t piece )
- {
-     uint8_t hash[SHA_DIGEST_LENGTH];
--    bool  success = recalculateHash( tor, piece, hash );
--    success         = success && !memcmp( hash, tor->info.pieces[piece].hash, SHA_DIGEST_LENGTH );
--    return success;
-+
-+    return recalculateHash( tor, piece, hash )
-+           && !memcmp( hash, tor->info.pieces[piece].hash, SHA_DIGEST_LENGTH );
- }
-diff -Naur ./metainfo.c ../../../tmp/Transmission/libtransmission/metainfo.c
---- ./metainfo.c	2012-06-26 12:06:09.000000000 +0200
-+++ ../../../tmp/Transmission/libtransmission/metainfo.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: metainfo.c 12848 2011-09-06 16:45:48Z jordan $
-+ * $Id: metainfo.c 13311 2012-05-20 14:47:18Z jordan $
-  */
- 
- #include <assert.h>
-@@ -48,8 +48,6 @@
-     return ret;
- }
- 
--
--
- static char*
- getTorrentFilename( const tr_session * session, const tr_info * inf )
- {
-@@ -60,12 +58,6 @@
-     return filename;
- }
- 
--//Use for file replication
--char* 
--getTorrentFilePath( const tr_session * session, const tr_info * inf ){
--    return getTorrentFilename(session, inf);
--}
--
- static char*
- getOldTorrentFilename( const tr_session * session, const tr_info * inf )
- {
-@@ -276,38 +268,13 @@
-         *walk++ = '\0';
-         assert( walk - scrape == (int)alloc_len );
-     }
--
--    return scrape;
--}
--
--static char *
--tr_convertAnnounceToFileReplication( const char * announce )
--{
--    char *       fr = NULL;
--    const char * s;
--    
--    /* To derive the scrape URL use the following steps:
--     * Begin with the announce URL. Find the last '/' in it.
--     * If the text immediately following that '/' isn't 'announce'
--     * it will be taken as a sign that that tracker doesn't support
--     * the scrape convention. If it does, substitute 'scrape' for
--     * 'announce' to find the scrape page. */
--    if( ( ( s = strrchr( announce, '/' ) ) ) && !strncmp( ++s, "announce", 8 ) )
-+    /* Some torrents with UDP annouce URLs don't have /announce. */
-+    else if ( !strncmp( announce, "udp:", 4 ) )
-     {
--        const char * prefix = announce;
--        const size_t prefix_len = s - announce;
--        const char * suffix = s + 8;
--        const size_t suffix_len = strlen( suffix );
--        const size_t alloc_len = prefix_len + 6 + suffix_len + 1;
--        char * walk = fr = tr_new( char, alloc_len );
--        memcpy( walk, prefix, prefix_len ); walk += prefix_len;
--        memcpy( walk, "filrep", 6 );        walk += 6;
--        memcpy( walk, suffix, suffix_len ); walk += suffix_len;
--        *walk++ = '\0';
--        assert( walk - fr == (int)alloc_len );
-+        scrape = tr_strdup( announce );
-     }
--    
--    return fr;
-+
-+    return scrape;
- }
- 
- static const char*
-@@ -348,7 +315,6 @@
-                         t->tier = validTiers;
-                         t->announce = url;
-                         t->scrape = tr_convertAnnounceToScrape( url );
--                        t->file_replication = tr_convertAnnounceToFileReplication( url ); //File replication
-                         t->id = trackerCount;
- 
-                         anyAdded = true;
-@@ -381,7 +347,6 @@
-             trackers[trackerCount].tier = 0;
-             trackers[trackerCount].announce = url;
-             trackers[trackerCount].scrape = tr_convertAnnounceToScrape( url );
--            trackers[trackerCount].file_replication = tr_convertAnnounceToFileReplication(url);
-             trackers[trackerCount].id = 0;
-             trackerCount++;
-             /*fprintf( stderr, "single announce: [%s]\n", url );*/
-diff -Naur ./metainfo.h ../../../tmp/Transmission/libtransmission/metainfo.h
---- ./metainfo.h	2012-06-26 12:09:49.000000000 +0200
-+++ ../../../tmp/Transmission/libtransmission/metainfo.h	2012-07-09 13:11:37.000000000 +0200
-@@ -21,8 +21,6 @@
- 
- struct tr_benc;
- 
--
--char* getTorrentFilePath( const tr_session * session, const tr_info * inf );
- bool  tr_metainfoParse( const tr_session     * session,
-                         const struct tr_benc * benc,
-                         tr_info              * setmeInfo,
-diff -Naur ./natpmp.c ../../../tmp/Transmission/libtransmission/natpmp.c
---- ./natpmp.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/natpmp.c	2012-07-09 13:11:37.000000000 +0200
-@@ -7,7 +7,7 @@
-  * This exemption does not extend to derived works not owned by
-  * the Transmission project.
-  *
-- * $Id: natpmp.c 12225 2011-03-24 22:57:39Z jordan $
-+ * $Id: natpmp.c 13263 2012-04-07 00:12:57Z jordan $
-  */
- 
- #include <errno.h>
-@@ -17,10 +17,10 @@
- #include <event2/util.h> /* evutil_inet_ntop() */
- 
- #define ENABLE_STRNATPMPERR
--#include <libnatpmp/natpmp.h>
-+#include "natpmp.h"
- 
- #include "transmission.h"
--#include "natpmp.h"
-+#include "natpmp_local.h"
- #include "net.h" /* tr_netCloseSocket */
- #include "port-forwarding.h"
- #include "utils.h"
-@@ -120,7 +120,7 @@
- 
-     if( is_enabled && ( nat->state == TR_NATPMP_DISCOVER ) )
-     {
--        int val = initnatpmp( &nat->natpmp );
-+        int val = initnatpmp( &nat->natpmp, 0, 0 );
-         logVal( "initnatpmp", val );
-         val = sendpublicaddressrequest( &nat->natpmp );
-         logVal( "sendpublicaddressrequest", val );
-diff -Naur ./natpmp.h ../../../tmp/Transmission/libtransmission/natpmp.h
---- ./natpmp.h	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/natpmp.h	1970-01-01 01:00:00.000000000 +0100
-@@ -1,34 +0,0 @@
--/*
-- * This file Copyright (C) Mnemosyne LLC
-- *
-- * This file is licensed by the GPL version 2. Works owned by the
-- * Transmission project are granted a special exemption to clause 2(b)
-- * so that the bulk of its code can remain under the MIT license.
-- * This exemption does not extend to derived works not owned by
-- * the Transmission project.
-- *
-- * $Id: natpmp.h 12204 2011-03-22 15:19:54Z jordan $
-- */
--
--#ifndef __TRANSMISSION__
--#error only libtransmission should #include this header.
--#endif
--
--#ifndef TR_NATPMP_H
--#define TR_NATPMP_H 1
--
--/**
-- * @addtogroup port_forwarding Port Forwarding
-- * @{
-- */
--
--typedef struct tr_natpmp tr_natpmp;
--
--tr_natpmp * tr_natpmpInit( void );
--
--void tr_natpmpClose( tr_natpmp * );
--
--int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
--
--/* @} */
--#endif
-diff -Naur ./natpmp_local.h ../../../tmp/Transmission/libtransmission/natpmp_local.h
---- ./natpmp_local.h	1970-01-01 01:00:00.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/natpmp_local.h	2012-07-09 13:11:37.000000000 +0200
-@@ -0,0 +1,34 @@
-+/*
-+ * This file Copyright (C) Mnemosyne LLC
-+ *
-+ * This file is licensed by the GPL version 2. Works owned by the
-+ * Transmission project are granted a special exemption to clause 2(b)
-+ * so that the bulk of its code can remain under the MIT license.
-+ * This exemption does not extend to derived works not owned by
-+ * the Transmission project.
-+ *
-+ * $Id: natpmp.h 12204 2011-03-22 15:19:54Z jordan $
-+ */
-+
-+#ifndef __TRANSMISSION__
-+#error only libtransmission should #include this header.
-+#endif
-+
-+#ifndef TR_NATPMP_H
-+#define TR_NATPMP_H 1
-+
-+/**
-+ * @addtogroup port_forwarding Port Forwarding
-+ * @{
-+ */
-+
-+typedef struct tr_natpmp tr_natpmp;
-+
-+tr_natpmp * tr_natpmpInit( void );
-+
-+void tr_natpmpClose( tr_natpmp * );
-+
-+int tr_natpmpPulse( tr_natpmp *, tr_port port, bool isEnabled, tr_port * public_port );
-+
-+/* @} */
-+#endif
-diff -Naur ./net.c ../../../tmp/Transmission/libtransmission/net.c
---- ./net.c	2011-11-15 09:27:22.000000000 +0100
-+++ ../../../tmp/Transmission/libtransmission/net.c	2012-07-09 13:11:37.000000000 +0200
-@@ -1,6 +1,6 @@
- /******************************************************************************
-  *
-- * $Id: net.c 12954 2011-10-08 23:53:27Z jordan $
-+ * $Id: net.c 13329 2012-05-30 17:47:29Z jordan $
-  *
-  * Copyright (c) Transmission authors and contributors
-  *
-@@ -38,6 +38,8 @@
- 
- #include <event2/util.h>
- 
-+#include <libutp/utp.h>
-+
- #include "transmission.h"
- #include "fdlimit.h" /* tr_fdSocketClose() */
- #include "net.h"
diff -Naur ./peer-io.c ../../../tmp/Transmission/libtransmission/peer-io.c
--- ./peer-io.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/peer-io.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: peer-io.c 12954 2011-10-08 23:53:27Z jordan $
+ * $Id: peer-io.c 13329 2012-05-30 17:47:29Z jordan $
  */
 
 #include <assert.h>
@@ -18,6 +18,8 @@
 #include <event2/buffer.h>
 #include <event2/bufferevent.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "session.h"
 #include "bandwidth.h"
diff -Naur ./peer-mgr.c ../../../tmp/Transmission/libtransmission/peer-mgr.c
--- ./peer-mgr.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/peer-mgr.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: peer-mgr.c 12954 2011-10-08 23:53:27Z jordan $
+ * $Id: peer-mgr.c 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #include <assert.h>
@@ -18,6 +18,8 @@
 
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "announcer.h"
 #include "bandwidth.h"
@@ -2492,11 +2494,21 @@
         const float true_count = tr_bitfieldCountTrueBits( have );
 
         if( tr_torrentHasMetadata( tor ) )
+        {
             peer->progress = true_count / tor->info.pieceCount;
+        }
         else /* without pieceCount, this result is only a best guess... */
+        {
             peer->progress = true_count / ( have->bit_count + 1 );
+        }
     }
 
+    /* clamp the progress range */
+    if ( peer->progress < 0.0 )
+        peer->progress = 0.0;
+    if ( peer->progress > 1.0 )
+        peer->progress = 1.0;
+
     if( peer->atom && ( peer->progress >= 1.0 ) )
         atomSetSeed( tor->torrentPeers, peer->atom );
 }
@@ -2664,7 +2676,7 @@
     assert( webseedCount == tor->info.webseedCount );
 
     for( i=0; i<webseedCount; ++i ) {
-        int Bps;
+        unsigned int Bps;
         if( tr_webseedGetSpeed_Bps( webseeds[i], now, &Bps ) )
             ret[i] = Bps / (double)tr_speed_K;
         else
@@ -2674,7 +2686,7 @@
     return ret;
 }
 
-int
+unsigned int
 tr_peerGetPieceSpeed_Bps( const tr_peer * peer, uint64_t now, tr_direction direction )
 {
     return peer->io ? tr_peerIoGetPieceSpeed_Bps( peer->io, now, direction ) : 0.0;
@@ -3011,7 +3023,7 @@
 static int
 getRate( const tr_torrent * tor, struct peer_atom * atom, uint64_t now )
 {
-    int Bps;
+    unsigned int Bps;
 
     if( tr_torrentIsSeed( tor ) )
         Bps = tr_peerGetPieceSpeed_Bps( atom->peer, now, TR_CLIENT_TO_PEER );
@@ -3037,8 +3049,8 @@
     if( !tr_bandwidthIsLimited( b, dir ) )
         return false;
     else {
-        const int got = tr_bandwidthGetPieceSpeed_Bps( b, now_msec, dir );
-        const int want = tr_bandwidthGetDesiredSpeed_Bps( b, dir );
+        const unsigned int got = tr_bandwidthGetPieceSpeed_Bps( b, now_msec, dir );
+        const unsigned int want = tr_bandwidthGetDesiredSpeed_Bps( b, dir );
         return got >= want;
     }
 }
@@ -3832,22 +3844,105 @@
     return score;
 }
 
-/* sort an array of peer candidates */
+#ifndef NDEBUG
 static int
-comparePeerCandidates( const void * va, const void * vb )
+checkPartition( const struct peer_candidate * candidates, int left, int right, uint64_t pivotScore, int storeIndex )
 {
-    const struct peer_candidate * a = va;
-    const struct peer_candidate * b = vb;
+    int i;
 
-    if( a->score < b->score ) return -1;
-    if( a->score > b->score ) return 1;
+    assert( storeIndex >= left );
+    assert( storeIndex <= right );
+    assert( candidates[storeIndex].score == pivotScore );
+
+    for( i=left; i<storeIndex; ++i )
+        assert( candidates[i].score < pivotScore );
+    for( i=storeIndex+1; i<=right; ++i )
+        assert( candidates[i].score >= pivotScore );
 
-    return 0;
+    return true;
 }
+#endif
+
+/* Helper to selectBestCandidates().
+ * Adapted from http://en.wikipedia.org/wiki/Selection_algorithm */
+static int
+partitionPeerCandidates( struct peer_candidate * candidates, int left, int right, int pivotIndex )
+{
+    int i;
+    int storeIndex;
+    struct peer_candidate tmp;
+    const struct peer_candidate pivotValue = candidates[pivotIndex];
+
+    /* move pivot to end */
+    tmp = candidates[right];
+    candidates[right] = pivotValue;
+    candidates[pivotIndex] = tmp;
+
+    storeIndex = left;
+    for( i=left; i<=right; ++i )
+    {
+        if( candidates[i].score < pivotValue.score )
+        {
+            tmp = candidates[storeIndex];
+            candidates[storeIndex] = candidates[i];
+            candidates[i] = tmp;
+            storeIndex++;
+        }
+    }
+
+    /* move pivot to its final place */
+    tmp = candidates[right];
+    candidates[right] = candidates[storeIndex];
+    candidates[storeIndex] = tmp;
+
+    /* sanity check */
+    assert( checkPartition( candidates, left, right, pivotValue.score, storeIndex ) );
+
+    return storeIndex;
+}
+
+/* Adapted from http://en.wikipedia.org/wiki/Selection_algorithm */
+static void
+selectPeerCandidates( struct peer_candidate * candidates, int left, int right, int k )
+{
+    if( right > left )
+    {
+        const int pivotIndex = left + (right-left)/2;
+
+        int pivotNewIndex = partitionPeerCandidates( candidates, left, right, pivotIndex );
+
+        if( pivotNewIndex > left + k ) /* new condition */
+            selectPeerCandidates( candidates, left, pivotNewIndex-1, k );
+        else if( pivotNewIndex < left + k )
+            selectPeerCandidates( candidates, pivotNewIndex+1, right, k+left-pivotNewIndex-1 );
+    }
+}
+
+#ifndef NDEBUG
+static bool
+checkBestScoresComeFirst( const struct peer_candidate * candidates, int n, int k )
+{
+    int i;
+    uint64_t worstFirstScore = 0;
+    const int x = MIN( n, k ) - 1;
+
+    for( i=0; i<x; i++ )
+        if( worstFirstScore < candidates[i].score )
+            worstFirstScore = candidates[i].score;
+
+    for( i=0; i<x; i++ )
+        assert( candidates[i].score <= worstFirstScore );
+
+    for( i=x+1; i<n; i++ )
+        assert( candidates[i].score >= worstFirstScore );
+
+    return true;
+}
+#endif /* NDEBUG */
 
 /** @return an array of all the atoms we might want to connect to */
 static struct peer_candidate*
-getPeerCandidates( tr_session * session, int * candidateCount )
+getPeerCandidates( tr_session * session, int * candidateCount, int max )
 {
     int atomCount;
     int peerCount;
@@ -3912,8 +4007,11 @@
     }
 
     *candidateCount = walk - candidates;
-    if( *candidateCount > 1 )
-        qsort( candidates, *candidateCount, sizeof( struct peer_candidate ), comparePeerCandidates );
+    if( walk != candidates )
+        selectPeerCandidates( candidates, 0, (walk-candidates)-1, max );
+
+    assert( checkBestScoresComeFirst( candidates, *candidateCount, max ) );
+
     return candidates;
 }
 
@@ -3990,7 +4088,7 @@
     int i, n;
     struct peer_candidate * candidates;
 
-    candidates = getPeerCandidates( mgr->session, &n );
+    candidates = getPeerCandidates( mgr->session, &n, max );
 
     for( i=0; i<n && i<max; ++i )
         initiateCandidateConnection( mgr, &candidates[i] );
diff -Naur ./peer-mgr.h ../../../tmp/Transmission/libtransmission/peer-mgr.h
--- ./peer-mgr.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/peer-mgr.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: peer-mgr.h 12539 2011-07-10 15:24:51Z jordan $
+ * $Id: peer-mgr.h 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #ifndef __TRANSMISSION__
@@ -248,9 +248,9 @@
 double* tr_peerMgrWebSpeeds_KBps( const tr_torrent * tor );
 
 
-int tr_peerGetPieceSpeed_Bps( const tr_peer    * peer,
-                              uint64_t           now,
-                              tr_direction       direction );
+unsigned int tr_peerGetPieceSpeed_Bps( const tr_peer    * peer,
+                                       uint64_t           now,
+                                       tr_direction       direction );
 
 void tr_peerMgrClearInterest( tr_torrent * tor );
 
diff -Naur ./peer-msgs.c ../../../tmp/Transmission/libtransmission/peer-msgs.c
--- ./peer-msgs.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/peer-msgs.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: peer-msgs.c 12921 2011-09-26 22:50:42Z jordan $
+ * $Id: peer-msgs.c 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #include <assert.h>
@@ -16,8 +16,6 @@
 #include <stdlib.h>
 #include <string.h>
 
-#include <alloca.h>
-
 #include <event2/buffer.h>
 #include <event2/bufferevent.h>
 #include <event2/event.h>
@@ -241,6 +239,7 @@
         char              timestr[64];
         struct evbuffer * buf = evbuffer_new( );
         char *            base = tr_basename( file );
+        char *            message;
 
         evbuffer_add_printf( buf, "[%s] %s - %s [%s]: ",
                              tr_getLogTimeStr( timestr, sizeof( timestr ) ),
@@ -251,10 +250,12 @@
         evbuffer_add_vprintf( buf, fmt, args );
         va_end( args );
         evbuffer_add_printf( buf, " (%s:%d)\n", base, line );
-        fputs( (const char*)evbuffer_pullup( buf, -1 ), fp );
+
+        message = evbuffer_free_to_str( buf );
+        fputs( message, fp );
 
         tr_free( base );
-        evbuffer_free( buf );
+        tr_free( message );
     }
 }
 
@@ -1675,8 +1676,8 @@
     else
     {
         int estimatedBlocksInPeriod;
-        int rate_Bps;
-        int irate_Bps;
+        unsigned int rate_Bps;
+        unsigned int irate_Bps;
         const int floor = 4;
         const int seconds = REQUEST_BUF_SECS;
         const uint64_t now = tr_time_msec( );
@@ -1688,8 +1689,8 @@
             rate_Bps = MIN( rate_Bps, tr_torrentGetSpeedLimit_Bps( torrent, TR_PEER_TO_CLIENT ) );
 
         /* honor the session limits, if enabled */
-        if( tr_torrentUsesSessionLimits( torrent ) )
-            if( tr_sessionGetActiveSpeedLimit_Bps( torrent->session, TR_PEER_TO_CLIENT, &irate_Bps ) )
+        if( tr_torrentUsesSessionLimits( torrent ) 
+	&&  tr_sessionGetActiveSpeedLimit_Bps( torrent->session, TR_PEER_TO_CLIENT, &irate_Bps ) )
                 rate_Bps = MIN( rate_Bps, irate_Bps );
 
         /* use this desired rate to figure out how
@@ -1748,7 +1749,7 @@
         int i;
         int n;
         const int numwant = msgs->desiredRequestCount - msgs->peer->pendingReqsToPeer;
-        tr_block_index_t * blocks = alloca( sizeof( tr_block_index_t ) * numwant );
+        tr_block_index_t * blocks = tr_new( tr_block_index_t, numwant );
 
         tr_peerMgrGetNextRequests( msgs->torrent, msgs->peer, numwant, blocks, &n, false );
 
@@ -1758,6 +1759,8 @@
             blockToReq( msgs->torrent, blocks[i], &req );
             protocolSendRequest( msgs, &req );
         }
+
+        tr_free( blocks );
     }
 }
 
diff -Naur ./port-forwarding.c ../../../tmp/Transmission/libtransmission/port-forwarding.c
--- ./port-forwarding.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/port-forwarding.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: port-forwarding.c 12228 2011-03-25 01:41:57Z jordan $
+ * $Id: port-forwarding.c 13199 2012-02-04 01:28:15Z jordan $
  */
 
 #include <assert.h>
@@ -18,7 +18,7 @@
 #include <event2/event.h>
 
 #include "transmission.h"
-#include "natpmp.h"
+#include "natpmp_local.h"
 #include "net.h"
 #include "peer-mgr.h"
 #include "port-forwarding.h"
diff -Naur ./rpc-server.c ../../../tmp/Transmission/libtransmission/rpc-server.c
--- ./rpc-server.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/rpc-server.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: rpc-server.c 12930 2011-09-27 22:34:52Z livings124 $
+ * $Id: rpc-server.c 13226 2012-02-15 01:44:21Z jordan $
  */
 
 #include <assert.h>
@@ -160,7 +160,7 @@
     size_t inlen = evbuffer_get_length( body );
 
     const char * boundary_key = "boundary=";
-    const char * boundary_key_begin = strstr( content_type, boundary_key );
+    const char * boundary_key_begin = content_type ? strstr( content_type, boundary_key ) : NULL;
     const char * boundary_val = boundary_key_begin ? boundary_key_begin + strlen( boundary_key ) : "arglebargle";
     char * boundary = tr_strdup_printf( "--%s", boundary_val );
     const size_t boundary_len = strlen( boundary );
diff -Naur ./rpcimpl.c ../../../tmp/Transmission/libtransmission/rpcimpl.c
--- ./rpcimpl.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/rpcimpl.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: rpcimpl.c 12990 2011-10-17 12:44:17Z jordan $
+ * $Id: rpcimpl.c 13359 2012-07-01 01:42:58Z jordan $
  */
 
 #include <assert.h>
@@ -523,7 +523,7 @@
 
     for( i = 0; i < peerCount; ++i )
     {
-        tr_benc *            d = tr_bencListAddDict( list, 14 );
+        tr_benc *            d = tr_bencListAddDict( list, 16 );
         const tr_peer_stat * peer = peers + i;
         tr_bencDictAddStr ( d, "address", peer->addr );
         tr_bencDictAddStr ( d, "clientName", peer->client );
@@ -637,7 +637,7 @@
         tr_bencDictAddInt( d, key, st->peersConnected );
     else if( tr_streq( key, keylen, "peersFrom" ) )
     {
-        tr_benc *   tmp = tr_bencDictAddDict( d, key, 6 );
+        tr_benc *   tmp = tr_bencDictAddDict( d, key, 7 );
         const int * f = st->peersFrom;
         tr_bencDictAddInt( tmp, "fromCache",    f[TR_PEER_FROM_RESUME] );
         tr_bencDictAddInt( tmp, "fromDht",      f[TR_PEER_FROM_DHT] );
diff -Naur ./session.c ../../../tmp/Transmission/libtransmission/session.c
--- ./session.c	2012-06-20 17:01:15.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/session.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: session.c 12649 2011-08-08 16:29:47Z jordan $
+ * $Id: session.c 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #include <assert.h>
@@ -24,6 +24,8 @@
 #include <event2/dns.h> /* evdns_base_free() */
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 //#define TR_SHOW_DEPRECATED
 #include "transmission.h"
 #include "announcer.h"
@@ -1215,7 +1217,7 @@
 ***/
 
 bool
-tr_sessionGetActiveSpeedLimit_Bps( const tr_session * session, tr_direction dir, int * setme_Bps )
+tr_sessionGetActiveSpeedLimit_Bps( const tr_session * session, tr_direction dir, unsigned int * setme_Bps )
 {
     int isLimited = true;
 
@@ -1236,7 +1238,7 @@
                                     tr_direction        dir,
                                     double            * setme_KBps )
 {
-    int Bps = 0;
+    unsigned int Bps = 0;
     const bool is_active = tr_sessionGetActiveSpeedLimit_Bps( session, dir, &Bps );
     *setme_KBps = toSpeedKBps( Bps );
     return is_active;
@@ -1245,7 +1247,7 @@
 static void
 updateBandwidth( tr_session * session, tr_direction dir )
 {
-    int limit_Bps = 0;
+    unsigned int limit_Bps = 0;
     const bool isLimited = tr_sessionGetActiveSpeedLimit_Bps( session, dir, &limit_Bps );
     const bool zeroCase = isLimited && !limit_Bps;
 
@@ -1392,23 +1394,22 @@
 ***/
 
 void
-tr_sessionSetSpeedLimit_Bps( tr_session * s, tr_direction d, int Bps )
+tr_sessionSetSpeedLimit_Bps( tr_session * s, tr_direction d, unsigned int Bps )
 {
     assert( tr_isSession( s ) );
     assert( tr_isDirection( d ) );
-    assert( Bps >= 0 );
 
     s->speedLimit_Bps[d] = Bps;
 
     updateBandwidth( s, d );
 }
 void
-tr_sessionSetSpeedLimit_KBps( tr_session * s, tr_direction d, int KBps )
+tr_sessionSetSpeedLimit_KBps( tr_session * s, tr_direction d, unsigned int KBps )
 {
     tr_sessionSetSpeedLimit_Bps( s, d, toSpeedBytes( KBps ) );
 }
 
-int
+unsigned int
 tr_sessionGetSpeedLimit_Bps( const tr_session * s, tr_direction d )
 {
     assert( tr_isSession( s ) );
@@ -1416,7 +1417,7 @@
 
     return s->speedLimit_Bps[d];
 }
-int
+unsigned int
 tr_sessionGetSpeedLimit_KBps( const tr_session * s, tr_direction d )
 {
     return toSpeedKBps( tr_sessionGetSpeedLimit_Bps( s, d ) );
@@ -1448,11 +1449,10 @@
 ***/
 
 void
-tr_sessionSetAltSpeed_Bps( tr_session * s, tr_direction d, int Bps )
+tr_sessionSetAltSpeed_Bps( tr_session * s, tr_direction d, unsigned int Bps )
 {
     assert( tr_isSession( s ) );
     assert( tr_isDirection( d ) );
-    assert( Bps >= 0 );
 
     s->turtle.speedLimit_Bps[d] = Bps;
 
@@ -1460,12 +1460,12 @@
 }
 
 void
-tr_sessionSetAltSpeed_KBps( tr_session * s, tr_direction d, int KBps )
+tr_sessionSetAltSpeed_KBps( tr_session * s, tr_direction d, unsigned int KBps )
 {
     tr_sessionSetAltSpeed_Bps( s, d, toSpeedBytes( KBps ) );
 }
 
-int
+unsigned int
 tr_sessionGetAltSpeed_Bps( const tr_session * s, tr_direction d )
 {
     assert( tr_isSession( s ) );
@@ -1473,7 +1473,7 @@
 
     return s->turtle.speedLimit_Bps[d];
 }
-int
+unsigned int
 tr_sessionGetAltSpeed_KBps( const tr_session * s, tr_direction d )
 {
     return toSpeedKBps( tr_sessionGetAltSpeed_Bps( s, d ) );
@@ -1682,13 +1682,13 @@
 ****
 ***/
 
-int
+unsigned int
 tr_sessionGetPieceSpeed_Bps( const tr_session * session, tr_direction dir )
 {
     return tr_isSession( session ) ? tr_bandwidthGetPieceSpeed_Bps( &session->bandwidth, 0, dir ) : 0;
 }
 
-int
+unsigned int
 tr_sessionGetRawSpeed_Bps( const tr_session * session, tr_direction dir )
 {
     return tr_isSession( session ) ? tr_bandwidthGetRawSpeed_Bps( &session->bandwidth, 0, dir ) : 0;
@@ -2675,7 +2675,6 @@
     assert( minutes > 0 );
 
     session->queueStalledMinutes = minutes;
-   
 }
 
 void
@@ -2686,7 +2685,7 @@
 
     session->stalledEnabled = is_enabled;
 }
-  
+
 bool
 tr_sessionGetQueueStalledEnabled( const tr_session * session )
 {
diff -Naur ./session.h ../../../tmp/Transmission/libtransmission/session.h
--- ./session.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/session.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: session.h 12640 2011-08-07 19:24:33Z jordan $
+ * $Id: session.h 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #ifndef __TRANSMISSION__
@@ -56,7 +56,7 @@
 struct tr_turtle_info
 {
     /* TR_UP and TR_DOWN speed limits */
-    int speedLimit_Bps[2];
+    unsigned int speedLimit_Bps[2];
 
     /* is turtle mode on right now? */
     bool isEnabled;
@@ -118,7 +118,7 @@
 
     int                          umask;
 
-    int                          speedLimit_Bps[2];
+    unsigned int                 speedLimit_Bps[2];
     bool                         speedLimitEnabled[2];
 
     struct tr_turtle_info        turtle;
@@ -292,26 +292,30 @@
 ****
 ***/
 
-static inline unsigned int toSpeedBytes ( unsigned int KBps ) { return KBps * tr_speed_K; }
-static inline double       toSpeedKBps  ( unsigned int Bps )  { return Bps / (double)tr_speed_K; }
-
-static inline uint64_t toMemBytes ( unsigned int MB ) { uint64_t B = tr_mem_K * tr_mem_K; B *= MB; return B; }
-static inline int      toMemMB    ( uint64_t B )      { return B / ( tr_mem_K * tr_mem_K ); }
+static inline unsigned int
+toSpeedBytes ( unsigned int KBps ) { return KBps * tr_speed_K; }
+static inline double
+toSpeedKBps  ( unsigned int Bps )  { return Bps / (double)tr_speed_K; }
+
+static inline uint64_t
+toMemBytes ( unsigned int MB ) { uint64_t B = tr_mem_K * tr_mem_K; B *= MB; return B; }
+static inline int
+toMemMB    ( uint64_t B )      { return B / ( tr_mem_K * tr_mem_K ); }
 
 /**
 **/
 
-int  tr_sessionGetSpeedLimit_Bps( const tr_session *, tr_direction );
-int  tr_sessionGetAltSpeed_Bps  ( const tr_session *, tr_direction );
-int  tr_sessionGetRawSpeed_Bps  ( const tr_session *, tr_direction );
-int  tr_sessionGetPieceSpeed_Bps( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetSpeedLimit_Bps( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetAltSpeed_Bps  ( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetRawSpeed_Bps  ( const tr_session *, tr_direction );
+unsigned int  tr_sessionGetPieceSpeed_Bps( const tr_session *, tr_direction );
 
-void tr_sessionSetSpeedLimit_Bps( tr_session *, tr_direction, int Bps );
-void tr_sessionSetAltSpeed_Bps  ( tr_session *, tr_direction, int Bps );
+void tr_sessionSetSpeedLimit_Bps( tr_session *, tr_direction, unsigned int Bps );
+void tr_sessionSetAltSpeed_Bps  ( tr_session *, tr_direction, unsigned int Bps );
 
 bool  tr_sessionGetActiveSpeedLimit_Bps( const tr_session  * session,
                                          tr_direction        dir,
-                                         int               * setme );
+                                         unsigned int      * setme );
 
 tr_torrent * tr_sessionGetNextQueuedSeed( tr_session * session );
 tr_torrent * tr_sessionGetNextQueuedTorrent( tr_session * session, tr_direction );
diff -Naur ./stats.c ../../../tmp/Transmission/libtransmission/stats.c
--- ./stats.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/stats.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: stats.c 12204 2011-03-22 15:19:54Z jordan $
+ * $Id: stats.c 13363 2012-07-01 04:00:27Z jordan $
  */
 
 #include "transmission.h"
@@ -210,6 +210,7 @@
     zero.sessionCount = 0;
     zero.secondsActive = 0;
 
+    session->sessionStats->isDirty = true;
     session->sessionStats->single = session->sessionStats->old = zero;
     session->sessionStats->startTime = tr_time( );
 }
diff -Naur ./torrent.c ../../../tmp/Transmission/libtransmission/torrent.c
--- ./torrent.c	2012-06-26 11:38:03.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/torrent.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: torrent.c 13080 2011-11-10 03:31:43Z jordan $
+ * $Id: torrent.c 13362 2012-07-01 03:05:36Z jordan $
  */
 
 #include <signal.h> /* signal() */
@@ -153,7 +153,7 @@
 tr_torrentIsPieceTransferAllowed( const tr_torrent  * tor,
                                   tr_direction        direction )
 {
-    int limit;
+    unsigned int limit;
     bool allowed = true;
 
     if( tr_torrentUsesSpeedLimit( tor, direction ) )
@@ -173,22 +173,21 @@
 ***/
 
 void
-tr_torrentSetSpeedLimit_Bps( tr_torrent * tor, tr_direction dir, int Bps )
+tr_torrentSetSpeedLimit_Bps( tr_torrent * tor, tr_direction dir, unsigned int Bps )
 {
     assert( tr_isTorrent( tor ) );
     assert( tr_isDirection( dir ) );
-    assert( Bps >= 0 );
 
     if( tr_bandwidthSetDesiredSpeed_Bps( &tor->bandwidth, dir, Bps ) )
         tr_torrentSetDirty( tor );
 }
 void
-tr_torrentSetSpeedLimit_KBps( tr_torrent * tor, tr_direction dir, int KBps )
+tr_torrentSetSpeedLimit_KBps( tr_torrent * tor, tr_direction dir, unsigned int KBps )
 {
     tr_torrentSetSpeedLimit_Bps( tor, dir, toSpeedBytes( KBps ) );
 }
 
-int
+unsigned int
 tr_torrentGetSpeedLimit_Bps( const tr_torrent * tor, tr_direction dir )
 {
     assert( tr_isTorrent( tor ) );
@@ -196,7 +195,7 @@
 
     return tr_bandwidthGetDesiredSpeed_Bps( &tor->bandwidth, dir );
 }
-int
+unsigned int
 tr_torrentGetSpeedLimit_KBps( const tr_torrent * tor, tr_direction dir )
 {
     return toSpeedKBps( tr_torrentGetSpeedLimit_Bps( tor, dir ) );
@@ -884,7 +883,7 @@
     if( tr_ctorGetSave( ctor ) )
     {
         const tr_benc * val;
-        if( !tr_ctorGetMetainfo( ctor, &val) || tor->isFileReplicated)
+        if( !tr_ctorGetMetainfo( ctor, &val ) )
         {
             const char * path = tor->info.torrent;
             const int err = tr_bencToFile( val, TR_FMT_BENC, path );
@@ -909,11 +908,6 @@
     tr_sessionUnlock( session );
 }
 
-void fileRepTorrentInit( tr_torrent * tor){
-    tr_ctor* ctor   = tr_ctorNew(tor->session);
-    torrentInit(tor, ctor);
-}
-
 static tr_parse_result
 torrentParseImpl( const tr_ctor * ctor, tr_info * setmeInfo,
                   bool * setmeHasInfo, int * dictLength )
@@ -2727,8 +2721,6 @@
     }
 }
 
-static bool fileExists( const char * filename, time_t * optional_mtime );
-
 /**
  * This convoluted code does something (seemingly) simple:
  * remove the torrent's local files.
@@ -2767,12 +2759,12 @@
     for( f=0; f<tor->info.fileCount; ++f )
     {
         char * filename = tr_buildPath( top, tor->info.files[f].name, NULL );
-        if( !fileExists( filename, NULL ) ) {
+        if( !tr_fileExists( filename, NULL ) ) {
                 char * partial = tr_torrentBuildPartial( tor, f );
                 tr_free( filename );
                 filename = tr_buildPath( top, partial, NULL );
                 tr_free( partial );
-                if( !fileExists( filename, NULL ) ) {
+                if( !tr_fileExists( filename, NULL ) ) {
                         tr_free( filename );
                         filename = NULL;
                 }
@@ -2819,7 +2811,7 @@
     for( i=0, n=tr_ptrArraySize(&files); i<n; ++i )
     {
         char * walk = tr_strdup( tr_ptrArrayNth( &files, i ) );
-        while( fileExists( walk, NULL ) && !tr_is_same_file( tmpdir, walk ) )
+        while( tr_fileExists( walk, NULL ) && !tr_is_same_file( tmpdir, walk ) )
         {
             char * tmp = tr_dirname( walk );
             func( walk );
@@ -2838,13 +2830,9 @@
     /* build a list of 'top's child directories that belong to this torrent */
     for( f=0; f<tor->info.fileCount; ++f )
     {
-        char * dir;
-        char * filename;
-
         /* get the directory that this file goes in... */
-        filename = tr_buildPath( top, tor->info.files[f].name, NULL );
-        dir = tr_dirname( filename );
-        tr_free( filename );
+        char * filename = tr_buildPath( top, tor->info.files[f].name, NULL );
+        char * dir = tr_dirname( filename );
         if( !tr_is_same_file( top, dir ) && strcmp( top, dir ) ) {
             for( ;; ) {
                 char * parent = tr_dirname( dir );
@@ -2858,6 +2846,8 @@
                 dir = parent;
             }
         }
+        tr_free( dir );
+        tr_free( filename );
     }
     for( i=0, n=tr_ptrArraySize(&folders); i<n; ++i )
         removeEmptyFoldersAndJunkFiles( tr_ptrArrayNth( &folders, i ) );
@@ -3061,25 +3051,6 @@
 ****
 ***/
 
-#ifdef SYS_DARWIN
- #define TR_STAT_MTIME(sb) ((sb).st_mtimespec.tv_sec)
-#else
- #define TR_STAT_MTIME(sb) ((sb).st_mtime)
-#endif
-
-
-static bool
-fileExists( const char * filename, time_t * mtime )
-{
-    struct stat sb;
-    const bool ok = !stat( filename, &sb );
-
-    if( ok && ( mtime != NULL ) )
-        *mtime = TR_STAT_MTIME( sb );
-
-    return ok;
-}
-
 bool
 tr_torrentFindFile2( const tr_torrent * tor, tr_file_index_t fileNum,
                      const char ** base, char ** subpath, time_t * mtime )
@@ -3096,7 +3067,7 @@
 
     if( b == NULL ) {
         char * filename = tr_buildPath( tor->downloadDir, file->name, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->downloadDir;
             s = file->name;
         }
@@ -3105,7 +3076,7 @@
 
     if( ( b == NULL ) && ( tor->incompleteDir != NULL ) ) {
         char * filename = tr_buildPath( tor->incompleteDir, file->name, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->incompleteDir;
             s = file->name;
         }
@@ -3117,7 +3088,7 @@
 
     if( ( b == NULL ) && ( tor->incompleteDir != NULL ) ) {
         char * filename = tr_buildPath( tor->incompleteDir, part, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->incompleteDir;
             s = part;
         }
@@ -3126,7 +3097,7 @@
 
     if( b == NULL) {
         char * filename = tr_buildPath( tor->downloadDir, part, NULL );
-        if( fileExists( filename, mtime ) ) {
+        if( tr_fileExists( filename, mtime ) ) {
             b = tor->downloadDir;
             s = part;
         }
diff -Naur ./torrent.h ../../../tmp/Transmission/libtransmission/torrent.h
--- ./torrent.h	2012-06-26 10:59:44.000000000 +0200
+++ ../../../tmp/Transmission/libtransmission/torrent.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: torrent.h 12617 2011-08-03 23:40:51Z jordan $
+ * $Id: torrent.h 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #ifndef __TRANSMISSION__
@@ -134,9 +134,6 @@
 /** @brief Torrent object */
 struct tr_torrent
 {
-    //Used for file replication
-    bool                     isFileReplicated;
-    
     tr_session *             session;
     tr_info                  info;
 
@@ -417,8 +414,8 @@
  * piece size, etc. such as in BEP 9 where peers exchange metadata */
 void tr_torrentGotNewInfoDict( tr_torrent * tor );
 
-void tr_torrentSetSpeedLimit_Bps  ( tr_torrent *, tr_direction, int Bps );
-int tr_torrentGetSpeedLimit_Bps  ( const tr_torrent *, tr_direction );
+void tr_torrentSetSpeedLimit_Bps  ( tr_torrent *, tr_direction, unsigned int Bps );
+unsigned int tr_torrentGetSpeedLimit_Bps  ( const tr_torrent *, tr_direction );
 
 /**
  * @return true if this piece needs to be tested
@@ -449,7 +446,4 @@
     return tr_torrentIsSeed( tor ) ? TR_UP : TR_DOWN;
 }
 
-/* FILEREP needed to create dynamic file replication torrent */
-void fileRepTorrentInit( tr_torrent * tor);
-
 #endif
diff -Naur ./tr-udp.c ../../../tmp/Transmission/libtransmission/tr-udp.c
--- ./tr-udp.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/tr-udp.c	2012-07-09 13:11:37.000000000 +0200
@@ -29,6 +29,8 @@
 
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "net.h"
 #include "session.h"
diff -Naur ./tr-utp.c ../../../tmp/Transmission/libtransmission/tr-utp.c
--- ./tr-utp.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/tr-utp.c	2012-07-09 13:11:37.000000000 +0200
@@ -25,6 +25,8 @@
 
 #include <event2/event.h>
 
+#include <libutp/utp.h>
+
 #include "transmission.h"
 #include "net.h"
 #include "session.h"
diff -Naur ./tr-utp.h ../../../tmp/Transmission/libtransmission/tr-utp.h
--- ./tr-utp.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/tr-utp.h	2012-07-09 13:11:37.000000000 +0200
@@ -28,9 +28,6 @@
 #ifndef _TR_UTP_H_
 #define _TR_UTP_H_
 
-/* this is included *after* transmission.h s.t. we get bool defined */
-#include <libutp/utp.h>
-
 int tr_utpPacket(const unsigned char *buf, size_t buflen,
                  const struct sockaddr *from, socklen_t fromlen,
                  tr_session *ss);
diff -Naur ./transmission.h ../../../tmp/Transmission/libtransmission/transmission.h
--- ./transmission.h	2011-12-05 13:30:48.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/transmission.h	2012-07-09 13:11:37.000000000 +0200
@@ -1,5 +1,5 @@
 /******************************************************************************
- * $Id: transmission.h 12772 2011-08-27 23:54:10Z livings124 $
+ * $Id: transmission.h 13361 2012-07-01 02:17:35Z jordan $
  *
  * Copyright (c) Transmission authors and contributors
  *
@@ -652,8 +652,8 @@
 ****  Primary session speed limits
 ***/
 
-void  tr_sessionSetSpeedLimit_KBps ( tr_session *, tr_direction, int KBps );
-int   tr_sessionGetSpeedLimit_KBps ( const tr_session *, tr_direction );
+void         tr_sessionSetSpeedLimit_KBps ( tr_session *, tr_direction, unsigned int KBps );
+unsigned int tr_sessionGetSpeedLimit_KBps ( const tr_session *, tr_direction );
 
 void  tr_sessionLimitSpeed         ( tr_session *, tr_direction, bool );
 bool  tr_sessionIsSpeedLimited     ( const tr_session *, tr_direction );
@@ -663,8 +663,8 @@
 ****  Alternative speed limits that are used during scheduled times
 ***/
 
-void     tr_sessionSetAltSpeed_KBps   ( tr_session *, tr_direction, int Bps );
-int      tr_sessionGetAltSpeed_KBps   ( const tr_session *, tr_direction );
+void         tr_sessionSetAltSpeed_KBps   ( tr_session *, tr_direction, unsigned int Bps );
+unsigned int tr_sessionGetAltSpeed_KBps   ( const tr_session *, tr_direction );
 
 void     tr_sessionUseAltSpeed        ( tr_session *, bool );
 bool     tr_sessionUsesAltSpeed       ( const tr_session * );
@@ -759,7 +759,7 @@
 ****  Torrents can be moved in the queue using the simple functions
 ****  tr_torrentQueueMove{Top,Up,Down,Bottom}. They can be moved to
 ****  arbitrary points in the queue with tr_torrentSetQueuePosition().
-****  
+****
 ***/
 
 
@@ -1227,8 +1227,8 @@
 ****
 ***/
 
-void     tr_torrentSetSpeedLimit_KBps  ( tr_torrent *, tr_direction, int KBps );
-int      tr_torrentGetSpeedLimit_KBps  ( const tr_torrent *, tr_direction );
+void         tr_torrentSetSpeedLimit_KBps  ( tr_torrent *, tr_direction, unsigned int KBps );
+unsigned int tr_torrentGetSpeedLimit_KBps  ( const tr_torrent *, tr_direction );
 
 void     tr_torrentUseSpeedLimit      ( tr_torrent *, tr_direction, bool );
 bool     tr_torrentUsesSpeedLimit     ( const tr_torrent *, tr_direction );
@@ -1379,7 +1379,6 @@
     int      tier;
     char *   announce;
     char *   scrape;
-    char *   file_replication;
     uint32_t id; /* unique identifier used to match to a tr_tracker_stat */
 }
 tr_tracker_info;
diff -Naur ./utils.c ../../../tmp/Transmission/libtransmission/utils.c
--- ./utils.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/utils.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: utils.c 13080 2011-11-10 03:31:43Z jordan $
+ * $Id: utils.c 13362 2012-07-01 03:05:36Z jordan $
  */
 
 #ifdef HAVE_MEMMEM
@@ -231,6 +231,7 @@
         char              timestr[64];
         struct evbuffer * buf = evbuffer_new( );
         char *            base = tr_basename( file );
+        char *            message;
 
         evbuffer_add_printf( buf, "[%s] ",
                             tr_getLogTimeStr( timestr, sizeof( timestr ) ) );
@@ -241,12 +242,13 @@
         va_end( args );
         evbuffer_add_printf( buf, " (%s:%d)\n", base, line );
         /* FIXME(libevent2) ifdef this out for nonwindows platforms */
-        OutputDebugString( evbuffer_pullup( buf, -1 ) );
+        message = evbuffer_free_to_str( buf );
+        OutputDebugString( message );
         if( fp )
-            fputs( (const char*)evbuffer_pullup( buf, -1 ), fp );
+            fputs( message, fp );
 
+        tr_free( message );
         tr_free( base );
-        evbuffer_free( buf );
     }
 }
 
@@ -636,6 +638,24 @@
     return buf;
 }
 
+#ifdef SYS_DARWIN
+ #define TR_STAT_MTIME(sb) ((sb).st_mtimespec.tv_sec)
+#else
+ #define TR_STAT_MTIME(sb) ((sb).st_mtime)
+#endif
+
+bool
+tr_fileExists( const char * filename, time_t * mtime )
+{
+    struct stat sb;
+    const bool ok = !stat( filename, &sb );
+
+    if( ok && ( mtime != NULL ) )
+        *mtime = TR_STAT_MTIME( sb );
+
+    return ok;
+}
+
 /****
 *****
 ****/
@@ -978,11 +998,19 @@
 tr_urlIsValidTracker( const char * url )
 {
     bool valid;
-    const int len = url ? strlen(url) : 0;
 
-    valid = isValidURLChars( url, len )
-         && !tr_urlParse( url, len, NULL, NULL, NULL, NULL )
-         && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"udp://",6) );
+    if( url == NULL )
+    {
+        valid = false;
+    }
+    else
+    {
+        const int len = strlen( url );
+
+        valid = isValidURLChars( url, len )
+            && !tr_urlParse( url, len, NULL, NULL, NULL, NULL )
+            && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"udp://",6) );
+    }
 
     return valid;
 }
@@ -992,12 +1020,20 @@
 tr_urlIsValid( const char * url, int url_len )
 {
     bool valid;
-    if( ( url_len < 0 ) && ( url != NULL ) )
-        url_len = strlen( url );
 
-    valid = isValidURLChars( url, url_len )
-         && !tr_urlParse( url, url_len, NULL, NULL, NULL, NULL )
-         && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"ftp://",6) || !memcmp(url,"sftp://",7) );
+    if( url == NULL )
+    {
+        valid = false;
+    }
+    else
+    {
+        if( url_len < 0 )
+            url_len = strlen( url );
+
+        valid = isValidURLChars( url, url_len )
+            && !tr_urlParse( url, url_len, NULL, NULL, NULL, NULL )
+            && ( !memcmp(url,"http://",7) || !memcmp(url,"https://",8) || !memcmp(url,"ftp://",6) || !memcmp(url,"sftp://",7) );
+    }
 
     return valid;
 }
@@ -1618,12 +1654,12 @@
 #ifdef HAVE_HTONLL
     return htonll( x );
 #else
-    /* fallback code by bdonlan at 
-     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */ 
-    union { uint32_t lx[2]; uint64_t llx; } u; 
-    u.lx[0] = htonl(x >> 32); 
-    u.lx[1] = htonl(x & 0xFFFFFFFFULL); 
-    return u.llx; 
+    /* fallback code by bdonlan at
+     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */
+    union { uint32_t lx[2]; uint64_t llx; } u;
+    u.lx[0] = htonl(x >> 32);
+    u.lx[1] = htonl(x & 0xFFFFFFFFULL);
+    return u.llx;
 #endif
 }
 
@@ -1633,11 +1669,11 @@
 #ifdef HAVE_NTOHLL
     return ntohll( x );
 #else
-    /* fallback code by bdonlan at 
-     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */ 
-    union { uint32_t lx[2]; uint64_t llx; } u; 
-    u.llx = x; 
-    return ((uint64_t)ntohl(u.lx[0]) << 32) | (uint64_t)ntohl(u.lx[1]); 
+    /* fallback code by bdonlan at
+     * http://stackoverflow.com/questions/809902/64-bit-ntohl-in-c/875505#875505 */
+    union { uint32_t lx[2]; uint64_t llx; } u;
+    u.llx = x;
+    return ((uint64_t)ntohl(u.lx[0]) << 32) | (uint64_t)ntohl(u.lx[1]);
 #endif
 }
 
diff -Naur ./utils.h ../../../tmp/Transmission/libtransmission/utils.h
--- ./utils.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/utils.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: utils.h 13084 2011-11-12 00:16:04Z jordan $
+ * $Id: utils.h 13362 2012-07-01 03:05:36Z jordan $
  */
 
 #ifndef TR_UTILS_H
@@ -239,6 +239,9 @@
 char* tr_buildPath( const char * first_element, ... ) TR_GNUC_NULL_TERMINATED
                                                       TR_GNUC_MALLOC;
 
+bool tr_fileExists( const char * filename, time_t * mtime );
+
+
 struct event;
 
 /**
diff -Naur ./version.h ../../../tmp/Transmission/libtransmission/version.h
--- ./version.h	2011-11-15 09:28:04.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/version.h	1970-01-01 01:00:00.000000000 +0100
@@ -1,10 +0,0 @@
-#define PEERID_PREFIX             "-TR242Z-"
-#define USERAGENT_PREFIX          "2.42+"
-#define SVN_REVISION              "13094"
-#define SVN_REVISION_NUM          13094
-#define SHORT_VERSION_STRING      "2.42+"
-#define LONG_VERSION_STRING       "2.42+ (13094)"
-#define VERSION_STRING_INFOPLIST  2.42+
-#define MAJOR_VERSION             2
-#define MINOR_VERSION             42
-#define TR_NIGHTLY_RELEASE        1
diff -Naur ./web.c ../../../tmp/Transmission/libtransmission/web.c
--- ./web.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/web.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: web.c 12539 2011-07-10 15:24:51Z jordan $
+ * $Id: web.c 13245 2012-03-04 13:21:42Z jordan $
  */
 
 #include <string.h> /* strlen(), strstr() */
@@ -95,6 +95,8 @@
 struct tr_web
 {
     bool curl_verbose;
+    bool curl_ssl_verify;
+    const char * curl_ca_bundle;
     int close_mode;
     struct tr_web_task * tasks;
     tr_lock * taskLock;
@@ -171,8 +173,12 @@
     curl_easy_setopt( e, CURLOPT_SOCKOPTFUNCTION, sockoptfunction );
     curl_easy_setopt( e, CURLOPT_SOCKOPTDATA, task );
 #endif
-    curl_easy_setopt( e, CURLOPT_SSL_VERIFYHOST, 0L );
-    curl_easy_setopt( e, CURLOPT_SSL_VERIFYPEER, 0L );
+    if( web->curl_ssl_verify )
+        curl_easy_setopt( e, CURLOPT_CAINFO, web->curl_ca_bundle );
+    else {
+        curl_easy_setopt( e, CURLOPT_SSL_VERIFYHOST, 0L );
+        curl_easy_setopt( e, CURLOPT_SSL_VERIFYPEER, 0L );
+    }
     curl_easy_setopt( e, CURLOPT_TIMEOUT, task->timeout_secs );
     curl_easy_setopt( e, CURLOPT_URL, task->url );
     curl_easy_setopt( e, CURLOPT_USERAGENT, TR_NAME "/" SHORT_VERSION_STRING );
@@ -188,8 +194,11 @@
     if( task->cookies != NULL )
         curl_easy_setopt( e, CURLOPT_COOKIE, task->cookies );
 
-    if( task->range )
+    if( task->range != NULL ) {
         curl_easy_setopt( e, CURLOPT_RANGE, task->range );
+        /* don't bother asking the server to compress webseed fragments */
+        curl_easy_setopt( e, CURLOPT_ENCODING, "identity" );
+    }
 
     return e;
 }
@@ -318,6 +327,14 @@
     web->taskLock = tr_lockNew( );
     web->tasks = NULL;
     web->curl_verbose = getenv( "TR_CURL_VERBOSE" ) != NULL;
+    web->curl_ssl_verify = getenv( "TR_CURL_SSL_VERIFY" ) != NULL;
+    web->curl_ca_bundle = getenv( "CURL_CA_BUNDLE" );
+    if( web->curl_ssl_verify ) {
+        tr_ninf( "web", "will verify tracker certs using envvar CURL_CA_BUNDLE: %s",
+                  web->curl_ca_bundle == NULL ? "none" : web->curl_ca_bundle );
+        tr_ninf( "web", "NB: this only works if you built against libcurl with openssl or gnutls, NOT nss" );
+        tr_ninf( "web", "NB: invalid certs will show up as 'Could not connect to tracker' like many other errors" );
+    }
     web->cookie_filename = tr_buildPath( session->configDir, "cookies.txt", NULL );
 
     multi = curl_multi_init( );
diff -Naur ./webseed.c ../../../tmp/Transmission/libtransmission/webseed.c
--- ./webseed.c	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/webseed.c	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: webseed.c 12860 2011-09-12 21:46:15Z jordan $
+ * $Id: webseed.c 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #include <string.h> /* strlen() */
@@ -481,19 +481,20 @@
         char ** urls = t->webseed->file_urls;
 
         const tr_info * inf = tr_torrentInfo( tor );
-        const uint32_t remain = t->length - t->blocks_done * tor->blockSize
+        const uint64_t remain = t->length - t->blocks_done * tor->blockSize
                                 - evbuffer_get_length( t->content );
 
-        const uint64_t total_offset = inf->pieceSize * t->piece_index
-                                    + t->piece_offset + t->length - remain;
+        const uint64_t total_offset = tr_pieceOffset( tor, t->piece_index,
+                                                           t->piece_offset,
+                                                           t->length - remain );
         const tr_piece_index_t step_piece = total_offset / inf->pieceSize;
-        const uint32_t step_piece_offset
+        const uint64_t step_piece_offset
                                = total_offset - ( inf->pieceSize * step_piece );
 
         tr_file_index_t file_index;
-        uint64_t file_offset;
         const tr_file * file;
-        uint32_t this_pass;
+        uint64_t file_offset;
+        uint64_t this_pass;
 
         tr_ioFindFileLocation( tor, step_piece, step_piece_offset,
                                     &file_index, &file_offset );
@@ -511,7 +512,9 @@
 }
 
 bool
-tr_webseedGetSpeed_Bps( const tr_webseed * w, uint64_t now, int * setme_Bps )
+tr_webseedGetSpeed_Bps( const tr_webseed * w,
+                        uint64_t           now,
+                        unsigned int     * setme_Bps )
 {
     const bool is_active = webseed_has_tasks( w );
     *setme_Bps = is_active ? tr_bandwidthGetPieceSpeed_Bps( &w->bandwidth, now, TR_DOWN ) : 0;
@@ -521,7 +524,7 @@
 bool
 tr_webseedIsActive( const tr_webseed * w )
 {
-    int Bps = 0;
+    unsigned int Bps = 0;
     return tr_webseedGetSpeed_Bps( w, tr_time_msec(), &Bps ) && ( Bps > 0 );
 }
 
diff -Naur ./webseed.h ../../../tmp/Transmission/libtransmission/webseed.h
--- ./webseed.h	2011-11-15 09:27:22.000000000 +0100
+++ ../../../tmp/Transmission/libtransmission/webseed.h	2012-07-09 13:11:37.000000000 +0200
@@ -7,7 +7,7 @@
  * This exemption does not extend to derived works not owned by
  * the Transmission project.
  *
- * $Id: webseed.h 12204 2011-03-22 15:19:54Z jordan $
+ * $Id: webseed.h 13361 2012-07-01 02:17:35Z jordan $
  */
 
 #ifndef __TRANSMISSION__
@@ -31,7 +31,7 @@
 /** @return true if a request is being processed, or false if idle */
 bool        tr_webseedGetSpeed_Bps( const tr_webseed * w,
                                     uint64_t           now,
-                                    int              * setme_Bps );
+                                    unsigned int     * setme_Bps );
 
 /** @return true if a request is being processed, or false if idle */
 bool        tr_webseedIsActive( const tr_webseed * w );
